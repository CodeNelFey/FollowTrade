=== src/App.css ===
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


=== src/utils/discipline.js ===
export const SESSIONS = {
    ASIA: { start: 0, end: 8, name: "Asie" },
    LONDON: { start: 8, end: 16, name: "Londres" },
    NY: { start: 13, end: 22, name: "New York" }
};

const TOLERANCE = 0.2; // Tolérance stricte

const getContractSize = (pair) => {
    if (!pair) return 100000;
    const p = pair.toUpperCase();
    if (p.includes('XAU') || p.includes('GOLD')) return 100;
    if (p.includes('BTC') || p.includes('ETH') || p.includes('US30') || p.includes('NDX')) return 1;
    if (p.includes('JPY')) return 1000;
    return 100000;
};

// Vérification STRICTE : Doit être proche de la cible (pas juste en dessous)
export const checkRiskCompliance = (riskPct, targetRisk) => {
    if (!riskPct || !targetRisk) return false; // Faux si pas de données
    return Math.abs(riskPct - targetRisk) <= TOLERANCE;
};

export const checkRRCompliance = (rr, targetRR) => {
    if (!rr || !targetRR) return false;
    return Math.abs(rr - targetRR) <= TOLERANCE;
};

export const calculateDisciplineScore = (tradeData, account, currentBalance) => {
    let score = 0;
    const breakdown = { plan: 0, risk: 0, sl: 0, time: 0, doc: 0 };

    // Si pas de solde, impossible de juger le risque -> 0 points sur le risque pour éviter les faux positifs 100%
    if (!account || !currentBalance || currentBalance <= 0) {
        // On donne quand même des points pour le reste si c'est rempli
        // Mais on force Risk à 0.
    } else {
        const entry = parseFloat(tradeData.entry);
        const sl = parseFloat(tradeData.sl);
        const tp = parseFloat(tradeData.tp);
        const lot = parseFloat(tradeData.lot);
        const targetRiskPct = parseFloat(account.max_risk) || 2.0;
        const targetRR = parseFloat(account.default_rr) || 2.0;

        // 1. RISQUE (Strict)
        if (entry && sl && lot) {
            const contractSize = getContractSize(tradeData.pair);
            const riskAmount = Math.abs(entry - sl) * lot * contractSize;
            const calculatedRiskPct = (riskAmount / currentBalance) * 100;

            if (checkRiskCompliance(calculatedRiskPct, targetRiskPct)) {
                score += 25;
                breakdown.risk = 25;
            }
        }

        // 2. PLAN / RR (Strict)
        let planOk = false;
        if (entry && sl && tp) {
            const riskDist = Math.abs(entry - sl);
            const rewardDist = Math.abs(tp - entry);
            if (riskDist > 0) {
                const calculatedRR = rewardDist / riskDist;
                if (checkRRCompliance(calculatedRR, targetRR)) {
                    score += 35;
                    breakdown.plan = 35;
                    planOk = true;
                }
            }
        } else if (!tp && breakdown.risk > 0) {
            // Pas de TP mais risque OK = moitié des points plan
            score += 15;
            breakdown.plan = 15;
        }
    }

    // 3. SL
    if (parseFloat(tradeData.sl) > 0 && !tradeData.slMoved) {
        score += 20;
        breakdown.sl = 20;
    }

    // 4. TIMING
    let hour = 12;
    if (tradeData.time) hour = parseInt(tradeData.time.split(':')[0]);
    else if (tradeData.date) { const d = new Date(tradeData.date); if (!isNaN(d.getTime())) hour = d.getHours(); }

    let inSession = (hour >= SESSIONS.ASIA.start && hour < SESSIONS.ASIA.end) || (hour >= SESSIONS.LONDON.start && hour < SESSIONS.LONDON.end) || (hour >= SESSIONS.NY.start && hour < SESSIONS.NY.end);
    if (inSession) { score += 10; breakdown.time = 10; }

    // 5. DOC
    let docScore = 0;
    const hasTags = tradeData.tags && tradeData.tags.length > 0;
    if (hasTags) docScore += 5;
    if (tradeData.hasScreenshot) docScore += 5;
    score += docScore; breakdown.doc = docScore;

    return { total: score, details: breakdown };
};

export const getScoreColor = (score) => {
    if (score >= 90) return 'text-emerald-500 bg-emerald-100 dark:bg-emerald-900/30';
    if (score >= 70) return 'text-blue-500 bg-blue-100 dark:bg-blue-900/30';
    if (score >= 50) return 'text-orange-500 bg-orange-100 dark:bg-orange-900/30';
    return 'text-rose-500 bg-rose-100 dark:bg-rose-900/30';
};

=== src/index.css ===
@tailwind base;
@tailwind components;
@tailwind utilities;

/* --- UTILITAIRES --- */
@layer utilities {
    .animation-delay-2000 { animation-delay: 2s; }
    .animation-delay-4000 { animation-delay: 4s; }

    /* Utility pour cacher la scrollbar (cross-browser) */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
}

/* --- ANIMATIONS --- */
@keyframes blob {
    0% { transform: translate(0px, 0px) scale(1); }
    33% { transform: translate(30px, -50px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
    100% { transform: translate(0px, 0px) scale(1); }
}
.animate-blob { animation: blob 10s infinite; }

@keyframes grid-flow {
    0% { background-position: 0 0; }
    100% { background-position: 0 80px; }
}
.animate-grid-flow { animation: grid-flow 1s linear infinite; }

@keyframes twinkle {
    0%, 100% { opacity: 0.2; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.2); }
}
.animate-twinkle { animation: twinkle 3s ease-in-out infinite; }

@keyframes float-candle {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}
.animate-float-candle { animation: float-candle 6s ease-in-out infinite; }

/* --- CONFIGURATION IOS & COULEURS --- */
/* --- CONFIGURATION IOS & PLEIN ÉCRAN --- */
:root {
    --bg-global: #000000;
}

html {
    /* Force le fond à être celui de l'app */
    background-color: var(--bg-global);

    /* Force la hauteur à prendre TOUT l'écran, y compris sous la barre système */
    height: 100dvh;
    width: 100vw;

    /* Empêche le rebond élastique d'iOS */
    overscroll-behavior-y: none;
    -webkit-text-size-adjust: 100%;
}

body {
    margin: 0;
    padding: 0;
    /* Idem pour le body */
    min-height: 100dvh;
    width: 100%;
    background-color: var(--bg-global);
    overscroll-behavior-y: none;

    /* Lissage des polices */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

html, body {
    padding: 0;
    margin: 0;
}

#root {
    padding: 0;
    margin: 0;
}

#root {
    /* Le conteneur React doit aussi tout remplir */
    height: 100dvh;
    width: 100%;
    background-color: var(--bg-global);
    isolation: isolate;
}

=== src/components/UpgradeModal.jsx ===
import React from 'react';
import { X, Sparkles, CheckCircle2, User, Crown } from 'lucide-react';

const UpgradeModal = ({ isOpen, onClose }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/70 backdrop-blur-md animate-in fade-in duration-200">
            <div className="bg-white dark:bg-neutral-900 w-full max-w-4xl rounded-3xl shadow-2xl border border-white/10 overflow-hidden relative animate-in zoom-in-95 duration-200 flex flex-col md:flex-row">
                <button onClick={onClose} className="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-neutral-800 text-gray-500 z-20"><X size={20} /></button>
                <div className="md:w-1/3 bg-gradient-to-br from-indigo-900 to-black p-8 flex flex-col justify-between relative overflow-hidden">
                    <div className="relative z-10">
                        <div className="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center mb-6 border border-white/10"><Sparkles className="text-emerald-400" /></div>
                        <h2 className="text-3xl font-black text-white leading-tight mb-2">Débloquez <br/><span className="text-emerald-400">Tout.</span></h2>
                        <p className="text-indigo-200 text-sm">Passez au niveau supérieur.</p>
                    </div>
                    <div className="relative z-10 space-y-3 mt-8">
                        <div className="flex items-center gap-3 text-white/80 text-sm"><CheckCircle2 size={16} className="text-emerald-400"/> Analyses illimitées</div>
                        <div className="flex items-center gap-3 text-white/80 text-sm"><CheckCircle2 size={16} className="text-emerald-400"/> Calendrier interactif</div>
                    </div>
                </div>
                <div className="md:w-2/3 p-8 bg-gray-50 dark:bg-neutral-900/95">
                    <div className="grid grid-cols-1 gap-4 h-full">
                        <div className="p-4 rounded-2xl border border-gray-200 dark:border-neutral-700 bg-white dark:bg-neutral-800/50 flex justify-between items-center opacity-60 grayscale">
                            <div className="flex items-center gap-4"><div className="p-3 bg-gray-100 dark:bg-neutral-700 rounded-xl"><User size={20} /></div><div><div className="font-bold text-gray-900 dark:text-white">Version FREE</div><div className="text-xs text-gray-500">Standard</div></div></div>
                            <span className="text-[10px] font-bold px-2 py-1 bg-gray-200 dark:bg-neutral-700 rounded text-gray-500">ACTUEL</span>
                        </div>
                        <div className="p-4 rounded-2xl border border-dashed border-gray-300 dark:border-neutral-700 bg-gray-50 dark:bg-transparent flex justify-between items-center">
                            <div className="flex items-center gap-4"><div className="p-3 bg-amber-100 dark:bg-amber-900/20 text-amber-600 rounded-xl"><Crown size={20} /></div><div><div className="font-bold text-gray-900 dark:text-white">Version PRO</div><div className="text-xs text-gray-500">Bientôt</div></div></div>
                        </div>
                        <a href="https://t.me/sohanbirotheau" target="_blank" rel="noopener noreferrer" className="group relative overflow-hidden rounded-2xl border border-emerald-500/30 transition-all hover:shadow-lg hover:shadow-emerald-500/20">
                            <div className="absolute inset-0 bg-gradient-to-r from-emerald-500/10 to-teal-500/10 opacity-50 group-hover:opacity-100 transition-opacity"></div>
                            <div className="relative p-5 flex justify-between items-center">
                                <div className="flex items-center gap-4"><div className="p-3 bg-emerald-500 text-white rounded-xl shadow-lg shadow-emerald-500/30 group-hover:scale-110 transition-transform"><Sparkles size={24} /></div><div><div className="font-black text-lg text-gray-900 dark:text-white">Grade VIP</div><div className="text-xs text-emerald-600 dark:text-emerald-400 font-bold">Gratuit sur demande</div></div></div>
                                <div className="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md group-hover:bg-emerald-500 transition-colors">Contacter</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default UpgradeModal;

=== src/components/AccountFormModal.jsx ===
import React, { useState, useEffect, useRef } from 'react';
import { X, Save, Briefcase, DollarSign, ChevronDown, Check, Euro, PoundSterling, Target, AlertTriangle } from 'lucide-react';

const CURRENCIES = [
    { code: 'USD', name: 'US Dollar', icon: DollarSign },
    { code: 'EUR', name: 'Euro', icon: Euro },
    { code: 'GBP', name: 'British Pound', icon: PoundSterling },
];

const AccountFormModal = ({ isOpen, onClose, onSave, accountToEdit }) => {
    const [formData, setFormData] = useState({
        name: '', description: '', broker: '', platform: '',
        color: '#4f46e5', currency: 'USD',
        // Plus de initial_balance
        max_risk: '2',       // % par défaut
        default_rr: '2',     // RR par défaut
        commission_pct: 0, commission_min: 0, commission_max: 0
    });

    const [isCurrencyOpen, setIsCurrencyOpen] = useState(false);
    const currencyDropdownRef = useRef(null);

    useEffect(() => {
        if (accountToEdit) {
            setFormData({
                ...accountToEdit,
                max_risk: accountToEdit.max_risk || '2',
                default_rr: accountToEdit.default_rr || '2'
            });
        } else {
            setFormData({
                name: '', description: '', broker: '', platform: '',
                color: '#4f46e5', currency: 'USD',
                max_risk: '2', default_rr: '2',
                commission_pct: 0, commission_min: 0, commission_max: 0
            });
        }
    }, [accountToEdit, isOpen]);

    useEffect(() => {
        function handleClickOutside(event) {
            if (currencyDropdownRef.current && !currencyDropdownRef.current.contains(event.target)) {
                setIsCurrencyOpen(false);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    if (!isOpen) return null;

    const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
    };

    const currentCurrency = CURRENCIES.find(c => c.code === formData.currency) || CURRENCIES[0];
    const CurrencyIcon = currentCurrency.icon;

    const labelClass = "block text-[11px] font-bold text-gray-400 dark:text-neutral-500 uppercase tracking-wider mb-2 ml-1";
    const inputClass = "w-full bg-white dark:bg-neutral-950 border border-gray-100 dark:border-neutral-800 text-gray-900 dark:text-white px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all placeholder:text-gray-300 dark:placeholder:text-neutral-700 font-medium";

    return (
        <div className="fixed inset-0 z-[60] flex items-end md:items-center justify-center p-0 md:p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="w-full md:max-w-lg bg-white dark:bg-[#1a1a1a] rounded-t-3xl md:rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">

                <div className="flex justify-between items-center p-6 border-b border-gray-100 dark:border-neutral-800">
                    <h2 className="text-xl font-black text-gray-900 dark:text-white flex items-center gap-2">
                        {accountToEdit ? 'Modifier le Compte' : 'Nouveau Compte'}
                    </h2>
                    <button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-white/10 rounded-full transition-colors">
                        <X size={20} className="text-gray-500" />
                    </button>
                </div>

                <div className="overflow-y-auto p-6 space-y-6 scrollbar-hide">

                    {/* 1. Identité */}
                    <div className="space-y-4">
                        <div>
                            <label className={labelClass}>Nom du compte</label>
                            <input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className={inputClass} placeholder="Ex: Principal" autoFocus />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            {/* DEVISE */}
                            <div ref={currencyDropdownRef} className="relative">
                                <label className={labelClass}>Devise</label>
                                <button type="button" onClick={() => setIsCurrencyOpen(!isCurrencyOpen)} className={`${inputClass} flex items-center justify-between text-left`}>
                                    <div className="flex items-center gap-2"><div className="w-6 h-6 rounded-full bg-gray-100 dark:bg-neutral-800 flex items-center justify-center text-gray-600 dark:text-gray-300"><CurrencyIcon size={14} /></div><span>{currentCurrency.code}</span></div>
                                    <ChevronDown size={16} className={`text-gray-400 transition-transform ${isCurrencyOpen ? 'rotate-180' : ''}`} />
                                </button>
                                {isCurrencyOpen && (
                                    <div className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-neutral-900 border border-gray-100 dark:border-neutral-800 rounded-xl shadow-xl z-50 overflow-hidden animate-in zoom-in-95 duration-200">
                                        {CURRENCIES.map((curr) => {
                                            const Icon = curr.icon;
                                            return (
                                                <button key={curr.code} type="button" onClick={() => { setFormData(prev => ({ ...prev, currency: curr.code })); setIsCurrencyOpen(false); }} className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-neutral-800 transition-colors">
                                                    <div className="flex items-center gap-3"><div className="w-6 h-6 rounded-full bg-gray-100 dark:bg-neutral-800 flex items-center justify-center text-gray-600 dark:text-gray-300"><Icon size={12} /></div><span className="font-bold text-gray-700 dark:text-gray-300 text-sm">{curr.code}</span></div>
                                                    {formData.currency === curr.code && <Check size={16} className="text-indigo-600" />}
                                                </button>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>

                            {/* COULEUR */}
                            <div>
                                <label className={labelClass}>Couleur</label>
                                <div className="h-[48px] w-full relative rounded-xl overflow-hidden border border-gray-100 dark:border-neutral-800 cursor-pointer bg-white dark:bg-neutral-950 flex items-center px-2">
                                    <input type="color" value={formData.color} onChange={e => setFormData({...formData, color: e.target.value})} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                    <div className="flex items-center gap-3 w-full pl-2"><div className="w-6 h-6 rounded-full border border-black/10 shadow-sm flex-shrink-0" style={{ backgroundColor: formData.color }}></div><span className="text-xs font-mono text-gray-500 uppercase truncate">{formData.color}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* 2. STRATÉGIE (NOUVEAU) */}
                    <div className="space-y-4 pt-4 border-t border-gray-100 dark:border-neutral-800">
                        <h3 className="text-sm font-bold text-indigo-500 flex items-center gap-2"><Target size={16}/> Stratégie & Discipline</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className={labelClass}>Risque Max / Trade (%)</label>
                                <div className="relative">
                                    <input type="number" step="0.1" value={formData.max_risk} onChange={e => setFormData({...formData, max_risk: e.target.value})} className={inputClass + " pl-4"} placeholder="2" />
                                    <span className="absolute right-4 top-3.5 text-gray-400 font-bold text-xs">%</span>
                                </div>
                            </div>
                            <div>
                                <label className={labelClass}>RR Ciblé (ex: 2)</label>
                                <div className="relative">
                                    <input type="number" step="0.1" value={formData.default_rr} onChange={e => setFormData({...formData, default_rr: e.target.value})} className={inputClass + " pl-4"} placeholder="2" />
                                    <span className="absolute right-4 top-3.5 text-gray-400 font-bold text-xs">R</span>
                                </div>
                            </div>
                        </div>
                        <p className="text-[10px] text-gray-400 italic leading-snug">
                            Votre <strong>Score de Discipline</strong> sera calculé automatiquement : si la perte potentielle (SL) dépasse {formData.max_risk || 0}%, vous serez pénalisé.
                        </p>
                    </div>

                    {/* 3. Infos Broker */}
                    <div className="space-y-4 pt-4 border-t border-gray-100 dark:border-neutral-800">
                        <h3 className="text-sm font-bold text-indigo-500 flex items-center gap-2"><Briefcase size={16}/> Infos Broker</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className={labelClass}>Broker</label><input type="text" value={formData.broker} onChange={e => setFormData({...formData, broker: e.target.value})} className={inputClass} placeholder="Ex: Vantage" /></div>
                            <div><label className={labelClass}>Plateforme</label><input type="text" value={formData.platform} onChange={e => setFormData({...formData, platform: e.target.value})} className={inputClass} placeholder="Ex: MT4" /></div>
                        </div>
                        <div><label className={labelClass}>Description</label><textarea value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} className={inputClass + " min-h-[80px]"} placeholder="Notes..." /></div>
                    </div>

                    {/* 4. Règles de Commission */}
                    <div className="space-y-4 pt-4 border-t border-gray-100 dark:border-neutral-800">
                        <h3 className="text-sm font-bold text-indigo-500 flex items-center gap-2"><DollarSign size={16}/> Commissions (Optionnel)</h3>
                        <div className="grid grid-cols-3 gap-3">
                            <div><label className={labelClass}>% par lot</label><input type="number" step="0.01" value={formData.commission_pct} onChange={e => setFormData({...formData, commission_pct: parseFloat(e.target.value)})} className={inputClass} placeholder="0" /></div>
                            <div><label className={labelClass}>Min ($)</label><input type="number" step="0.01" value={formData.commission_min} onChange={e => setFormData({...formData, commission_min: parseFloat(e.target.value)})} className={inputClass} placeholder="Min" /></div>
                            <div><label className={labelClass}>Max ($)</label><input type="number" step="0.01" value={formData.commission_max} onChange={e => setFormData({...formData, commission_max: parseFloat(e.target.value)})} className={inputClass} placeholder="Max" /></div>
                        </div>
                    </div>

                </div>

                <div className="p-6 pt-2 pb-8 md:pb-6 bg-white dark:bg-[#1a1a1a]">
                    <button onClick={handleSubmit} className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-lg shadow-lg shadow-indigo-500/30 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <Save size={20} /> Enregistrer le compte
                    </button>
                </div>
            </div>
        </div>
    );
};

export default AccountFormModal;

=== src/components/TradingBackground.jsx ===
import React from 'react';

const TradingBackground = () => {
    return (
        <div className="fixed inset-0 w-full h-full overflow-hidden -z-10 bg-[#0f172a] dark:bg-black transition-colors duration-500">

            {/* 1. FOND DEGRADÉ */}
            <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-indigo-900/20 via-[#050505] to-black"></div>

            {/* 2. GRILLE INFINIE (ANIMÉE) */}
            {/* C'est ici que l'animation 'grid-flow' crée l'effet de mouvement */}
            <div
                className="absolute inset-0 opacity-[0.2] dark:opacity-[0.3] animate-grid-flow"
                style={{
                    backgroundImage: `linear-gradient(rgba(99, 102, 241, 0.5) 1px, transparent 1px),
                                      linear-gradient(90deg, rgba(99, 102, 241, 0.5) 1px, transparent 1px)`,
                    backgroundSize: '80px 80px', // Correspond à l'animation CSS
                    transform: 'perspective(500px) rotateX(60deg) scale(2.5)',
                    transformOrigin: 'bottom center',
                    maskImage: 'linear-gradient(to top, black 20%, transparent 90%)', // Fondu propre vers l'horizon
                    WebkitMaskImage: 'linear-gradient(to top, black 20%, transparent 90%)'
                }}
            ></div>

            {/* 3. BLOBS DE COULEUR (FLOTTANTS) */}
            <div className="absolute -top-[10%] -left-[10%] w-[50vw] h-[50vw] bg-indigo-600/30 rounded-full mix-blend-screen filter blur-[100px] animate-blob opacity-40"></div>
            <div className="absolute -bottom-[10%] -right-[10%] w-[50vw] h-[50vw] bg-purple-600/30 rounded-full mix-blend-screen filter blur-[100px] animate-blob animation-delay-4000 opacity-40"></div>
            <div className="absolute top-[20%] left-[30%] w-[40vw] h-[40vw] bg-cyan-600/20 rounded-full mix-blend-screen filter blur-[80px] animate-blob animation-delay-2000 opacity-30"></div>

            {/* 4. ÉTOILES (SCINTILLANTES) */}
            <div className="absolute top-10 left-10 w-1 h-1 bg-white rounded-full animate-twinkle"></div>
            <div className="absolute top-1/4 left-1/3 w-0.5 h-0.5 bg-white rounded-full animate-twinkle animation-delay-2000"></div>
            <div className="absolute bottom-1/3 right-1/4 w-1 h-1 bg-indigo-300 rounded-full animate-twinkle animation-delay-4000"></div>
            <div className="absolute top-1/2 left-20 w-1.5 h-1.5 bg-white rounded-full blur-[1px] animate-twinkle"></div>
            <div className="absolute top-20 right-20 w-1 h-1 bg-purple-300 rounded-full animate-twinkle animation-delay-2000"></div>

            {/* 5. ÉLÉMENTS GRAPHIQUES FLOTTANTS */}
            {/* Ligne de Chart */}
            <svg className="absolute top-1/3 left-0 w-full h-96 opacity-20 pointer-events-none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M0,200 Q300,300 600,100 T1200,200"
                    fill="none"
                    stroke="url(#gradientLine)"
                    strokeWidth="3"
                    className="animate-float-candle"
                />
                <defs>
                    <linearGradient id="gradientLine" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stopColor="transparent" />
                        <stop offset="50%" stopColor="#818cf8" /> {/* Indigo-400 */}
                        <stop offset="100%" stopColor="transparent" />
                    </linearGradient>
                </defs>
            </svg>

        </div>
    );
};

export default TradingBackground;

=== src/components/AdminPanel.jsx ===
import React, { useState, useEffect } from 'react';
import { api } from '../api';
import { Search, Trash2, Edit2, ShieldAlert, User, Crown, Sparkles, X, Plus, Mail, Send, Lock } from 'lucide-react';

const AdminPanel = () => {
    // URL de ton backend (à modifier si tu mets en ligne plus tard)
    const API_URL = 'http://localhost:3000';

    const [activeTab, setActiveTab] = useState('users');

    // USERS STATES
    const [users, setUsers] = useState([]);
    const [filteredUsers, setFilteredUsers] = useState([]);
    const [searchTerm, setSearchTerm] = useState('');
    const [editingUser, setEditingUser] = useState(null);
    const [formData, setFormData] = useState({});

    // UPDATES STATES
    const [updates, setUpdates] = useState([]);
    const [isUpdateModalOpen, setIsUpdateModalOpen] = useState(false);
    const [updateForm, setUpdateForm] = useState({ title: '', content: '', type: 'INFO', date: new Date().toISOString().split('T')[0] });
    const [editingUpdateId, setEditingUpdateId] = useState(null);

    // EMAILS STATE
    const [sendingEmail, setSendingEmail] = useState(null);

    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // Fonction pour corriger l'URL de l'image
    const getAvatarUrl = (url) => {
        if (!url) return null;
        if (url.startsWith('http') || url.startsWith('blob:')) return url;
        return `${API_URL}${url}`;
    };

    useEffect(() => {
        if (activeTab === 'users') loadUsers();
        if (activeTab === 'updates') loadUpdates();
    }, [activeTab]);

    useEffect(() => {
        if (!searchTerm) setFilteredUsers(users);
        else {
            const lower = searchTerm.toLowerCase();
            setFilteredUsers(users.filter(u => u.email.toLowerCase().includes(lower) || (u.first_name + ' ' + u.last_name).toLowerCase().includes(lower)));
        }
    }, [searchTerm, users]);

    const loadUsers = async () => {
        setLoading(true); setError(null);
        try {
            const data = await api.adminGetAllUsers();
            if (Array.isArray(data)) {
                setUsers(data);
                setFilteredUsers(data);
            }
        } catch (error) {
            console.error(error);
            setError("Erreur chargement users");
        } finally { setLoading(false); }
    };

    const loadUpdates = async () => {
        setLoading(true);
        try {
            const data = await api.getUpdates();
            if (Array.isArray(data)) setUpdates(data);
        } catch (e) { setError("Erreur chargement updates"); } finally { setLoading(false); }
    };

    const handleSaveUser = async (e) => {
        e.preventDefault();
        try {
            await api.adminUpdateUser(editingUser.id, formData);
            await loadUsers();
            setEditingUser(null);
        } catch (e) {
            console.error(e);
            alert("Erreur lors de la sauvegarde : " + (e.response?.data?.error || e.message));
        }
    };

    const handleDeleteUser = async (id) => {
        if (!window.confirm("Supprimer ce compte définitivement ?")) return;
        try {
            await api.adminDeleteUser(id);
            setUsers(users.filter(u => u.id !== id));
            setFilteredUsers(filteredUsers.filter(u => u.id !== id));
        } catch (e) { alert("Erreur lors de la suppression"); }
    };

    const handleEditUserClick = (user) => {
        setEditingUser(user);
        setFormData({ ...user });
    };

    const handleSaveUpdate = async (e) => {
        e.preventDefault();
        try {
            if (editingUpdateId) {
                await api.adminUpdateUpdate(editingUpdateId, updateForm);
                setUpdates(updates.map(u => u.id === editingUpdateId ? { ...updateForm, id: editingUpdateId } : u));
            } else {
                const res = await api.adminCreateUpdate(updateForm);
                setUpdates([res, ...updates]);
            }
            setIsUpdateModalOpen(false);
            setUpdateForm({ title: '', content: '', type: 'INFO', date: new Date().toISOString().split('T')[0] });
            setEditingUpdateId(null);
        } catch (e) { alert("Erreur sauvegarde update"); }
    };

    const handleDeleteUpdate = async (id) => {
        if (!window.confirm("Supprimer ce message ?")) return;
        try { await api.adminDeleteUpdate(id); setUpdates(updates.filter(u => u.id !== id)); } catch (e) { alert("Erreur"); }
    };

    const openUpdateModal = (update = null) => {
        if (update) { setUpdateForm(update); setEditingUpdateId(update.id); }
        else { setUpdateForm({ title: '', content: '', type: 'INFO', date: new Date().toISOString().split('T')[0] }); setEditingUpdateId(null); }
        setIsUpdateModalOpen(true);
    };

    // --- FONCTION DE TEST EMAIL ---
    const handleTestEmail = async (type) => {
        setSendingEmail(type);
        try {
            await api.adminTestEmail(type);
            alert(`Email ${type} envoyé avec succès ! Vérifie ta boîte mail.`);
        } catch (e) {
            alert("Erreur lors de l'envoi : " + (e.response?.data?.error || e.message));
        } finally {
            setSendingEmail(null);
        }
    };

    const renderBadge = (is_pro) => {
        if (is_pro === 7) return <div className="flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[10px] font-bold bg-gradient-to-r from-fuchsia-500 to-purple-600 text-white border border-purple-400/30 shadow-sm w-fit justify-center"><ShieldAlert size={12} fill="currentColor" /> ADMIN</div>;
        if (is_pro === 2) return <div className="flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[10px] font-bold bg-gradient-to-r from-emerald-400 to-teal-500 text-white border border-emerald-400/30 shadow-sm w-fit justify-center"><Sparkles size={12} fill="currentColor" /> VIP</div>;
        if (is_pro === 1) return <div className="flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[10px] font-bold bg-gradient-to-r from-amber-300 to-yellow-500 text-yellow-900 border border-yellow-400/30 shadow-sm w-fit justify-center"><Crown size={12} fill="currentColor" /> PRO</div>;
        return <div className="flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[10px] font-bold bg-gray-100 text-gray-500 border border-gray-200 dark:bg-white/10 dark:text-gray-300 dark:border-white/10 w-fit justify-center"><User size={12} /> FREE</div>;
    };

    const labelClass = "text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-1.5 block";
    const inputClass = "w-full bg-gray-50 dark:bg-black/40 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-medium text-sm";

    return (
        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 pb-20">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2"><ShieldAlert className="text-purple-500" /> Panel Administrateur</h2>
                <div className="flex gap-2 bg-gray-100 dark:bg-white/5 p-1 rounded-xl overflow-x-auto">
                    <button onClick={() => setActiveTab('users')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${activeTab === 'users' ? 'bg-white dark:bg-neutral-800 shadow text-indigo-600' : 'text-gray-500'}`}>Utilisateurs</button>
                    <button onClick={() => setActiveTab('updates')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${activeTab === 'updates' ? 'bg-white dark:bg-neutral-800 shadow text-indigo-600' : 'text-gray-500'}`}>Mises à jour</button>
                    <button onClick={() => setActiveTab('emails')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${activeTab === 'emails' ? 'bg-white dark:bg-neutral-800 shadow text-indigo-600' : 'text-gray-500'}`}>Emails & Tests</button>
                </div>
            </div>

            {activeTab === 'users' && (
                <>
                    <div className="relative mb-6">
                        <Search className="absolute left-3 top-3.5 text-gray-400" size={20} />
                        <input type="text" placeholder="Rechercher un utilisateur..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-white dark:bg-neutral-900/50 pl-10 pr-4 py-3 rounded-xl border border-gray-200 dark:border-neutral-700 focus:ring-2 focus:ring-purple-500 outline-none text-gray-900 dark:text-white transition-all backdrop-blur-sm" />
                    </div>

                    {/* VUE MOBILE : CARTES */}
                    <div className="md:hidden space-y-4">
                        {filteredUsers.map(u => (
                            <div key={u.id} className="bg-white/60 dark:bg-neutral-900/40 backdrop-blur-xl p-5 rounded-2xl border border-white/20 shadow-sm">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-12 h-12 rounded-full overflow-hidden bg-gray-200 dark:bg-neutral-700 flex-shrink-0">
                                        {u.avatar_url ? (
                                            <img src={getAvatarUrl(u.avatar_url)} className="w-full h-full object-cover" alt="Avatar" />
                                        ) : (
                                            <div className="w-full h-full flex items-center justify-center text-gray-400"><User size={20}/></div>
                                        )}
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-900 dark:text-white">{u.first_name} {u.last_name}</div>
                                        <div className="text-xs text-gray-500 dark:text-gray-400 font-mono">{u.email}</div>
                                    </div>
                                </div>
                                <div className="flex items-center justify-between border-t border-gray-100 dark:border-white/5 pt-4">
                                    {renderBadge(u.is_pro)}
                                    <div className="flex gap-2">
                                        <button onClick={() => handleEditUserClick(u)} className="px-3 py-2 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 rounded-lg text-sm font-bold flex items-center gap-2">
                                            <Edit2 size={14} /> Modifier
                                        </button>
                                        {u.is_pro !== 7 && (
                                            <button onClick={() => handleDeleteUser(u.id)} className="p-2 bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 rounded-lg">
                                                <Trash2 size={16} />
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* VUE BUREAU : TABLEAU */}
                    <div className="hidden md:block bg-white/60 dark:bg-neutral-900/40 backdrop-blur-xl rounded-3xl shadow-xl border border-white/40 dark:border-white/5 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-white/50 dark:bg-black/40 text-gray-500 dark:text-neutral-500 uppercase text-xs font-bold tracking-wider">
                                <tr><th className="px-6 py-4">Utilisateur</th><th className="px-6 py-4">Email</th><th className="px-6 py-4 text-center">Statut</th><th className="px-6 py-4 text-right">Actions</th></tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100 dark:divide-neutral-800">
                                {filteredUsers.map(u => (
                                    <tr key={u.id} className="hover:bg-white/40 dark:hover:bg-white/5 transition-colors">
                                        <td className="px-6 py-4 flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full overflow-hidden bg-gray-200 dark:bg-neutral-700 flex-shrink-0">
                                                {u.avatar_url ? (
                                                    <img src={getAvatarUrl(u.avatar_url)} className="w-full h-full object-cover" alt="Avatar" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-gray-400"><User size={14}/></div>
                                                )}
                                            </div>
                                            <span className="font-bold text-gray-900 dark:text-white">{u.first_name} {u.last_name}</span>
                                        </td>
                                        <td className="px-6 py-4 text-gray-500 dark:text-gray-400 font-mono text-xs">{u.email}</td>
                                        <td className="px-6 py-4 text-center"><div className="flex justify-center">{renderBadge(u.is_pro)}</div></td>
                                        <td className="px-6 py-4 text-right">
                                            <div className="flex items-center justify-end gap-2">
                                                <button onClick={() => handleEditUserClick(u)} className="p-2 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 text-indigo-500 rounded-lg"><Edit2 size={16} /></button>
                                                {u.is_pro !== 7 && <button onClick={() => handleDeleteUser(u.id)} className="p-2 hover:bg-rose-50 dark:hover:bg-rose-900/20 text-rose-500 rounded-lg"><Trash2 size={16} /></button>}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </>
            )}

            {activeTab === 'updates' && (
                <>
                    <div className="flex justify-end mb-6"><button onClick={() => openUpdateModal()} className="px-4 py-2 bg-indigo-600 text-white font-bold rounded-xl shadow-lg flex items-center gap-2 hover:bg-indigo-700"><Plus size={18}/> Nouveau Message</button></div>
                    <div className="space-y-4">
                        {updates.map(up => (
                            <div key={up.id} className="bg-white/60 dark:bg-neutral-900/40 backdrop-blur-xl p-6 rounded-2xl border border-white/20 shadow-sm flex justify-between items-start">
                                <div>
                                    <div className="flex items-center gap-3 mb-2"><span className={`px-2 py-0.5 rounded text-[10px] font-bold border uppercase ${up.type === 'ALERT' ? 'bg-red-100 text-red-600 border-red-200' : 'bg-blue-100 text-blue-600 border-blue-200'}`}>{up.type}</span><span className="text-xs text-gray-400 font-mono">{up.date}</span></div>
                                    <h3 className="font-bold text-gray-900 dark:text-white text-lg">{up.title}</h3>
                                    <p className="text-gray-600 dark:text-gray-400 text-sm mt-1 whitespace-pre-wrap">{up.content}</p>
                                </div>
                                <div className="flex gap-2"><button onClick={() => openUpdateModal(up)} className="p-2 text-gray-400 hover:text-indigo-500"><Edit2 size={16}/></button><button onClick={() => handleDeleteUpdate(up.id)} className="p-2 text-gray-400 hover:text-red-500"><Trash2 size={16}/></button></div>
                            </div>
                        ))}
                    </div>
                </>
            )}

            {/* --- VUE EMAILS --- */}
            {activeTab === 'emails' && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {/* Carte Bienvenue */}
                    <div className="bg-white/60 dark:bg-neutral-900/40 backdrop-blur-xl p-6 rounded-2xl border border-white/20 shadow-sm flex flex-col items-center text-center">
                        <div className="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center mb-4"><Sparkles size={24}/></div>
                        <h3 className="font-bold text-gray-900 dark:text-white text-lg">Bienvenue</h3>
                        <p className="text-sm text-gray-500 dark:text-gray-400 mt-2 mb-6">Envoyé lors de l'inscription d'un nouvel utilisateur.</p>
                        <button
                            onClick={() => handleTestEmail('WELCOME')}
                            disabled={!!sendingEmail}
                            className="w-full py-2.5 bg-white dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700 hover:border-indigo-500 dark:hover:border-indigo-500 text-gray-700 dark:text-gray-300 font-bold rounded-xl transition-all flex items-center justify-center gap-2 group"
                        >
                            {sendingEmail === 'WELCOME' ? <div className="animate-spin w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full"/> : <Send size={16} className="text-indigo-500 group-hover:translate-x-1 transition-transform"/>}
                            Envoyer un test
                        </button>
                    </div>

                    {/* Carte Reset Password */}
                    <div className="bg-white/60 dark:bg-neutral-900/40 backdrop-blur-xl p-6 rounded-2xl border border-white/20 shadow-sm flex flex-col items-center text-center">
                        <div className="w-12 h-12 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center mb-4"><Lock size={24}/></div>
                        <h3 className="font-bold text-gray-900 dark:text-white text-lg">Mot de passe oublié</h3>
                        <p className="text-sm text-gray-500 dark:text-gray-400 mt-2 mb-6">Contient le lien sécurisé pour réinitialiser le mot de passe.</p>
                        <button
                            onClick={() => handleTestEmail('RESET_PASSWORD')}
                            disabled={!!sendingEmail}
                            className="w-full py-2.5 bg-white dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700 hover:border-indigo-500 dark:hover:border-indigo-500 text-gray-700 dark:text-gray-300 font-bold rounded-xl transition-all flex items-center justify-center gap-2 group"
                        >
                            {sendingEmail === 'RESET_PASSWORD' ? <div className="animate-spin w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full"/> : <Send size={16} className="text-indigo-500 group-hover:translate-x-1 transition-transform"/>}
                            Envoyer un test
                        </button>
                    </div>

                    {/* Carte Alerte */}
                    <div className="bg-white/60 dark:bg-neutral-900/40 backdrop-blur-xl p-6 rounded-2xl border border-white/20 shadow-sm flex flex-col items-center text-center">
                        <div className="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center mb-4"><ShieldAlert size={24}/></div>
                        <h3 className="font-bold text-gray-900 dark:text-white text-lg">Alerte Sécurité</h3>
                        <p className="text-sm text-gray-500 dark:text-gray-400 mt-2 mb-6">Envoyé lors d'une connexion suspecte ou changement important.</p>
                        <button
                            onClick={() => handleTestEmail('ALERT')}
                            disabled={!!sendingEmail}
                            className="w-full py-2.5 bg-white dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700 hover:border-indigo-500 dark:hover:border-indigo-500 text-gray-700 dark:text-gray-300 font-bold rounded-xl transition-all flex items-center justify-center gap-2 group"
                        >
                            {sendingEmail === 'ALERT' ? <div className="animate-spin w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full"/> : <Send size={16} className="text-indigo-500 group-hover:translate-x-1 transition-transform"/>}
                            Envoyer un test
                        </button>
                    </div>
                </div>
            )}

            {/* --- MODALE MODIFICATION UTILISATEUR (Responsive) --- */}
            {editingUser && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in zoom-in-95">
                    <div className="bg-white dark:bg-neutral-900 w-full max-w-lg rounded-3xl shadow-2xl border border-white/10 flex flex-col max-h-[90vh]">
                        <div className="px-6 py-4 border-b border-gray-100 dark:border-neutral-800 flex justify-between items-center flex-none">
                            <h3 className="text-lg font-bold dark:text-white">Modifier Profil</h3>
                            <button onClick={() => setEditingUser(null)}><X size={20} className="text-gray-500"/></button>
                        </div>
                        <form onSubmit={handleSaveUser} className="p-6 overflow-y-auto">
                            <div className="flex flex-col items-center mb-8">
                                <div className="relative group">
                                    <div className="w-24 h-24 rounded-full overflow-hidden border-4 border-white dark:border-neutral-800 shadow-xl bg-gray-100 dark:bg-neutral-700 mb-3">
                                        {/* CORRECTION IMAGE ICI AUSSI */}
                                        {formData.avatar_url ? (
                                            <img src={getAvatarUrl(formData.avatar_url)} className="w-full h-full object-cover" alt="Avatar" />
                                        ) : (
                                            <div className="w-full h-full flex items-center justify-center text-gray-400"><User size={40} /></div>
                                        )}
                                    </div>
                                    {/* Pas de modification d'image ici pour simplifier, on supprime juste si besoin */}
                                </div>
                                <h4 className="text-xl font-black text-gray-900 dark:text-white">{formData.first_name} {formData.last_name}</h4>
                                <p className="text-sm text-gray-500">{formData.email}</p>
                            </div>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div><label className={labelClass}>Prénom</label><input type="text" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} className={inputClass} /></div>
                                <div><label className={labelClass}>Nom</label><input type="text" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} className={inputClass} /></div>
                            </div>
                            <div className="mb-6"><label className={labelClass}>Email</label><input type="email" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} className={inputClass} /></div>
                            <div className="mb-8"><label className={labelClass}>Grade</label>
                                <div className="grid grid-cols-2 gap-3">
                                    {[{ val: 0 }, { val: 1 }, { val: 2 }, { val: 7 }].map((role) => (
                                        <button key={role.val} type="button" onClick={() => setFormData({...formData, is_pro: role.val})} className={`flex items-center justify-center p-3 rounded-xl border ${formData.is_pro === role.val ? 'bg-white dark:bg-neutral-800 border-indigo-500 shadow-lg' : 'bg-gray-50 dark:bg-black/20 border-transparent opacity-60'}`}>{renderBadge(role.val)}</button>
                                    ))}
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 pt-4"><button type="button" onClick={() => setEditingUser(null)} className="px-4 py-2 rounded-xl text-gray-500 font-bold">Annuler</button><button type="submit" className="px-4 py-2 bg-indigo-600 text-white font-bold rounded-xl">Sauvegarder</button></div>
                        </form>
                    </div>
                </div>
            )}

            {/* --- MODALE UPDATES --- */}
            {isUpdateModalOpen && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in zoom-in-95">
                    <div className="bg-white dark:bg-neutral-900 w-full max-w-lg rounded-3xl shadow-2xl border border-white/10 flex flex-col max-h-[90vh]">
                        <div className="px-6 py-4 border-b border-gray-100 dark:border-neutral-800 flex justify-between items-center flex-none">
                            <h3 className="text-lg font-bold dark:text-white">Message</h3>
                            <button onClick={() => setIsUpdateModalOpen(false)}><X size={20} className="text-gray-500"/></button>
                        </div>
                        <form onSubmit={handleSaveUpdate} className="p-6 space-y-4 overflow-y-auto">
                            <div><label className={labelClass}>Titre</label><input type="text" value={updateForm.title} onChange={e => setUpdateForm({...updateForm, title: e.target.value})} className={inputClass} required /></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className={labelClass}>Type</label><select value={updateForm.type} onChange={e => setUpdateForm({...updateForm, type: e.target.value})} className={inputClass}><option value="INFO">Info</option><option value="FEATURE">Nouveauté</option><option value="FIX">Correctif</option><option value="ALERT">Alerte</option></select></div>
                                <div><label className={labelClass}>Date</label><input type="date" value={updateForm.date} onChange={e => setUpdateForm({...updateForm, date: e.target.value})} className={inputClass} required /></div>
                            </div>
                            <div><label className={labelClass}>Contenu</label><textarea rows="5" value={updateForm.content} onChange={e => setUpdateForm({...updateForm, content: e.target.value})} className={inputClass} required></textarea></div>
                            <div className="flex justify-end gap-2 pt-4"><button type="button" onClick={() => setIsUpdateModalOpen(false)} className="px-4 py-2 rounded-xl text-gray-500 font-bold">Annuler</button><button type="submit" className="px-4 py-2 bg-indigo-600 text-white font-bold rounded-xl">Publier</button></div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
};

export default AdminPanel;

=== src/components/AccountSelector.jsx ===
import React, { useState, useEffect, useRef } from 'react';
import { Plus, Edit2, Trash2, Briefcase, ChevronDown, Wallet, Check, Settings } from 'lucide-react';

const AccountSelector = ({ accounts, currentAccount, onSelect, onOpenCreate, onOpenEdit, onDelete, isDark }) => {
    const [isOpen, setIsOpen] = useState(false);
    const dropdownRef = useRef(null);
    const [hoveredAccountId, setHoveredAccountId] = useState(null);

    // Fermer le menu si on clique ailleurs
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setIsOpen(false);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    if (!currentAccount && accounts.length > 0) return null;

    return (
        <div className="mb-6">
            <div className="flex items-center justify-between mb-3 px-1">
                <h3 className="text-gray-400 font-bold text-xs uppercase tracking-wider flex items-center gap-2">
                    <Briefcase size={14}/> Mes Comptes
                </h3>
            </div>

            {/* --- VERSION MOBILE : DROPDOWN --- */}
            <div className="md:hidden relative z-30" ref={dropdownRef}>
                <button
                    onClick={() => setIsOpen(!isOpen)}
                    className={`w-full flex items-center justify-between p-4 rounded-2xl border transition-all duration-200 active:scale-[0.98] ${isOpen
                        ? 'bg-white dark:bg-neutral-900 border-indigo-500 ring-2 ring-indigo-500/20 shadow-lg'
                        : 'bg-white dark:bg-neutral-900 border-gray-200 dark:border-neutral-800 shadow-sm'}`}
                >
                    <div className="flex items-center gap-3 overflow-hidden">
                        <div className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shadow-md transform transition-transform" style={{ backgroundColor: currentAccount?.color || '#4f46e5' }}>
                            <Wallet size={18} />
                        </div>
                        <div className="flex flex-col items-start min-w-0">
                            <span className="text-[10px] uppercase text-gray-400 font-bold tracking-wider">Compte Actif</span>
                            <span className="font-black text-gray-900 dark:text-white truncate text-base">{currentAccount?.name}</span>
                        </div>
                    </div>
                    <ChevronDown size={20} className={`text-gray-400 transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} />
                </button>

                {isOpen && (
                    <div className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-[#1a1a1a] border border-gray-100 dark:border-neutral-800 rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200 origin-top">
                        <div className="max-h-[60vh] overflow-y-auto scrollbar-hide p-2 space-y-1">
                            {accounts.map(acc => (
                                <div key={acc.id} onClick={() => { onSelect(acc); setIsOpen(false); }} className={`flex items-center justify-between p-3 rounded-xl transition-all cursor-pointer ${currentAccount.id === acc.id ? 'bg-indigo-50 dark:bg-indigo-500/10 border border-indigo-100 dark:border-indigo-500/30' : 'hover:bg-gray-50 dark:hover:bg-neutral-800 border border-transparent'}`}>
                                    <div className="flex items-center gap-3 overflow-hidden">
                                        <div className="w-8 h-8 rounded-full border-2 border-white dark:border-neutral-900 shadow-sm flex-shrink-0" style={{ backgroundColor: acc.color }}></div>
                                        <div className="flex flex-col min-w-0">
                                            <span className={`font-bold text-sm truncate ${currentAccount.id === acc.id ? 'text-indigo-700 dark:text-indigo-400' : 'text-gray-700 dark:text-gray-300'}`}>{acc.name}</span>
                                            <span className="text-[10px] text-gray-400">{acc.broker || 'No Broker'} • {acc.currency}</span>
                                        </div>
                                    </div>
                                    {currentAccount.id === acc.id && <Check size={16} className="text-indigo-500" />}
                                </div>
                            ))}
                        </div>
                        <div className="p-2 border-t border-gray-100 dark:border-neutral-800 bg-gray-50/50 dark:bg-neutral-900/50 grid grid-cols-2 gap-2">
                            <button onClick={() => { onOpenEdit(currentAccount); setIsOpen(false); }} className="flex items-center justify-center gap-2 p-3 rounded-xl text-xs font-bold text-gray-600 dark:text-gray-400 hover:bg-white dark:hover:bg-neutral-800 border border-transparent hover:border-gray-200 dark:hover:border-neutral-700 transition-all"><Settings size={14} /> Configurer</button>
                            <button onClick={() => { onOpenCreate(); setIsOpen(false); }} className="flex items-center justify-center gap-2 p-3 rounded-xl text-xs font-bold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-500/10 border border-indigo-100 dark:border-indigo-500/30 hover:bg-indigo-100 dark:hover:bg-indigo-500/20 transition-all"><Plus size={14} /> Nouveau</button>
                        </div>
                    </div>
                )}
            </div>

            {/* --- VERSION DESKTOP : CARTES --- */}
            <div className="hidden md:flex gap-3 overflow-x-auto pb-4 scrollbar-hide snap-x">
                {accounts.map(acc => {
                    const isActive = currentAccount?.id === acc.id;
                    const isHovered = hoveredAccountId === acc.id;
                    const activeColor = acc.color || '#4f46e5';

                    // GESTION DES STYLES
                    const cardStyle = {};

                    if (isActive) {
                        // ACTIF : Dégradé, Texte Blanc, SANS BORDURE
                        cardStyle.background = `linear-gradient(135deg, ${activeColor}, ${isDark ? '#171717' : '#e5e7eb'})`;
                        cardStyle.color = 'white';
                        cardStyle.boxShadow = `0 10px 30px -10px ${activeColor}80`;
                        // La classe border-0 gère la suppression de la bordure
                    } else if (isHovered) {
                        // HOVER : Fond neutre, Bordure Colorée, Texte Coloré
                        cardStyle.borderColor = activeColor;
                        cardStyle.color = activeColor;
                        cardStyle.backgroundColor = isDark ? '#1a1a1a' : '#ffffff';
                    }

                    return (
                        <div
                            key={acc.id}
                            onClick={() => onSelect(acc)}
                            onMouseEnter={() => setHoveredAccountId(acc.id)}
                            onMouseLeave={() => setHoveredAccountId(null)}
                            className={`
                                min-w-[200px] p-4 rounded-2xl cursor-pointer transition-all duration-300 relative group snap-start
                                flex flex-col justify-between
                                ${isActive
                                ? 'border-0 translate-y-[-2px]'  // border-0 ici pour retirer les bords
                                : 'border bg-white dark:bg-neutral-900 border-gray-200 dark:border-neutral-800 text-gray-500'}
                            `}
                            style={cardStyle}
                        >
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <h4 className={`font-black text-sm truncate max-w-[120px] transition-colors ${!isActive && !isHovered ? 'text-gray-900 dark:text-white' : ''}`}>
                                        {acc.name}
                                    </h4>
                                    <span className={`text-[10px] uppercase tracking-wide transition-opacity ${isActive ? 'text-white/70' : 'opacity-70'}`}>
                                        {acc.broker || 'Broker N/A'}
                                    </span>
                                </div>
                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onClick={(e) => { e.stopPropagation(); onOpenEdit(acc); }} className={`p-1.5 rounded-lg transition-colors ${isActive ? 'bg-white/20 hover:bg-white/30 text-white' : 'hover:bg-black/5 dark:hover:bg-white/10'}`}><Edit2 size={12} /></button>
                                    <button onClick={(e) => { e.stopPropagation(); onDelete(acc.id); }} className={`p-1.5 rounded-lg transition-colors ${isActive ? 'bg-white/20 hover:bg-red-500 hover:text-white text-white' : 'hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500'}`}><Trash2 size={12} /></button>
                                </div>
                            </div>

                            <div className={`flex items-center justify-between mt-auto pt-2 border-t transition-colors ${isActive ? 'border-white/10' : 'border-gray-100 dark:border-neutral-800'}`}>
                                <div className="flex flex-col">
                                    <span className={`text-[10px] ${isActive ? 'text-white/60' : 'opacity-60'}`}>Plateforme</span>
                                    <span className="text-xs font-bold">{acc.platform || '-'}</span>
                                </div>
                                <div
                                    className={`px-2 py-1 rounded-md text-[10px] font-bold transition-colors ${isActive ? 'bg-white/20' : 'bg-gray-100 dark:bg-neutral-800'}`}
                                >
                                    {acc.currency}
                                </div>
                            </div>
                        </div>
                    );
                })}

                <button onClick={onOpenCreate} className="min-w-[60px] flex items-center justify-center rounded-2xl border border-dashed border-gray-300 dark:border-neutral-800 text-gray-400 hover:text-indigo-500 hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/10 transition-all snap-start"><Plus size={24} /></button>
            </div>
        </div>
    );
};

export default AccountSelector;

=== src/components/GraphView.jsx ===
import React, { useState, useMemo } from 'react';
import {
    AreaChart, Area, BarChart, Bar, Cell,
    XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine
} from 'recharts';
import { TrendingUp, Wallet, Percent, LineChart, BarChart3, CalendarDays } from 'lucide-react';

const GraphView = ({ trades, currencySymbol, colors }) => { // Ajout de colors
    const [chartType, setChartType] = useState('BALANCE'); // 'BALANCE', 'PROFIT', 'PERCENT'
    const [graphStyle, setGraphStyle] = useState('AREA'); // 'AREA' ou 'BAR'
    const [timeRange, setTimeRange] = useState('ALL'); // '1W', '1M', '3M', '1Y', 'ALL'

    // --- 1. PRÉPARATION DES DONNÉES GLOBALES ---
    const fullData = useMemo(() => {
        const sorted = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
        const daysMap = {};
        let runningBalance = 0;

        sorted.forEach(trade => {
            const date = trade.date;
            const profit = parseFloat(trade.profit) || 0;
            const isTransfer = trade.pair === 'SOLDE';

            if (!daysMap[date]) {
                daysMap[date] = {
                    date: date,
                    fullDate: new Date(date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }),
                    rawDate: new Date(date),
                    dailyProfit: 0,
                    dailyDeposits: 0,
                    startBalance: runningBalance
                };
            }

            if (isTransfer) {
                if (trade.type === 'DEPOSIT') daysMap[date].dailyDeposits += profit;
            } else {
                daysMap[date].dailyProfit += profit;
            }

            runningBalance += profit;
            daysMap[date].endBalance = runningBalance;
        });

        return Object.values(daysMap).map(day => {
            const effectiveCapital = day.startBalance + day.dailyDeposits;
            let dailyPercent = 0;
            if (effectiveCapital > 0) dailyPercent = (day.dailyProfit / effectiveCapital) * 100;
            else if (day.dailyDeposits > 0) dailyPercent = (day.dailyProfit / day.dailyDeposits) * 100;

            return {
                ...day,
                balance: day.endBalance,
                profit: day.dailyProfit,
                percent: dailyPercent
            };
        });
    }, [trades]);

    // --- 2. FILTRAGE TEMPOREL ---
    const filteredData = useMemo(() => {
        if (timeRange === 'ALL') return fullData;

        const now = new Date();
        const cutoff = new Date();

        if (timeRange === '1W') cutoff.setDate(now.getDate() - 7);
        if (timeRange === '1M') cutoff.setMonth(now.getMonth() - 1);
        if (timeRange === '3M') cutoff.setMonth(now.getMonth() - 3);
        if (timeRange === '1Y') cutoff.setFullYear(now.getFullYear() - 1);

        return fullData.filter(item => item.rawDate >= cutoff);
    }, [fullData, timeRange]);

    // --- 3. CONFIGURATION GRAPHIQUE ---
    const getChartConfig = () => {
        switch (chartType) {
            case 'PROFIT': return { dataKey: 'profit', label: `Gain Quotidien (${currencySymbol})`, color: colors.win };
            case 'PERCENT': return { dataKey: 'percent', label: 'Performance Quotidienne (%)', color: colors.win };
            case 'BALANCE': default: return { dataKey: 'balance', label: `Évolution Solde (${currencySymbol})`, color: colors.balance };
        }
    };

    const config = getChartConfig();
    const lastValue = filteredData.length > 0 ? filteredData[filteredData.length - 1][config.dataKey] : 0;

    // --- 4. CALCUL DU GRADIENT (Pour Win/Loss dynamique) ---
    const gradientOffset = () => {
        const dataMax = Math.max(...filteredData.map((i) => i[config.dataKey]));
        const dataMin = Math.min(...filteredData.map((i) => i[config.dataKey]));

        if (dataMax <= 0) return 0;
        if (dataMin >= 0) return 1;

        return dataMax / (dataMax - dataMin);
    };

    const off = gradientOffset();

    // --- COMPOSANTS UI ---
    const FilterButton = ({ type, label, icon: Icon }) => {
        const isActive = chartType === type;
        // On choisit la couleur active en fonction du type
        const activeColor = type === 'BALANCE' ? colors.balance : colors.win;

        return (
            <button
                onClick={() => setChartType(type)}
                className="flex-1 flex flex-col md:flex-row items-center justify-center gap-2 py-3 px-2 rounded-xl border transition-all"
                style={isActive ? {
                    backgroundColor: 'rgba(255,255,255, 0.1)', // Légère teinte background
                    borderColor: activeColor,
                    color: activeColor,
                    boxShadow: `0 4px 14px -4px ${activeColor}40` // Ombre colorée
                } : {
                    borderColor: 'transparent',
                    color: '#9ca3af' // gray-400
                }}
            >
                <Icon size={16} />
                <span className="text-[10px] md:text-xs font-bold uppercase">{label}</span>
            </button>
        );
    };

    const TimeButton = ({ value, label }) => (
        <button
            onClick={() => setTimeRange(value)}
            className={`px-3 py-1 text-xs font-bold rounded-lg transition-colors ${timeRange !== value ? 'text-gray-500 hover:bg-gray-200 dark:hover:bg-white/10' : 'text-white shadow-md'}`}
            style={timeRange === value ? { backgroundColor: colors.balance } : {}}
        >
            {label}
        </button>
    );

    const CustomTooltip = ({ active, payload }) => {
        if (active && payload && payload.length) {
            const val = payload[0].value;
            const isPositive = val >= 0;

            // Couleur dynamique pour le texte du tooltip
            let valueColor = colors.balance;
            if (chartType !== 'BALANCE') {
                valueColor = isPositive ? colors.win : colors.loss;
            }

            return (
                <div className="bg-white/90 dark:bg-neutral-900/90 backdrop-blur-md p-4 rounded-xl shadow-xl border border-white/20 dark:border-white/10">
                    <p className="text-xs font-bold text-gray-400 mb-1">{payload[0].payload.fullDate}</p>
                    <p className="text-lg font-black" style={{ color: valueColor }}>
                        {chartType !== 'BALANCE' && (isPositive ? '+' : '')}
                        {val.toFixed(2)}
                        {chartType === 'PERCENT' ? '%' : ` ${currencySymbol}`}
                    </p>
                </div>
            );
        }
        return null;
    };

    if (trades.length === 0) return <div className="text-center text-gray-400 py-20 italic">Aucune donnée pour générer un graphique.</div>;

    return (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 mb-24">

            {/* CONTROLS */}
            <div className="space-y-4">
                <div className="flex gap-3">
                    <div className="flex-1 bg-gray-100/50 dark:bg-neutral-900/50 p-1.5 rounded-2xl flex gap-1">
                        <FilterButton type="BALANCE" label="Solde" icon={Wallet} />
                        <FilterButton type="PROFIT" label="Gains" icon={TrendingUp} />
                        <FilterButton type="PERCENT" label="Perf %" icon={Percent} />
                    </div>
                    <button
                        onClick={() => setGraphStyle(prev => prev === 'AREA' ? 'BAR' : 'AREA')}
                        className="w-14 bg-gray-100/50 dark:bg-neutral-900/50 p-1.5 rounded-2xl flex items-center justify-center hover:bg-white dark:hover:bg-neutral-800 border border-transparent hover:border-indigo-500/30 transition-all shadow-sm"
                        style={{ color: colors.balance }}
                    >
                        {graphStyle === 'AREA' ? <BarChart3 size={20} /> : <LineChart size={20} />}
                    </button>
                </div>

                <div className="flex items-center justify-between bg-white/40 dark:bg-neutral-900/40 p-2 rounded-xl backdrop-blur-sm border border-white/20 dark:border-white/5 overflow-x-auto scrollbar-hide">
                    <div className="flex items-center gap-1 text-gray-400 mr-2 px-2 border-r border-gray-200 dark:border-neutral-700">
                        <CalendarDays size={16} />
                    </div>
                    <div className="flex gap-1">
                        <TimeButton value="1W" label="1S" />
                        <TimeButton value="1M" label="1M" />
                        <TimeButton value="3M" label="3M" />
                        <TimeButton value="1Y" label="1A" />
                        <TimeButton value="ALL" label="Tout" />
                    </div>
                </div>
            </div>

            {/* CHART */}
            <div className="bg-white/60 dark:bg-neutral-900/40 backdrop-blur-xl p-6 rounded-3xl shadow-xl border border-white/40 dark:border-white/5 h-[400px] md:h-[500px] flex flex-col">

                <div className="flex justify-between items-end mb-6">
                    <div>
                        <h3 className="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">
                            {chartType === 'BALANCE' ? 'Valeur Actuelle' : `Cumul Période ${config.label}`}
                        </h3>
                        <div className="text-4xl font-black tracking-tight" style={{ color: chartType === 'BALANCE' ? (isDark => isDark ? '#FFF' : '#111') /* Garder blanc/noir pour le titre principal */ : (lastValue >= 0 ? colors.win : colors.loss) }}>
                            {chartType !== 'BALANCE' && lastValue > 0 ? '+' : ''}{lastValue.toFixed(2)}
                            <span className="text-lg text-gray-400 ml-1">
                                {chartType === 'PERCENT' ? '%' : currencySymbol}
                            </span>
                        </div>
                    </div>
                    <div className="p-3 bg-gray-50 dark:bg-white/5 rounded-xl" style={{ color: colors.balance }}>
                        {graphStyle === 'AREA' ? <LineChart size={24} /> : <BarChart3 size={24} />}
                    </div>
                </div>

                <div className="flex-1 w-full min-h-0">
                    <ResponsiveContainer width="100%" height="100%">
                        {graphStyle === 'AREA' ? (
                            <AreaChart data={filteredData} margin={{ top: 10, right: 0, left: -20, bottom: 0 }}>
                                <defs>
                                    {/* Dégradé SOLDE Dynamique */}
                                    <linearGradient id="colorBalance" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor={colors.balance} stopOpacity={0.3}/>
                                        <stop offset="95%" stopColor={colors.balance} stopOpacity={0}/>
                                    </linearGradient>

                                    {/* Dégradé GAINS/PERCENT Dynamique (Split Win/Loss) */}
                                    <linearGradient id="splitColor" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset={off} stopColor={colors.win} stopOpacity={0.4} />
                                        <stop offset={off} stopColor={colors.loss} stopOpacity={0.4} />
                                    </linearGradient>
                                    <linearGradient id="splitStroke" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset={off} stopColor={colors.win} stopOpacity={1} />
                                        <stop offset={off} stopColor={colors.loss} stopOpacity={1} />
                                    </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="rgba(128,128,128,0.1)" />
                                <XAxis
                                    dataKey="fullDate"
                                    axisLine={false}
                                    tickLine={false}
                                    tick={{ fill: '#9ca3af', fontSize: 10 }}
                                    minTickGap={30}
                                />
                                <YAxis
                                    axisLine={false}
                                    tickLine={false}
                                    tick={{ fill: '#9ca3af', fontSize: 10 }}
                                    domain={['auto', 'auto']}
                                />
                                <Tooltip content={<CustomTooltip />} />
                                <ReferenceLine y={0} stroke="#9ca3af" strokeDasharray="3 3" />

                                {/* LOGIQUE D'AFFICHAGE COURBE */}
                                {chartType === 'BALANCE' ? (
                                    <Area
                                        type="monotone"
                                        dataKey={config.dataKey}
                                        stroke={colors.balance}
                                        strokeWidth={3}
                                        fillOpacity={1}
                                        fill="url(#colorBalance)"
                                        animationDuration={1000}
                                    />
                                ) : (
                                    <Area
                                        type="monotone"
                                        dataKey={config.dataKey}
                                        stroke="url(#splitStroke)"
                                        strokeWidth={3}
                                        fillOpacity={1}
                                        fill="url(#splitColor)"
                                        animationDuration={1000}
                                    />
                                )}
                            </AreaChart>
                        ) : (
                            <BarChart data={filteredData} margin={{ top: 10, right: 0, left: -20, bottom: 0 }}>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="rgba(128,128,128,0.1)" />
                                <XAxis
                                    dataKey="fullDate"
                                    axisLine={false}
                                    tickLine={false}
                                    tick={{ fill: '#9ca3af', fontSize: 10 }}
                                    minTickGap={30}
                                />
                                <YAxis
                                    axisLine={false}
                                    tickLine={false}
                                    tick={{ fill: '#9ca3af', fontSize: 10 }}
                                />
                                <Tooltip content={<CustomTooltip />} cursor={{fill: 'transparent'}} />
                                <ReferenceLine y={0} stroke="#9ca3af" strokeDasharray="3 3" />
                                <Bar dataKey={config.dataKey} radius={[4, 4, 0, 0]} animationDuration={1000}>
                                    {filteredData.map((entry, index) => (
                                        <Cell
                                            key={`cell-${index}`}
                                            // Balance = Couleur Balance. Autres = Win/Loss selon valeur
                                            fill={chartType === 'BALANCE' ? colors.balance : (entry[config.dataKey] >= 0 ? colors.win : colors.loss)}
                                        />
                                    ))}
                                </Bar>
                            </BarChart>
                        )}
                    </ResponsiveContainer>
                </div>
            </div>
        </div>
    );
};

export default GraphView;

=== src/components/UpdatesView.jsx ===
import React, { useState, useEffect } from 'react';
import { api } from '../api';
import { Megaphone, Calendar, Tag, AlertCircle, CheckCircle2, Zap, Info } from 'lucide-react';

const UpdatesView = () => {
    const [updates, setUpdates] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        loadUpdates();
    }, []);

    const loadUpdates = async () => {
        try {
            const data = await api.getUpdates();
            if (Array.isArray(data)) setUpdates(data);
        } catch (e) {
            console.error("Erreur updates", e);
        } finally {
            setLoading(false);
        }
    };

    const getTypeIcon = (type) => {
        switch(type) {
            case 'FEATURE': return <Zap size={18} className="text-purple-500" />;
            case 'FIX': return <CheckCircle2 size={18} className="text-emerald-500" />;
            case 'ALERT': return <AlertCircle size={18} className="text-rose-500" />;
            default: return <Info size={18} className="text-blue-500" />;
        }
    };

    const getTypeBadge = (type) => {
        switch(type) {
            case 'FEATURE': return 'bg-purple-100 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 border-purple-200 dark:border-purple-800';
            case 'FIX': return 'bg-emerald-100 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 border-emerald-200 dark:border-emerald-800';
            case 'ALERT': return 'bg-rose-100 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 border-rose-200 dark:border-rose-800';
            default: return 'bg-blue-100 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800';
        }
    };

    if (loading) return <div className="text-center py-20 text-gray-400 animate-pulse">Chargement des nouveautés...</div>;

    return (
        <div className="max-w-3xl mx-auto pb-20 animate-in fade-in slide-in-from-bottom-4">

            <div className="flex items-center gap-3 mb-8">
                <div className="p-3 bg-indigo-100 dark:bg-indigo-900/30 rounded-full text-indigo-600 dark:text-indigo-400">
                    <Megaphone size={24} />
                </div>
                <div>
                    <h2 className="text-2xl font-black text-gray-900 dark:text-white">Nouveautés</h2>
                    <p className="text-gray-500 dark:text-gray-400 text-sm">Suivez l'évolution de FollowTrade</p>
                </div>
            </div>

            <div className="space-y-6">
                {updates.length === 0 ? (
                    <div className="text-center py-12 bg-white/40 dark:bg-white/5 rounded-3xl border border-dashed border-gray-300 dark:border-white/10 text-gray-400">
                        Aucune mise à jour pour le moment.
                    </div>
                ) : (
                    updates.map((up) => (
                        <div key={up.id} className="bg-white/60 dark:bg-neutral-900/40 backdrop-blur-xl border border-white/40 dark:border-white/5 rounded-3xl p-6 shadow-sm relative overflow-hidden group hover:border-indigo-500/30 transition-all">

                            <div className="flex justify-between items-start mb-4">
                                <div className="flex items-center gap-3">
                                    <span className={`px-3 py-1 rounded-lg text-xs font-bold border flex items-center gap-2 ${getTypeBadge(up.type)}`}>
                                        {getTypeIcon(up.type)} {up.type}
                                    </span>
                                    <span className="text-xs text-gray-400 font-mono flex items-center gap-1">
                                        <Calendar size={12} /> {up.date}
                                    </span>
                                </div>
                            </div>

                            <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-2">{up.title}</h3>

                            <div className="text-gray-600 dark:text-gray-300 text-sm leading-relaxed whitespace-pre-wrap">
                                {up.content}
                            </div>

                        </div>
                    ))
                )}
            </div>
        </div>
    );
};

export default UpdatesView;

=== src/components/TodoListModal.jsx ===
import React, { useState, useEffect } from 'react';
import { X, Check, Sun, Moon, Zap, Briefcase, Target, Trophy, Clock, Calendar, BarChart2, Flag, Activity, Lock } from 'lucide-react';

export const ICON_MAP = {
    'sun': Sun, 'moon': Moon, 'zap': Zap, 'briefcase': Briefcase,
    'target': Target, 'trophy': Trophy, 'clock': Clock, 'calendar': Calendar,
    'bar-chart': BarChart2, 'flag': Flag, 'activity': Activity
};

const COLORS = [
    { id: 'indigo', bg: 'bg-indigo-500', text: 'text-indigo-500', border: 'border-indigo-500' },
    { id: 'emerald', bg: 'bg-emerald-500', text: 'text-emerald-500', border: 'border-emerald-500' },
    { id: 'rose', bg: 'bg-rose-500', text: 'text-rose-500', border: 'border-rose-500' },
    { id: 'amber', bg: 'bg-amber-500', text: 'text-amber-500', border: 'border-amber-500' },
    { id: 'cyan', bg: 'bg-cyan-500', text: 'text-cyan-500', border: 'border-cyan-500' },
    { id: 'purple', bg: 'bg-purple-500', text: 'text-purple-500', border: 'border-purple-500' },
];

const FREQUENCIES = [
    { id: 'DAILY', label: 'Quotidien (Reset chaque jour)' },
    { id: 'WEEKLY', label: 'Hebdomadaire (Reset Lundi)' },
    { id: 'MONTHLY', label: 'Mensuel (Reset le 1er)' },
    { id: 'YEARLY', label: 'Annuel (Reset 1er Janvier)' },
    { id: 'ONCE', label: 'Unique (Pas de Reset)' },
];

const TodoListModal = ({ isOpen, onClose, onSave, user, listToEdit }) => {
    const [title, setTitle] = useState('');
    const [selectedIcon, setSelectedIcon] = useState('zap');
    const [selectedColor, setSelectedColor] = useState('indigo');
    const [frequency, setFrequency] = useState('DAILY');

    const isFree = user?.is_pro === 0;

    useEffect(() => {
        if (isOpen) {
            if (listToEdit) {
                setTitle(listToEdit.title);
                setSelectedIcon(listToEdit.icon || 'zap');
                setSelectedColor(listToEdit.color || 'indigo');
                setFrequency(listToEdit.frequency || 'DAILY');
            } else {
                setTitle('');
                setSelectedIcon('zap');
                setSelectedColor('indigo');
                setFrequency('DAILY');
            }
        }
    }, [isOpen, listToEdit]);

    if (!isOpen) return null;

    const handleSubmit = (e) => {
        e.preventDefault();
        if (!title.trim()) return;
        onSave({ title, icon: selectedIcon, color: selectedColor, frequency });
        onClose();
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
            <div className="bg-white dark:bg-neutral-900 w-full max-w-md rounded-3xl shadow-2xl border border-white/20 dark:border-white/10 overflow-hidden">
                <div className="p-6 border-b border-gray-100 dark:border-neutral-800 flex justify-between items-center">
                    <h3 className="text-xl font-bold text-gray-900 dark:text-white">
                        {listToEdit ? 'Modifier la liste' : 'Nouvelle Liste'}
                    </h3>
                    <button onClick={onClose}><X className="text-gray-500" /></button>
                </div>

                <form onSubmit={handleSubmit} className="p-6 space-y-6">
                    {/* Titre */}
                    <div>
                        <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Titre de la liste</label>
                        <input
                            type="text"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            placeholder="Ex: Routine Matinale"
                            className="w-full bg-gray-50 dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white"
                            autoFocus
                        />
                    </div>

                    {/* Fréquence */}
                    <div>
                        <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Fréquence (Reset Auto)</label>
                        <div className="grid grid-cols-1 gap-2">
                            {FREQUENCIES.map(freq => (
                                <button
                                    key={freq.id}
                                    type="button"
                                    onClick={() => setFrequency(freq.id)}
                                    className={`px-4 py-2 rounded-xl text-xs font-bold text-left transition-all ${frequency === freq.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-100 dark:bg-neutral-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-neutral-700'}`}
                                >
                                    {freq.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* --- ZONE PERSONNALISATION (VERROUILLÉE POUR FREE) --- */}
                    <div className="relative p-4 -mx-4 rounded-2xl">
                        {isFree && (
                            <div className="absolute inset-0 z-10 flex items-center justify-center bg-white/50 dark:bg-black/50 backdrop-blur-sm rounded-2xl select-none">
                                <div className="bg-white dark:bg-neutral-800 px-4 py-2 rounded-full shadow-xl border border-amber-200 dark:border-neutral-700 flex items-center gap-2 animate-in zoom-in-95">
                                    <Lock size={14} className="text-amber-500" />
                                    <span className="text-[10px] font-bold text-gray-900 dark:text-white uppercase tracking-wide">Personnalisation PRO</span>
                                </div>
                            </div>
                        )}

                        <div className={`space-y-6 ${isFree ? 'opacity-40 pointer-events-none grayscale' : ''}`}>
                            {/* Couleurs */}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Couleur du thème</label>
                                <div className="flex gap-3">
                                    {COLORS.map(col => (
                                        <button
                                            key={col.id}
                                            type="button"
                                            onClick={() => setSelectedColor(col.id)}
                                            className={`w-8 h-8 rounded-full ${col.bg} transition-transform hover:scale-110 flex items-center justify-center ring-2 ${selectedColor === col.id ? 'ring-offset-2 ring-gray-400 dark:ring-offset-black' : 'ring-transparent'}`}
                                        >
                                            {selectedColor === col.id && <Check size={14} className="text-white" />}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Icônes */}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Icône</label>
                                <div className="grid grid-cols-6 gap-2">
                                    {Object.entries(ICON_MAP).map(([key, Icon]) => (
                                        <button
                                            key={key}
                                            type="button"
                                            onClick={() => setSelectedIcon(key)}
                                            className={`p-2 rounded-lg flex items-center justify-center transition-colors ${selectedIcon === key ? 'bg-gray-200 dark:bg-neutral-700 text-indigo-500' : 'text-gray-400 hover:bg-gray-100 dark:hover:bg-neutral-800'}`}
                                        >
                                            <Icon size={20} />
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95">
                        {listToEdit ? 'Enregistrer les modifications' : 'Créer la liste'}
                    </button>
                </form>
            </div>
        </div>
    );
};

export default TodoListModal;

=== src/components/MobileMenu.jsx ===
import React from 'react';
import { LayoutDashboard, Megaphone, LineChart, Calendar as CalendarIcon, Calculator, Crown, ClipboardList, TrendingUp } from 'lucide-react';

const MobileMenu = ({ activeTab, onNavClick, user, hasNewUpdates, colors }) => {

    const navItems = [
        { id: 'journal', icon: LayoutDashboard, label: 'Journal' },
        { id: 'routine', icon: ClipboardList, label: 'Routine' },
        { id: 'graphs', icon: LineChart, label: 'Analyses', isPro: true },
        // MODIFICATION ICI : isPro: true ajouté pour verrouiller le simulateur
        { id: 'simulator', icon: TrendingUp, label: 'Simu', isPro: true },
        { id: 'calendar', icon: CalendarIcon, label: 'Agenda', isPro: true },
        { id: 'calculator', icon: Calculator, label: 'Calc' },
        { id: 'updates', icon: Megaphone, label: 'News', hasNotif: true },
    ];

    // Couleur active par défaut
    const activeColor = colors?.balance || '#4f46e5';

    return (
        /* STYLE "FUSION" :
           - fixed bottom-0 : Collé au bas de l'écran.
           - w-full : Pleine largeur.
           - bg-white dark:bg-black : Fond Noir pur en mode sombre pour fusionner avec la barre iPhone.
           - border-t : Petite séparation subtile en haut.
           - pb-[env(safe-area-inset-bottom)] : Étend le fond noir sous la barre de swipe.
        */
        <div className="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-white dark:bg-black border-t border-gray-200 dark:border-neutral-900 pb-[env(safe-area-inset-bottom)] transition-colors duration-300">

            {/* overflow-x-auto permet de scroller horizontalement si l'écran est trop petit pour toutes les icônes */}
            <div className="flex justify-between items-center px-1 py-3 overflow-x-auto scrollbar-hide">
                {navItems.map((item) => {
                    const Icon = item.icon;
                    const isActive = activeTab === item.id;
                    const isLocked = item.isPro && user?.is_pro === 0;

                    return (
                        <button
                            key={item.id}
                            onClick={() => onNavClick(item.id)}
                            className="relative group flex-1 flex flex-col items-center justify-center transition-all duration-200 active:scale-95 py-1 min-w-[50px]"
                        >
                            {/* Indicateur Actif (Lueur au-dessus) */}
                            {isActive && (
                                <div
                                    className="absolute -top-[13px] w-8 h-1 rounded-b-full shadow-[0_0_10px_rgba(79,70,229,0.5)] transition-all duration-300"
                                    style={{ backgroundColor: activeColor, boxShadow: `0 0 12px ${activeColor}` }}
                                />
                            )}

                            {/* Icône */}
                            <div className={`relative p-1 rounded-xl transition-all duration-300 ${isActive ? '-translate-y-1' : ''}`}>
                                <Icon
                                    size={22}
                                    className={`transition-colors duration-300 ${
                                        isActive
                                            ? 'text-gray-900 dark:text-white'
                                            : 'text-gray-400 dark:text-neutral-600 group-hover:text-gray-600 dark:group-hover:text-gray-400'
                                    }`}
                                    style={isActive ? { color: activeColor } : {}}
                                />

                                {/* Badge PRO */}
                                {isLocked && (
                                    <div className="absolute -top-1 -right-1 bg-black/10 dark:bg-white/10 rounded-full p-0.5 backdrop-blur-sm">
                                        <Crown size={8} className="text-amber-500 fill-amber-500" />
                                    </div>
                                )}

                                {/* Badge Notification */}
                                {item.hasNotif && hasNewUpdates && (
                                    <span className="absolute -top-0.5 -right-0.5 flex h-2.5 w-2.5">
                                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                        <span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500 border-2 border-white dark:border-black"></span>
                                    </span>
                                )}
                            </div>

                            {/* Label */}
                            <span
                                className={`text-[9px] font-bold mt-0.5 transition-all duration-300 ${isActive ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2 hidden'}`}
                                style={{ color: activeColor }}
                            >
                                {item.label}
                            </span>
                        </button>
                    );
                })}
            </div>
        </div>
    );
};

export default MobileMenu;

=== src/components/SimulatorView.jsx ===
import React, { useState, useEffect, useRef } from 'react';
import { RefreshCcw, Target, Calendar, BarChart3, ChevronDown, Wallet, Check, AlertCircle, Clock } from 'lucide-react';
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

const SimulatorView = ({ currencySymbol, accounts = [], trades = [] }) => {
    const [mode, setMode] = useState('MANUAL');

    const [isDropdownOpen, setIsDropdownOpen] = useState(false);
    const [selectedAccountObj, setSelectedAccountObj] = useState(null);
    const [computedBalances, setComputedBalances] = useState({});
    const dropdownRef = useRef(null);

    // --- MODES DE DURÉE ---
    const [duration, setDuration] = useState('ROLLING_YEAR');

    // Inputs Simulation
    const [balance, setBalance] = useState(10000);
    const [winRate, setWinRate] = useState(50);
    const [riskPercent, setRiskPercent] = useState(1);
    const [riskReward, setRiskReward] = useState(2);
    const [tradesPerWeek, setTradesPerWeek] = useState(5);

    const [chartData, setChartData] = useState([]);
    const [stats, setStats] = useState({ finalBalance: 0, profit: 0, maxDD: 0 });

    // Calcul des soldes réels
    useEffect(() => {
        const balances = {};
        accounts.forEach(acc => {
            const accountMovements = trades.filter(t => Number(t.account_id) === Number(acc.id));
            const total = accountMovements.reduce((sum, t) => sum + (parseFloat(t.profit) || 0), 0);
            balances[acc.id] = total;
        });
        setComputedBalances(balances);
    }, [accounts, trades]);

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setIsDropdownOpen(false);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    // --- 1. CHARGEMENT STATS COMPTE ---
    const loadAccountStats = (account) => {
        if (!account) return;

        const realBalance = computedBalances[account.id] || 0;
        setBalance(realBalance);

        const activeTrades = trades.filter(t =>
            Number(t.account_id) === Number(account.id) &&
            t.pair !== 'SOLDE' &&
            t.type !== 'DEPOSIT' &&
            t.type !== 'WITHDRAWAL'
        ).sort((a,b) => new Date(a.date) - new Date(b.date));

        if (activeTrades.length === 0) return;

        const wins = activeTrades.filter(t => parseFloat(t.profit) >= 0).length;
        const realWinRate = (wins / activeTrades.length) * 100;

        const winsTrades = activeTrades.filter(t => parseFloat(t.profit) > 0);
        const avgWin = winsTrades.length > 0 ? winsTrades.reduce((acc, t) => acc + parseFloat(t.profit), 0) / winsTrades.length : 0;
        const lossesTrades = activeTrades.filter(t => parseFloat(t.profit) < 0);
        const avgLoss = lossesTrades.length > 0 ? Math.abs(lossesTrades.reduce((acc, t) => acc + parseFloat(t.profit), 0) / lossesTrades.length) : 0;
        const realRR = avgLoss > 0 ? (avgWin / avgLoss) : 1.5;

        const firstDate = new Date(activeTrades[0].date);
        const lastDate = new Date(activeTrades[activeTrades.length - 1].date);
        const weeksDiff = Math.max(1, (lastDate - firstDate) / (1000 * 60 * 60 * 24 * 7));
        const realFreq = Math.round(activeTrades.length / weeksDiff) || 5;

        setWinRate(Math.round(realWinRate) || 50);
        setRiskReward(parseFloat(realRR.toFixed(2)) || 2);
        setTradesPerWeek(realFreq);
    };

    const handleSelectAccount = (acc) => {
        setSelectedAccountObj(acc);
        setIsDropdownOpen(false);
        loadAccountStats(acc);
    };

    // --- CALCULATEUR DE DURÉE ---
    const getWeeksForDuration = (type) => {
        switch (type) {
            case 'WEEK': return 1;
            case 'MONTH': return 4.3;
            case 'ROLLING_YEAR': return 52;
            case 'CALENDAR_YEAR':
                const now = new Date();
                const endOfYear = new Date(now.getFullYear(), 11, 31);
                const diffTime = Math.abs(endOfYear - now);
                const diffWeeks = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 7));
                return Math.max(1, diffWeeks);
            default: return 52;
        }
    };

    const formatDate = (date) => {
        return new Intl.DateTimeFormat('fr-FR', { day: 'numeric', month: 'short' }).format(date);
    };

    // --- 2. MOTEUR DE SIMULATION ---
    const runSimulation = () => {
        const weeksToSimulate = getWeeksForDuration(duration);
        const numTradesToSimulate = Math.round(weeksToSimulate * tradesPerWeek);

        let startBalance = parseFloat(balance) || 0;
        let maxBalance = startBalance;
        let maxDrawdown = 0;
        let data = [];
        let tradeIndex = 0;
        const today = new Date();

        const getTradeDate = (index) => {
            const daysToAdd = (index / tradesPerWeek) * 7;
            const futureDate = new Date(today);
            futureDate.setDate(today.getDate() + daysToAdd);
            return formatDate(futureDate);
        };

        // --- HISTORIQUE ---
        if (mode === 'ACCOUNT' && selectedAccountObj) {
            const allMovements = trades.filter(t =>
                Number(t.account_id) === Number(selectedAccountObj.id)
            ).sort((a,b) => new Date(a.date) - new Date(b.date));

            if (allMovements.length > 0) {
                let runningBalance = 0;
                data.push({ trade: 0, dateLabel: 'Début', historical: 0, projected: null });

                allMovements.forEach((t) => {
                    tradeIndex++;
                    runningBalance += parseFloat(t.profit);
                    const dateObj = new Date(t.date);
                    const label = isNaN(dateObj) ? `T${tradeIndex}` : formatDate(dateObj);

                    data.push({
                        trade: tradeIndex,
                        dateLabel: label,
                        historical: parseFloat(runningBalance.toFixed(2)),
                        projected: null
                    });
                });

                data[data.length - 1].projected = parseFloat(runningBalance.toFixed(2));
                startBalance = runningBalance;
            } else {
                data.push({ trade: 0, dateLabel: 'Auj.', historical: startBalance, projected: startBalance });
            }
        } else {
            data.push({ trade: 0, dateLabel: 'Auj.', historical: null, projected: startBalance });
        }

        // --- FUTUR ---
        let simBalance = startBalance;
        const initialSimBalance = simBalance;

        for (let i = 1; i <= numTradesToSimulate; i++) {
            const riskAmount = simBalance * (riskPercent / 100);

            // Logique déterministe
            const currentAccumulatedWin = i * winRate;
            const previousAccumulatedWin = (i - 1) * winRate;
            const isWin = Math.floor(currentAccumulatedWin / 100) > Math.floor(previousAccumulatedWin / 100);

            const pnl = isWin ? (riskAmount * riskReward) : -riskAmount;
            simBalance += pnl;

            if (simBalance > maxBalance) maxBalance = simBalance;
            const dd = ((maxBalance - simBalance) / maxBalance) * 100;
            if (dd > maxDrawdown) maxDrawdown = dd;

            data.push({
                trade: tradeIndex + i,
                dateLabel: getTradeDate(i),
                historical: null,
                projected: Math.round(simBalance)
            });
        }

        setChartData(data);
        setStats({
            finalBalance: Math.round(simBalance),
            profit: Math.round(simBalance - initialSimBalance),
            maxDD: maxDrawdown.toFixed(2),
        });
    };

    useEffect(() => { runSimulation(); }, [mode, duration, selectedAccountObj, balance]);

    return (
        <div className="max-w-6xl mx-auto pb-20 animate-in fade-in slide-in-from-bottom-4 duration-500">

            <div className="flex justify-center mb-8">
                <div className="bg-white dark:bg-neutral-900 p-1 rounded-xl border border-gray-200 dark:border-neutral-800 inline-flex shadow-sm">
                    <button onClick={() => setMode('MANUAL')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${mode === 'MANUAL' ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white'}`}>Simulation Libre</button>
                    <button onClick={() => setMode('ACCOUNT')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${mode === 'ACCOUNT' ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white'}`}>Basé sur Compte Réel</button>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

                {/* --- CONFIGURATION --- */}
                <div className="bg-white/60 dark:bg-neutral-900/60 backdrop-blur-xl rounded-3xl p-6 border border-white/20 dark:border-white/5 shadow-sm h-fit z-20">
                    <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2"><Target className="text-indigo-500" /> Paramètres</h2>

                    <div className="space-y-5">

                        {mode === 'ACCOUNT' && (
                            <div className="relative" ref={dropdownRef}>
                                {/* CORRECTION LABEL : dark:text-gray-400 */}
                                <label className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2 block">Compte à projeter</label>
                                <button onClick={() => setIsDropdownOpen(!isDropdownOpen)} className="w-full bg-white dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700 rounded-xl px-4 py-3 flex items-center justify-between transition-colors hover:border-indigo-500 group">
                                    {selectedAccountObj ? (
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400"><Wallet size={16} /></div>
                                            <div className="text-left">
                                                <div className="text-sm font-bold text-gray-900 dark:text-white">{selectedAccountObj.name}</div>
                                                <div className="text-xs text-gray-500 dark:text-gray-400 font-mono">{(computedBalances[selectedAccountObj.id] || 0).toLocaleString()} {currencySymbol}</div>
                                            </div>
                                        </div>
                                    ) : (<span className="text-gray-400 text-sm font-medium">Sélectionner un compte...</span>)}
                                    <ChevronDown size={18} className={`text-gray-400 transition-transform ${isDropdownOpen ? 'rotate-180' : ''}`} />
                                </button>
                                {isDropdownOpen && (
                                    <div className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-[#1a1a1a] border border-gray-100 dark:border-neutral-800 rounded-xl shadow-xl overflow-hidden z-50 animate-in fade-in zoom-in-95 duration-100">
                                        {accounts.length > 0 ? (
                                            <div className="max-h-60 overflow-y-auto">
                                                {accounts.map(acc => (
                                                    <div key={acc.id} onClick={() => handleSelectAccount(acc)} className={`p-3 flex items-center justify-between cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 transition-colors ${selectedAccountObj?.id === acc.id ? 'bg-indigo-50 dark:bg-indigo-900/20' : ''}`}>
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center ${selectedAccountObj?.id === acc.id ? 'bg-indigo-500 text-white' : 'bg-gray-100 dark:bg-neutral-800 text-gray-400'}`}><Wallet size={14} /></div>
                                                            <div>
                                                                <div className="text-sm font-bold text-gray-900 dark:text-white">{acc.name}</div>
                                                                <div className="text-xs text-gray-500 dark:text-gray-400">{(computedBalances[acc.id] || 0).toLocaleString()} {currencySymbol}</div>
                                                            </div>
                                                        </div>
                                                        {selectedAccountObj?.id === acc.id && <Check size={16} className="text-indigo-500" />}
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (<div className="p-4 text-center text-gray-400 text-xs">Aucun compte disponible.</div>)}
                                    </div>
                                )}
                            </div>
                        )}

                        <div>
                            {/* CORRECTION LABEL */}
                            <label className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2 flex items-center gap-2"><Clock size={14} /> Durée de projection</label>
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => setDuration('WEEK')} className={`py-2 px-1 rounded-lg text-xs font-bold border transition-all ${duration === 'WEEK' ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent bg-gray-100 dark:bg-neutral-800 text-gray-500 dark:text-gray-400'}`}>1 Semaine</button>
                                <button onClick={() => setDuration('MONTH')} className={`py-2 px-1 rounded-lg text-xs font-bold border transition-all ${duration === 'MONTH' ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent bg-gray-100 dark:bg-neutral-800 text-gray-500 dark:text-gray-400'}`}>1 Mois</button>
                                <button onClick={() => setDuration('ROLLING_YEAR')} className={`py-2 px-1 rounded-lg text-xs font-bold border transition-all ${duration === 'ROLLING_YEAR' ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent bg-gray-100 dark:bg-neutral-800 text-gray-500 dark:text-gray-400'}`}>1 An (Glissant)</button>
                                <button onClick={() => setDuration('CALENDAR_YEAR')} className={`py-2 px-1 rounded-lg text-xs font-bold border transition-all ${duration === 'CALENDAR_YEAR' ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent bg-gray-100 dark:bg-neutral-800 text-gray-500 dark:text-gray-400'}`}>Fin d'Année</button>
                            </div>
                        </div>

                        {/* INPUTS AVEC BACKGROUND PLUS CLAIR EN DARK MODE ET TEXT BLANC */}
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 block">Solde Initial</label><input type="number" disabled={mode === 'ACCOUNT'} value={balance} onChange={(e) => setBalance(e.target.value)} className={`w-full bg-gray-50 dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700 rounded-xl px-3 py-2 font-mono text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none ${mode==='ACCOUNT' ? 'opacity-50 cursor-not-allowed' : ''}`} /></div>
                            <div><label className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 block">Trades / Semaine</label><input type="number" value={tradesPerWeek} onChange={(e) => setTradesPerWeek(e.target.value)} className="w-full bg-gray-50 dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700 rounded-xl px-3 py-2 font-mono text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 block">Winrate (%)</label><input type="number" value={winRate} onChange={(e) => setWinRate(e.target.value)} className="w-full bg-gray-50 dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700 rounded-xl px-3 py-2 font-mono text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                            <div><label className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 block">Risk / Reward</label><input type="number" value={riskReward} step="0.1" onChange={(e) => setRiskReward(e.target.value)} className="w-full bg-gray-50 dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700 rounded-xl px-3 py-2 font-mono text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                        </div>

                        <div><label className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 block">Risque par trade (%)</label><input type="number" value={riskPercent} step="0.1" onChange={(e) => setRiskPercent(e.target.value)} className="w-full bg-gray-50 dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700 rounded-xl px-3 py-2 font-mono text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" /></div>

                        <button onClick={runSimulation} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-indigo-500/20 mt-4"><RefreshCcw size={18} /> Actualiser</button>
                    </div>
                </div>

                {/* --- CHART & RESULTS --- */}
                <div className="lg:col-span-2 space-y-6">
                    <div className="grid grid-cols-3 gap-4">
                        <div className="bg-white/60 dark:bg-neutral-900/60 p-4 rounded-2xl border border-white/20 dark:border-white/5"><div className="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase mb-1">Capital Projeté</div><div className="text-xl md:text-2xl font-black text-indigo-500 truncate">{stats.finalBalance.toLocaleString()} {currencySymbol}</div></div>
                        <div className="bg-white/60 dark:bg-neutral-900/60 p-4 rounded-2xl border border-white/20 dark:border-white/5"><div className="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase mb-1">Profit Est.</div><div className={`text-xl md:text-2xl font-black truncate ${stats.profit >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>{stats.profit > 0 ? '+' : ''}{stats.profit.toLocaleString()} {currencySymbol}</div></div>
                        <div className="bg-white/60 dark:bg-neutral-900/60 p-4 rounded-2xl border border-white/20 dark:border-white/5"><div className="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase mb-1">Max Drawdown</div><div className="text-xl md:text-2xl font-black text-orange-500">{stats.maxDD}%</div></div>
                    </div>

                    <div className="bg-white/60 dark:bg-neutral-900/60 backdrop-blur-xl rounded-3xl p-6 border border-white/20 dark:border-white/5 shadow-sm h-[400px] relative">
                        {mode === 'ACCOUNT' && !selectedAccountObj && (<div className="absolute inset-0 z-10 flex items-center justify-center bg-white/50 dark:bg-black/50 backdrop-blur-sm rounded-3xl"><p className="font-bold text-gray-500 flex flex-col items-center gap-2"><Target size={32} /> Veuillez sélectionner un compte</p></div>)}
                        <h3 className="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase mb-4 flex items-center gap-2"><BarChart3 size={16} /> Projection d'Equity Curve</h3>
                        <ResponsiveContainer width="100%" height="90%">
                            <AreaChart data={chartData} margin={{ top: 5, right: 0, left: 0, bottom: 0 }}>
                                <defs>
                                    <linearGradient id="colorHistory" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#10b981" stopOpacity={0.3}/><stop offset="95%" stopColor="#10b981" stopOpacity={0}/></linearGradient>
                                    <linearGradient id="colorProjected" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#6366f1" stopOpacity={0.3}/><stop offset="95%" stopColor="#6366f1" stopOpacity={0}/></linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="#333" opacity={0.1} />
                                <XAxis dataKey="dateLabel" stroke="#888" tick={{fontSize: 10}} minTickGap={30} />
                                <YAxis stroke="#888" tick={{fontSize: 10}} domain={['auto', 'auto']} width={40} />
                                {/* CORRECTION TOOLTIP : FORCE LE TEXTE BLANC ET FOND NOIR */}
                                <Tooltip
                                    contentStyle={{ backgroundColor: '#171717', border: '1px solid #333', borderRadius: '12px' }}
                                    itemStyle={{ color: '#fff' }}
                                    labelStyle={{ color: '#fff', fontWeight: 'bold' }}
                                    formatter={(value, name) => [`${value} ${currencySymbol}`, name === 'historical' ? 'Historique' : 'Projection']}
                                    labelFormatter={(val) => `Date : ${val}`}
                                />
                                <Area type="monotone" dataKey="historical" stroke="#10b981" strokeWidth={2} fillOpacity={1} fill="url(#colorHistory)" activeDot={{ r: 6 }} />
                                <Area type="monotone" dataKey="projected" stroke="#6366f1" strokeWidth={2} strokeDasharray="5 5" fillOpacity={1} fill="url(#colorProjected)" connectNulls={true} activeDot={{ r: 6 }} />
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default SimulatorView;

=== src/components/TradeHistory.jsx ===
import React, { useMemo, useState, useRef, useEffect } from 'react';
import { Trash2, ArrowUpCircle, ArrowDownCircle, Wallet, SlidersHorizontal, X, Check, Pencil, Eye, Target, Clock, AlertOctagon, TrendingUp, TrendingDown, Calendar, Percent, Filter, ChevronDown, ArrowDownAZ, ArrowUpAZ, BrainCircuit, Hash, DollarSign, Activity, Scale, Tag, Share2, ArrowDownLeft, ArrowUpRight, Bitcoin, Euro, PoundSterling, JapaneseYen, Disc, BarChart3, Gem } from 'lucide-react';
import { getScoreColor } from '../utils/discipline';

// Options de tri
const SORT_OPTIONS = [
    { value: 'DATE_DESC', label: 'Date (Plus récent)', icon: Calendar },
    { value: 'DATE_ASC', label: 'Date (Plus ancien)', icon: Calendar, iconRotate: true },
    { value: 'PROFIT_DESC', label: 'Gain - Décroissant', icon: TrendingDown },
    { value: 'PROFIT_ASC', label: 'Gain - Croissant', icon: TrendingUp },
    { value: 'PERCENT_DESC', label: 'Perf (%) - Meilleure', icon: ArrowUpAZ },
    { value: 'PERCENT_ASC', label: 'Perf (%) - Pire', icon: ArrowDownAZ },
];

// --- COMPOSANT LOGO ---
const TradeLogo = ({ trade }) => {
    const [imgError, setImgError] = useState(false);

    if (trade.pair === 'SOLDE' || trade.type === 'DEPOSIT' || trade.type === 'WITHDRAWAL') {
        const isDeposit = trade.type === 'DEPOSIT' || parseFloat(trade.profit) > 0;
        return (
            <div className={`w-10 h-10 rounded-full flex items-center justify-center border ${isDeposit ? 'bg-emerald-100 text-emerald-600 border-emerald-200 dark:bg-emerald-900/30 dark:border-emerald-800' : 'bg-rose-100 text-rose-600 border-rose-200 dark:bg-rose-900/30 dark:border-rose-800'}`}>
                {isDeposit ? <ArrowDownLeft size={20} /> : <ArrowUpRight size={20} />}
            </div>
        );
    }

    if (!imgError) {
        return (
            <img
                src={`/icons/${trade.pair.toLowerCase()}.png`}
                alt={trade.pair}
                className="w-10 h-10 rounded-full object-contain bg-white dark:bg-neutral-800 border border-gray-100 dark:border-neutral-700 p-0.5"
                onError={() => setImgError(true)}
            />
        );
    }

    const getFallbackIcon = (pair) => {
        const p = pair.toUpperCase();
        if (p.includes('BTC')) return <Bitcoin size={20} className="text-orange-500" />;
        if (p.includes('ETH') || p.includes('SOL')) return <Gem size={20} className="text-purple-500" />;
        if (p.includes('EUR')) return <Euro size={20} className="text-blue-500" />;
        if (p.includes('GBP')) return <PoundSterling size={20} className="text-indigo-600" />;
        if (p.includes('JPY')) return <JapaneseYen size={20} className="text-rose-500" />;
        if (p.includes('XAU') || p.includes('GOLD')) return <Disc size={20} className="text-yellow-500" />;
        if (p.includes('US30') || p.includes('NAS') || p.includes('SPX')) return <BarChart3 size={20} className="text-gray-500" />;
        return <Activity size={20} className="text-gray-400" />;
    };

    return (
        <div className="w-10 h-10 rounded-full bg-gray-50 dark:bg-neutral-800 border border-gray-100 dark:border-neutral-700 flex items-center justify-center flex-shrink-0">
            {getFallbackIcon(trade.pair)}
        </div>
    );
};

const TradeHistory = ({ trades, onDelete, onEdit, onShare, currencySymbol, colors }) => {

    const getBgColor = (color) => `${color}20`;
    const getBorderColor = (color) => `${color}40`;

    const validTrades = useMemo(() => {
        if (!Array.isArray(trades)) return [];
        return trades.filter(t => t && t.id && (t.pair || t.pair === 'SOLDE'));
    }, [trades]);

    const uniquePairs = useMemo(() => {
        const pairs = validTrades.map(t => t.pair).filter(p => p !== 'SOLDE');
        return [...new Set(pairs)].sort();
    }, [validTrades]);

    const uniqueTags = useMemo(() => {
        const tagsSet = new Set();
        validTrades.forEach(t => {
            if (t.tags && typeof t.tags === 'string') {
                t.tags.split(',').forEach(tag => {
                    const trimmed = tag.trim();
                    if (trimmed) tagsSet.add(trimmed);
                });
            }
        });
        return [...tagsSet].sort();
    }, [validTrades]);

    const [isFilterOpen, setIsFilterOpen] = useState(false);
    const [summaryTrade, setSummaryTrade] = useState(null);
    const [isSortDropdownOpen, setIsSortDropdownOpen] = useState(false);
    const sortDropdownRef = useRef(null);

    const [filterPairs, setFilterPairs] = useState(['ALL']);
    const [filterTags, setFilterTags] = useState(['ALL']);
    const [filterType, setFilterType] = useState('ALL');
    const [filterResult, setFilterResult] = useState('ALL');
    const [sortBy, setSortBy] = useState('DATE_DESC');
    const [dateStart, setDateStart] = useState('');
    const [dateEnd, setDateEnd] = useState('');
    const [minProfit, setMinProfit] = useState('');
    const [maxProfit, setMaxProfit] = useState('');
    const [minPercent, setMinPercent] = useState('');
    const [maxPercent, setMaxPercent] = useState('');

    useEffect(() => {
        function handleClickOutside(event) {
            if (sortDropdownRef.current && !sortDropdownRef.current.contains(event.target)) {
                setIsSortDropdownOpen(false);
            }
        }
        if (isSortDropdownOpen) document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [isSortDropdownOpen]);

    const handleTogglePair = (pair) => {
        if (pair === 'ALL') setFilterPairs(['ALL']);
        else {
            let newSelection;
            if (filterPairs.includes('ALL')) newSelection = [pair];
            else newSelection = filterPairs.includes(pair) ? filterPairs.filter(p => p !== pair) : [...filterPairs, pair];
            setFilterPairs(newSelection.length === 0 ? ['ALL'] : newSelection);
        }
    };

    const handleToggleTag = (tag) => {
        if (tag === 'ALL') setFilterTags(['ALL']);
        else {
            let newSelection;
            if (filterTags.includes('ALL')) newSelection = [tag];
            else newSelection = filterTags.includes(tag) ? filterTags.filter(t => t !== tag) : [...filterTags, tag];
            setFilterTags(newSelection.length === 0 ? ['ALL'] : newSelection);
        }
    };

    const isChecked = (pair) => filterPairs.includes('ALL') || filterPairs.includes(pair);
    const isTagChecked = (tag) => filterTags.includes('ALL') || filterTags.includes(tag);

    const resetFilters = () => {
        setFilterPairs(['ALL']); setFilterTags(['ALL']); setFilterType('ALL'); setFilterResult('ALL');
        setDateStart(''); setDateEnd(''); setMinProfit(''); setMaxProfit(''); setMinPercent(''); setMaxPercent(''); setSortBy('DATE_DESC');
    };

    const enrichedTrades = useMemo(() => {
        const chronological = [...validTrades].sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
        let currentBalance = 0;
        return chronological.map(trade => {
            const tradeProfit = parseFloat(trade.profit) || 0;
            const startBalance = currentBalance;
            currentBalance += tradeProfit;
            let percent = 0;
            if (trade.pair !== 'SOLDE' && startBalance > 0) percent = (tradeProfit / startBalance) * 100;

            let calculatedRiskPct = null;
            let calculatedRR = null;
            if (trade.entry && trade.sl && trade.tp) {
                const entry = parseFloat(trade.entry);
                const sl = parseFloat(trade.sl);
                const tp = parseFloat(trade.tp);
                const risk = Math.abs(entry - sl);
                const reward = Math.abs(tp - entry);
                if (risk > 0) calculatedRR = reward / risk;
            }

            return { ...trade, percentString: trade.pair !== 'SOLDE' ? percent.toFixed(2) + '%' : '-', percentValue: percent, profitValue: tradeProfit, startBalance, calculatedRR, calculatedRiskPct };
        });
    }, [validTrades]);

    const displayedTrades = useMemo(() => {
        let result = enrichedTrades;
        if (!filterPairs.includes('ALL')) result = result.filter(t => filterPairs.includes(t.pair));
        if (!filterTags.includes('ALL')) {
            result = result.filter(t => {
                if (!t.tags) return false;
                const tradeTags = t.tags.split(',').map(tag => tag.trim());
                return filterTags.some(selectedTag => tradeTags.includes(selectedTag));
            });
        }
        if (filterType !== 'ALL') result = result.filter(t => t.type === filterType && t.pair !== 'SOLDE');
        if (filterResult === 'WIN') result = result.filter(t => t.profitValue > 0);
        if (filterResult === 'LOSS') result = result.filter(t => t.profitValue < 0);
        if (dateStart) result = result.filter(t => t.date >= dateStart);
        if (dateEnd) result = result.filter(t => t.date <= dateEnd);
        if (minProfit !== '') result = result.filter(t => t.profitValue >= parseFloat(minProfit));
        if (maxProfit !== '') result = result.filter(t => t.profitValue <= parseFloat(maxProfit));
        if (minPercent !== '') result = result.filter(t => t.percentValue >= parseFloat(minPercent));
        if (maxPercent !== '') result = result.filter(t => t.percentValue <= parseFloat(maxPercent));

        return result.sort((a, b) => {
            switch (sortBy) {
                case 'DATE_DESC': return new Date(b.date) - new Date(a.date) || b.id - a.id;
                case 'DATE_ASC': return new Date(a.date) - new Date(b.date) || a.id - b.id;
                case 'PROFIT_DESC': return b.profitValue - a.profitValue;
                case 'PROFIT_ASC': return a.profitValue - b.profitValue;
                default: return 0;
            }
        });
    }, [enrichedTrades, filterPairs, filterTags, filterType, filterResult, sortBy, dateStart, dateEnd, minProfit, maxProfit, minPercent, maxPercent]);

    // CSS Helpers
    const labelClass = "text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 block";
    const inputClass = "w-full bg-gray-100 dark:bg-neutral-800/80 border border-gray-200 dark:border-neutral-700 focus:border-indigo-500 dark:focus:border-indigo-500 rounded-xl px-3 py-3 text-sm font-bold outline-none transition-all dark:text-white placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 flex items-center";
    const CustomCheckbox = ({ checked, onChange }) => (
        <div onClick={onChange} className={`w-5 h-5 rounded-lg border-2 flex items-center justify-center transition-all cursor-pointer ${checked ? 'bg-indigo-600 border-indigo-600 shadow-md shadow-indigo-500/30' : 'bg-gray-200 dark:bg-neutral-800 border-gray-300 dark:border-neutral-600 hover:border-gray-400 dark:hover:border-neutral-500'}`}>{checked && <Check size={12} className="text-white stroke-[3]" />}</div>
    );
    const activeFiltersCount = (!filterPairs.includes('ALL') ? 1 : 0) + (!filterTags.includes('ALL') ? 1 : 0) + (filterType !== 'ALL' ? 1 : 0) + (filterResult !== 'ALL' ? 1 : 0) + (dateStart || dateEnd ? 1 : 0) + (minProfit !== '' || maxProfit !== '' ? 1 : 0);
    const activeSortOption = SORT_OPTIONS.find(option => option.value === sortBy);

    const renderDisciplineDetails = (trade) => {
        if (!trade.disciplineDetails || Object.keys(trade.disciplineDetails).length === 0) return null;
        const labels = { plan: "Respect du Plan", risk: "Gestion Risque", sl: "Stop Loss", time: "Horaires", doc: "Documentation" };
        return (
            <div className="grid grid-cols-2 gap-2 mt-4">
                {Object.entries(trade.disciplineDetails).map(([key, points]) => (
                    <div key={key} className={`flex items-center justify-between p-2 rounded-lg border ${points > 0 ? 'bg-emerald-50 border-emerald-100 dark:bg-emerald-900/10 dark:border-emerald-900/30' : 'bg-rose-50 border-rose-100 dark:bg-rose-900/10 dark:border-rose-900/30'}`}>
                        <span className="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">{labels[key] || key}</span>
                        <span className={`text-xs font-black ${points > 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'}`}>{points > 0 ? `+${points}` : '0'}</span>
                    </div>
                ))}
            </div>
        );
    };

    if (validTrades.length === 0) return <div className="text-center text-gray-400 py-10 italic">Aucune donnée à afficher.</div>;

    return (
        <>
            {/* --- HEADER --- */}
            <div className="flex justify-between items-center mb-4 px-2">
                <h3 className="font-bold text-lg text-gray-700 dark:text-gray-200">Historique</h3>
                <div className="flex gap-2">
                    <button onClick={() => setIsFilterOpen(true)} className={`flex items-center gap-2 px-4 py-2 rounded-xl transition-all font-medium text-sm border ${activeFiltersCount > 0 ? 'bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/20' : 'bg-white dark:bg-neutral-900 border-gray-200 dark:border-neutral-800 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-neutral-800'}`}>
                        <SlidersHorizontal size={16} /><span>Filtres</span>{activeFiltersCount > 0 && <span className="bg-white/20 backdrop-blur-sm text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md min-w-[1.2rem] text-center">{activeFiltersCount}</span>}
                    </button>
                </div>
            </div>

            {/* --- VUE MOBILE : CARDS --- */}
            <div className="md:hidden space-y-3 pb-20">
                {displayedTrades.map((trade) => {
                    const isTransfer = trade.pair === 'SOLDE';
                    const isWin = trade.profitValue >= 0;
                    const profitColor = isWin ? colors.win : colors.loss;
                    const typeColor = trade.type === 'BUY' ? colors.buy : (trade.type === 'SELL' ? colors.sell : colors.balance);
                    const score = trade.disciplineScore;
                    const scoreColor = getScoreColor(score || 0);

                    return (
                        <div key={trade.id} onClick={() => setSummaryTrade(trade)} className="relative bg-white/60 dark:bg-neutral-900/60 backdrop-blur-xl p-4 rounded-2xl border border-white/20 dark:border-white/5 shadow-sm active:scale-[0.99] transition-transform">
                            <div className="flex justify-between items-start mb-3">
                                <div className="flex items-center gap-3">
                                    <TradeLogo trade={trade} />
                                    <div>
                                        <div className="font-black text-gray-900 dark:text-white text-base flex items-center gap-2">{isTransfer ? 'Mouvement' : trade.pair}{!isTransfer && score !== undefined && <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded-full flex items-center gap-0.5 border ${scoreColor.replace('text-', 'border-').replace('bg-', 'bg-opacity-10 ')}`}><BrainCircuit size={8} /> {score}%</span>}</div>
                                        <div className="text-[11px] text-gray-500 dark:text-gray-400 font-mono flex items-center gap-1"><Clock size={10}/> {trade.date}</div>
                                    </div>
                                </div>
                                <div className="text-right"><div className="text-lg font-black" style={{ color: profitColor }}>{trade.profitValue > 0 ? '+' : ''}{trade.profit}</div>{!isTransfer && <div className="text-[10px] font-bold opacity-80" style={{ color: profitColor }}>{trade.percentString}</div>}</div>
                            </div>
                            <div className="flex justify-between items-center pt-3 border-t border-gray-100 dark:border-neutral-800/50">
                                <div className="flex gap-2 items-center"><span className="inline-flex items-center justify-center gap-1 px-2.5 py-1 rounded-lg text-[10px] font-bold border" style={{ color: typeColor, backgroundColor: getBgColor(typeColor), borderColor: getBorderColor(typeColor) }}>{isTransfer ? (trade.type === 'DEPOSIT' ? 'DÉPÔT' : 'RETRAIT') : <>{trade.type === 'BUY' ? <ArrowUpCircle size={10}/> : <ArrowDownCircle size={10}/>} {trade.type}</>}</span>{!isTransfer && <span className="text-[11px] font-medium text-gray-400 dark:text-gray-500 flex items-center gap-1"><Hash size={10}/> {trade.lot}</span>}</div>
                                <div className="flex items-center gap-1">
                                    <button onClick={(e) => { e.stopPropagation(); onShare && onShare(trade); }} className="p-2 rounded-full bg-gray-50 dark:bg-neutral-800 text-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/20"><Share2 size={16} /></button>
                                    <button onClick={(e) => { e.stopPropagation(); onEdit(trade); }} className="p-2 rounded-full bg-gray-50 dark:bg-neutral-800 text-gray-500 dark:text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/20"><Pencil size={16} /></button>
                                    <button onClick={(e) => { e.stopPropagation(); onDelete(trade.id); }} className="p-2 rounded-full bg-gray-50 dark:bg-neutral-800 text-gray-500 dark:text-gray-400 hover:text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20"><Trash2 size={16} /></button>
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>

            {/* --- VUE PC --- */}
            <div className="hidden md:block overflow-hidden bg-white/60 dark:bg-neutral-900/40 backdrop-blur-xl rounded-3xl shadow-xl border border-white/40 dark:border-white/5">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left select-none">
                        <thead className="bg-white/50 dark:bg-black/40 text-gray-500 dark:text-neutral-500 uppercase text-xs font-bold tracking-wider"><tr><th className="px-6 py-4">Date</th><th className="px-6 py-4">Paire</th><th className="px-6 py-4 text-center">Type</th><th className="px-6 py-4 text-center">Gain %</th><th className="px-6 py-4 hidden lg:table-cell">Prix</th><th className="px-6 py-4 text-right">P&L ({currencySymbol})</th><th className="px-6 py-4 text-center">Actions</th></tr></thead>
                        <tbody className="divide-y divide-gray-100 dark:divide-neutral-800">
                        {displayedTrades.map((trade) => {
                            const isTransfer = trade.pair === 'SOLDE';
                            const isWin = trade.profitValue >= 0;
                            const profitColor = isWin ? colors.win : colors.loss;
                            const typeColor = trade.type === 'BUY' ? colors.buy : (trade.type === 'SELL' ? colors.sell : colors.balance);
                            const score = trade.disciplineScore;
                            const scoreColor = getScoreColor(score || 0);

                            return (
                                <tr
                                    key={trade.id}
                                    onClick={() => setSummaryTrade(trade)}
                                    className={`transition-colors cursor-pointer active:scale-[0.99] active:bg-gray-100 dark:active:bg-neutral-800 ${isTransfer ? 'bg-indigo-50/30 dark:bg-indigo-900/10' : 'hover:bg-white/40 dark:hover:bg-white/5'}`}
                                >
                                    <td className="px-6 py-4 text-gray-600 dark:text-neutral-400 whitespace-nowrap text-xs sm:text-sm font-mono">{trade.date}</td>
                                    <td className="px-6 py-4 font-bold text-indigo-900 dark:text-indigo-300">
                                        <div className="flex items-center gap-3">
                                            <TradeLogo trade={trade} />
                                            <span>{isTransfer ? 'Mouvement' : trade.pair}</span>
                                            {!isTransfer && score !== undefined && (<span className={`text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 ml-2 ${scoreColor}`}><BrainCircuit size={12} /> {score}%</span>)}
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 text-center"><span className="inline-flex items-center justify-center gap-1 px-2 py-1 rounded-md text-[10px] font-bold border w-20" style={{ color: typeColor, backgroundColor: getBgColor(typeColor), borderColor: getBorderColor(typeColor) }}>{isTransfer ? (trade.type === 'DEPOSIT' ? 'DÉPÔT' : 'RETRAIT') : <>{trade.type === 'BUY' ? <ArrowUpCircle size={10}/> : <ArrowDownCircle size={10}/>} {trade.type}</>}</span></td>
                                    <td className="px-6 py-4 text-center">{!isTransfer && trade.percentString !== '-' ? (<span className="font-bold text-xs px-2 py-1 rounded-md" style={{ color: profitColor, backgroundColor: getBgColor(profitColor) }}>{trade.percentValue > 0 ? '+' : ''}{trade.percentString}</span>) : <span className="text-gray-300 dark:text-neutral-700">-</span>}</td>
                                    <td className="px-6 py-4 text-gray-500 dark:text-neutral-500 font-mono hidden lg:table-cell text-xs">{isTransfer ? '-' : <div className="flex flex-col"><span>In: {trade.entry}</span>{trade.exit && <span className="opacity-70">Out: {trade.exit}</span>}</div>}</td>
                                    <td className="px-6 py-4 text-right font-extrabold text-sm" style={{ color: profitColor }}>{trade.profitValue > 0 ? '+' : ''}{trade.profit}</td>
                                    <td className="px-6 py-4 text-center">
                                        <div className="flex items-center justify-center gap-1">
                                            <button onClick={(e) => { e.stopPropagation(); setSummaryTrade(trade); }} className="text-gray-400 hover:text-indigo-500 transition-colors p-2 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-lg hidden md:block"><Eye size={16} /></button>
                                            <button onClick={(e) => { e.stopPropagation(); onShare && onShare(trade); }} className="text-gray-400 hover:text-indigo-500 transition-colors p-2 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-lg"><Share2 size={16} /></button>
                                            <button onClick={(e) => { e.stopPropagation(); onEdit(trade); }} className="text-gray-400 hover:text-indigo-500 transition-colors p-2 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-lg"><Pencil size={16} /></button>
                                            <button onClick={(e) => { e.stopPropagation(); onDelete(trade.id); }} className="text-gray-400 hover:text-rose-500 transition-colors p-2 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg"><Trash2 size={16} /></button>
                                        </div>
                                    </td>
                                </tr>
                            );
                        })}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* --- MODAL RETROSPECTIVE SCROLLABLE --- */}
            {summaryTrade && (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200" onClick={() => setSummaryTrade(null)}>
                    <div className="bg-white dark:bg-[#1a1a1a] w-full max-w-lg rounded-3xl shadow-2xl border border-white/10 overflow-hidden transform transition-all scale-100 flex flex-col max-h-[90vh]" onClick={(e) => e.stopPropagation()}>

                        {/* Header */}
                        <div className="relative p-6 text-white overflow-hidden flex-shrink-0">
                            <div className={`absolute inset-0 opacity-90 ${summaryTrade.profitValue >= 0 ? 'bg-gradient-to-br from-emerald-600 to-teal-900' : 'bg-gradient-to-br from-rose-600 to-red-900'}`}></div>
                            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
                            <div className="relative z-10 flex justify-between items-start">
                                <div><div className="flex items-center gap-2 mb-2 opacity-80 text-xs font-bold uppercase tracking-widest"><Calendar size={12} /> {summaryTrade.date}{summaryTrade.time && <> • {summaryTrade.time}</>} {summaryTrade.disciplineScore !== undefined && (<span className={`ml-2 flex items-center gap-1 px-1.5 py-0.5 rounded bg-white/20 backdrop-blur-sm border border-white/20`}><BrainCircuit size={10} /> {summaryTrade.disciplineScore}%</span>)}</div><h1 className="text-4xl font-black tracking-tighter flex items-center gap-3">{summaryTrade.pair === 'SOLDE' ? 'Mouvement' : summaryTrade.pair}<span className="text-lg opacity-60 font-medium">{summaryTrade.type}</span></h1></div>
                                <button onClick={() => setSummaryTrade(null)} className="p-2 bg-white/20 hover:bg-white/40 rounded-full backdrop-blur-md transition-colors"><X size={20} /></button>
                            </div>
                            <div className="relative z-10 mt-6 flex justify-between items-end">
                                <div><span className="block text-xs font-bold opacity-70 uppercase mb-1">Résultat Net</span><div className="text-5xl font-black tracking-tight">{summaryTrade.profitValue > 0 ? '+' : ''}{summaryTrade.profit} <span className="text-2xl align-top opacity-60">{currencySymbol}</span></div></div>
                                {summaryTrade.pair !== 'SOLDE' && (<div className="bg-white/20 backdrop-blur-md px-4 py-2 rounded-2xl border border-white/10 text-xl font-bold">{summaryTrade.percentValue > 0 ? '+' : ''}{summaryTrade.percentString}</div>)}
                            </div>
                        </div>

                        {/* Contenu Scrollable */}
                        <div className="p-6 space-y-6 overflow-y-auto scrollbar-hide">
                            {summaryTrade.pair !== 'SOLDE' && (
                                <>
                                    <div className="flex items-center justify-between bg-gray-50 dark:bg-neutral-900 rounded-2xl p-4 border border-gray-100 dark:border-neutral-800"><div className="text-left"><span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">Entrée</span><div className="text-xl font-mono font-bold text-gray-800 dark:text-gray-200">{summaryTrade.entry}</div></div><div className="flex-1 mx-4 h-px bg-gray-300 dark:bg-neutral-700 relative"><div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-1.5 rounded-full ${summaryTrade.profitValue >= 0 ? 'bg-emerald-500' : 'bg-rose-500'}`}>{summaryTrade.profitValue >= 0 ? <TrendingUp size={16} className="text-white"/> : <TrendingDown size={16} className="text-white"/>}</div></div><div className="text-right"><span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">Sortie</span><div className="text-xl font-mono font-bold text-gray-800 dark:text-gray-200">{summaryTrade.exit}</div></div></div>
                                    <div><h4 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2"><Target size={12} /> Analyse du Plan</h4><div className="grid grid-cols-2 gap-4"><div className="p-3 bg-gray-50 dark:bg-neutral-900 rounded-xl border border-gray-100 dark:border-neutral-800"><div className="flex justify-between items-center mb-1"><span className="text-[10px] font-bold text-rose-500 uppercase">Stop Loss</span><AlertOctagon size={12} className="text-rose-500"/></div><div className="font-mono font-bold text-gray-700 dark:text-gray-300">{summaryTrade.sl || '-'}</div></div><div className="p-3 bg-gray-50 dark:bg-neutral-900 rounded-xl border border-gray-100 dark:border-neutral-800"><div className="flex justify-between items-center mb-1"><span className="text-[10px] font-bold text-emerald-500 uppercase">Take Profit</span><Target size={12} className="text-emerald-500"/></div><div className="font-mono font-bold text-gray-700 dark:text-gray-300">{summaryTrade.tp || '-'}</div></div><div className="p-3 bg-gray-50 dark:bg-neutral-900 rounded-xl border border-gray-100 dark:border-neutral-800"><div className="flex justify-between items-center mb-1"><span className="text-[10px] font-bold text-gray-400 uppercase">Risque Pris</span><Activity size={12} className="text-gray-400"/></div><div className="font-bold text-gray-700 dark:text-gray-300">{summaryTrade.calculatedRiskPct ? `${summaryTrade.calculatedRiskPct.toFixed(2)}%` : '-'}</div></div><div className="p-3 bg-gray-50 dark:bg-neutral-900 rounded-xl border border-gray-100 dark:border-neutral-800"><div className="flex justify-between items-center mb-1"><span className="text-[10px] font-bold text-gray-400 uppercase">R:R Réalisé</span><Scale size={12} className="text-gray-400"/></div><div className="font-bold text-gray-700 dark:text-gray-300">{summaryTrade.calculatedRR ? `1:${summaryTrade.calculatedRR.toFixed(2)}` : '-'}</div></div></div></div>
                                    {summaryTrade.disciplineScore !== undefined && (<div className="border-t border-b border-gray-100 dark:border-neutral-800 py-4"><div className="flex justify-between items-center mb-2"><h4 className="font-bold text-gray-700 dark:text-white flex items-center gap-2"><BrainCircuit size={18} className="text-indigo-500"/> Discipline</h4><span className={`text-sm font-black px-2 py-1 rounded-lg ${getScoreColor(summaryTrade.disciplineScore)}`}>{summaryTrade.disciplineScore}%</span></div>{renderDisciplineDetails(summaryTrade)}</div>)}
                                    <div className="flex flex-wrap gap-2">{summaryTrade.lot && <span className="px-3 py-1.5 bg-gray-100 dark:bg-neutral-800 rounded-lg text-xs font-bold text-gray-600 dark:text-gray-300 flex items-center gap-1"><Hash size={12}/> {summaryTrade.lot} Lots</span>}{summaryTrade.fees && parseFloat(summaryTrade.fees) !== 0 && <span className="px-3 py-1.5 bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 rounded-lg text-xs font-bold flex items-center gap-1"><DollarSign size={12}/> Frais: {summaryTrade.fees}</span>}{summaryTrade.tags && typeof summaryTrade.tags === 'string' && summaryTrade.tags.split(',').map((tag, i) => (tag.trim() !== '' && <span key={i} className="px-3 py-1.5 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 rounded-lg text-xs font-bold border border-indigo-100 dark:border-indigo-800">{tag.trim()}</span>))}</div>
                                </>
                            )}
                        </div>

                        {/* Footer Actions */}
                        <div className="p-4 bg-gray-50 dark:bg-neutral-900 border-t border-gray-100 dark:border-neutral-800 flex justify-between gap-3 flex-shrink-0">
                            <button onClick={() => { setSummaryTrade(null); onShare && onShare(summaryTrade); }} className="px-5 py-2.5 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 border border-indigo-100 dark:border-indigo-900/30 rounded-xl text-sm font-bold transition-colors flex items-center gap-2"><Share2 size={16}/> Partager</button>
                            <div className="flex gap-2">
                                <button onClick={() => { onEdit(summaryTrade); setSummaryTrade(null); }} className="px-5 py-2.5 bg-white dark:bg-neutral-800 border border-gray-200 dark:border-neutral-700 text-gray-700 dark:text-gray-300 rounded-xl text-sm font-bold shadow-sm transition-colors">Modifier</button>
                                <button onClick={() => onDelete(summaryTrade.id)} className="px-5 py-2.5 bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 border border-rose-100 dark:border-rose-900/30 rounded-xl text-sm font-bold transition-colors">Supprimer</button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* --- MODAL FILTRES --- */}
            {isFilterOpen && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white dark:bg-neutral-900 w-full max-w-sm rounded-3xl shadow-2xl border border-white/20 dark:border-white/10 p-6 animate-in zoom-in-95 duration-200 flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-center mb-6 flex-shrink-0">
                            <div className="flex items-center gap-2"><h3 className="text-lg font-black text-gray-800 dark:text-white flex items-center gap-2"><Filter size={20} className="text-indigo-500"/> Filtres</h3><button onClick={resetFilters} className="text-[10px] font-bold text-rose-500 hover:text-rose-600 px-2 py-1 bg-rose-50 dark:bg-rose-900/20 rounded-lg transition-colors">Réinitialiser</button></div>
                            <button onClick={() => setIsFilterOpen(false)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-neutral-800 text-gray-500"><X size={18} /></button>
                        </div>
                        <div className="overflow-y-auto pr-2 space-y-6">
                            <div><label className={labelClass}>Trier par</label><div className="relative" ref={sortDropdownRef}><button onClick={() => setIsSortDropdownOpen(!isSortDropdownOpen)} className={`${inputClass} justify-between`}><div className="flex items-center gap-2">{React.createElement(activeSortOption.icon, { size: 16, className: `text-indigo-500 ${activeSortOption.iconRotate ? 'rotate-180' : ''}` })}<span>{activeSortOption.label}</span></div><ChevronDown size={16} className={`text-gray-400 transition-transform ${isSortDropdownOpen ? 'rotate-180' : ''}`} /></button>{isSortDropdownOpen && (<div className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-neutral-800 rounded-xl shadow-xl border border-gray-100 dark:border-neutral-700 overflow-hidden z-20 animate-in zoom-in-95 duration-150">{SORT_OPTIONS.map(option => (<button key={option.value} onClick={() => { setSortBy(option.value); setIsSortDropdownOpen(false); }} className={`w-full flex items-center justify-between px-4 py-3 text-sm font-bold transition-colors ${sortBy === option.value ? 'bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-neutral-700'}`}><div className="flex items-center gap-3">{React.createElement(option.icon, { size: 16, className: option.iconRotate ? 'rotate-180' : '' })}{option.label}</div>{sortBy === option.value && <Check size={16} />}</button>))}</div>)}</div></div><div className="h-px bg-gray-100 dark:bg-neutral-800"></div><div><label className={labelClass}>Paires</label><div className="bg-gray-100 dark:bg-neutral-800/50 rounded-xl p-2 max-h-32 overflow-y-auto border border-transparent transition-colors custom-scrollbar"><div onClick={() => handleTogglePair('ALL')} className="flex items-center gap-3 p-2 rounded-lg hover:bg-white/50 dark:hover:bg-neutral-700 cursor-pointer transition-colors"><CustomCheckbox checked={isChecked('ALL')} onChange={() => handleTogglePair('ALL')} /><span className="text-sm font-bold text-gray-700 dark:text-gray-200">Toutes les paires</span></div><div className="h-px bg-gray-200 dark:bg-neutral-700 my-1"></div>{uniquePairs.map(pair => (<div key={pair} onClick={() => handleTogglePair(pair)} className="flex items-center gap-3 p-2 rounded-lg hover:bg-white/50 dark:hover:bg-neutral-700 cursor-pointer transition-colors group"><CustomCheckbox checked={isChecked(pair)} onChange={() => handleTogglePair(pair)} /><div className="flex items-center gap-2 opacity-80 group-hover:opacity-100"><img src={`/icons/${pair.toLowerCase()}.png`} alt="" className="w-5 h-5 object-contain" onError={(e) => {e.target.style.display='none'}} /><span className="text-sm text-gray-700 dark:text-gray-300 font-medium">{pair}</span></div></div>))}</div></div>
                            {uniqueTags.length > 0 && (<><div className="h-px bg-gray-100 dark:bg-neutral-800"></div><div><label className={labelClass}>Tags / Stratégies</label><div className="bg-gray-100 dark:bg-neutral-800/50 rounded-xl p-2 max-h-32 overflow-y-auto border border-transparent transition-colors custom-scrollbar"><div onClick={() => handleToggleTag('ALL')} className="flex items-center gap-3 p-2 rounded-lg hover:bg-white/50 dark:hover:bg-neutral-700 cursor-pointer transition-colors"><CustomCheckbox checked={isTagChecked('ALL')} onChange={() => handleToggleTag('ALL')} /><span className="text-sm font-bold text-gray-700 dark:text-gray-200">Tous les tags</span></div><div className="h-px bg-gray-200 dark:bg-neutral-700 my-1"></div>{uniqueTags.map(tag => (<div key={tag} onClick={() => handleToggleTag(tag)} className="flex items-center gap-3 p-2 rounded-lg hover:bg-white/50 dark:hover:bg-neutral-700 cursor-pointer transition-colors group"><CustomCheckbox checked={isTagChecked(tag)} onChange={() => handleToggleTag(tag)} /><span className="text-sm text-gray-700 dark:text-gray-300 font-medium flex items-center gap-2"><Tag size={12}/> {tag}</span></div>))}</div></div></>)}
                            <div className="h-px bg-gray-100 dark:bg-neutral-800"></div><div><label className={labelClass}>Période</label><div className="grid grid-cols-2 gap-3"><div className="relative group"><Calendar size={14} className="absolute left-3 top-3.5 text-gray-400 group-focus-within:text-indigo-500 transition-colors" /><input type="date" value={dateStart} onChange={(e) => setDateStart(e.target.value)} className={`${inputClass} pl-9 text-xs dark:[color-scheme:dark]`} placeholder="Début" /></div><div className="relative group"><Calendar size={14} className="absolute left-3 top-3.5 text-gray-400 group-focus-within:text-indigo-500 transition-colors" /><input type="date" value={dateEnd} onChange={(e) => setDateEnd(e.target.value)} className={`${inputClass} pl-9 text-xs dark:[color-scheme:dark]`} placeholder="Fin" /></div></div></div><div className="grid grid-cols-1 gap-4"><div><label className={labelClass}>Type</label><div className="grid grid-cols-3 gap-2 p-1 bg-gray-100 dark:bg-neutral-800 rounded-xl"><button onClick={() => setFilterType('ALL')} className={`py-2 rounded-lg text-xs font-bold transition-all ${filterType === 'ALL' ? 'bg-white dark:bg-neutral-700 shadow-sm text-gray-900 dark:text-white' : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300'}`}>TOUS</button><button onClick={() => setFilterType('BUY')} className={`py-2 rounded-lg text-xs font-bold transition-all ${filterType === 'BUY' ? 'shadow-lg text-white' : 'text-gray-400'}`} style={filterType === 'BUY' ? { backgroundColor: colors.buy } : {}}>BUY</button><button onClick={() => setFilterType('SELL')} className={`py-2 rounded-lg text-xs font-bold transition-all ${filterType === 'SELL' ? 'shadow-lg text-white' : 'text-gray-400'}`} style={filterType === 'SELL' ? { backgroundColor: colors.sell } : {}}>SELL</button></div></div><div><label className={labelClass}>Résultat</label><div className="grid grid-cols-3 gap-2 p-1 bg-gray-100 dark:bg-neutral-800 rounded-xl"><button onClick={() => setFilterResult('ALL')} className={`py-2 rounded-lg text-xs font-bold transition-all ${filterResult === 'ALL' ? 'bg-white dark:bg-neutral-700 shadow-sm text-gray-900 dark:text-white' : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300'}`}>TOUS</button><button onClick={() => setFilterResult('WIN')} className={`py-2 rounded-lg text-xs font-bold transition-all ${filterResult === 'WIN' ? 'shadow-lg text-white' : 'text-gray-400'}`} style={filterResult === 'WIN' ? { backgroundColor: colors.win } : {}}>WIN</button><button onClick={() => setFilterResult('LOSS')} className={`py-2 rounded-lg text-xs font-bold transition-all ${filterResult === 'LOSS' ? 'shadow-lg text-white' : 'text-gray-400'}`} style={filterResult === 'LOSS' ? { backgroundColor: colors.loss } : {}}>LOSS</button></div></div></div>
                        </div>
                        <div className="mt-6 pt-4 border-t border-gray-100 dark:border-neutral-800 flex-shrink-0"><button onClick={() => setIsFilterOpen(false)} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-500/30 transition-all flex items-center justify-center gap-2 active:scale-95"><Check size={18} /> Voir Résultats</button></div>
                    </div>
                </div>
            )}
        </>
    );
};

export default TradeHistory;

=== src/components/ShareTradeModal.jsx ===
import React, { useRef, useState } from 'react';
import { X, Download, Share2, TrendingUp, TrendingDown, Wallet } from 'lucide-react';
import html2canvas from 'html2canvas';

const ShareTradeModal = ({ isOpen, onClose, trade, currencySymbol }) => {
    const cardRef = useRef(null);
    const [isGenerating, setIsGenerating] = useState(false);

    if (!isOpen || !trade) return null;

    const isWin = parseFloat(trade.profit) >= 0;
    const pnlColor = isWin ? 'text-emerald-400' : 'text-rose-400';
    const bgGradient = isWin
        ? 'from-emerald-900/40 via-neutral-900 to-neutral-950'
        : 'from-rose-900/40 via-neutral-900 to-neutral-950';

    const handleDownload = async () => {
        setIsGenerating(true);
        if (cardRef.current) {
            try {
                const canvas = await html2canvas(cardRef.current, {
                    backgroundColor: '#000000',
                    scale: 2, // Meilleure qualité
                });
                const link = document.createElement('a');
                link.download = `trade-${trade.pair}-${trade.date}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                console.error("Erreur génération image", err);
            }
        }
        setIsGenerating(false);
    };

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in">
            <div className="bg-neutral-900 w-full max-w-md rounded-3xl border border-white/10 overflow-hidden shadow-2xl relative">

                {/* Header Modal */}
                <div className="p-4 flex justify-between items-center border-b border-white/5">
                    <h3 className="text-white font-bold flex items-center gap-2">
                        <Share2 size={18} className="text-indigo-500" /> Partager le Trade
                    </h3>
                    <button onClick={onClose}><X className="text-gray-500 hover:text-white" /></button>
                </div>

                {/* --- LA CARTE À PARTAGER (Ce qui sera capturé) --- */}
                <div className="p-6 flex justify-center bg-neutral-950">
                    <div
                        ref={cardRef}
                        className={`w-full aspect-[4/5] rounded-2xl p-6 relative overflow-hidden flex flex-col justify-between border border-white/10 bg-gradient-to-br ${bgGradient}`}
                    >
                        {/* Background Noise/Pattern */}
                        <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>

                        {/* Header Carte */}
                        <div className="relative z-10 flex justify-between items-start">
                            <div>
                                <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Trading Journal</span>
                                <h2 className="text-3xl font-black text-white mt-1">{trade.pair}</h2>
                                <span className={`text-xs font-bold px-2 py-0.5 rounded ${trade.type === 'BUY' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}`}>
                                    {trade.type}
                                </span>
                            </div>
                            <div className="bg-white/10 backdrop-blur-md p-2 rounded-xl border border-white/10">
                                {isWin ? <TrendingUp size={24} className="text-emerald-400" /> : <TrendingDown size={24} className="text-rose-400" />}
                            </div>
                        </div>

                        {/* Résultats */}
                        <div className="relative z-10 text-center my-8">
                            <div className={`text-5xl font-black ${pnlColor} drop-shadow-lg`}>
                                {isWin ? '+' : ''}{parseFloat(trade.profit).toFixed(2)}
                                <span className="text-2xl ml-1">{currencySymbol}</span>
                            </div>
                            <div className="text-sm font-bold text-gray-400 mt-2 uppercase tracking-wide">Profit / Perte</div>
                        </div>

                        {/* Détails Techniques */}
                        <div className="relative z-10 grid grid-cols-2 gap-3 text-xs">
                            <div className="bg-black/40 p-3 rounded-lg border border-white/5">
                                <span className="text-gray-500 block mb-1">Entrée</span>
                                <span className="text-white font-mono font-bold">{trade.entry}</span>
                            </div>
                            <div className="bg-black/40 p-3 rounded-lg border border-white/5">
                                <span className="text-gray-500 block mb-1">Sortie</span>
                                <span className="text-white font-mono font-bold">{trade.exit}</span>
                            </div>
                            <div className="bg-black/40 p-3 rounded-lg border border-white/5">
                                <span className="text-gray-500 block mb-1">Date</span>
                                <span className="text-white font-bold">{trade.date}</span>
                            </div>
                            <div className="bg-black/40 p-3 rounded-lg border border-white/5">
                                <span className="text-gray-500 block mb-1">Discipline</span>
                                <div className="flex gap-1">
                                    {[...Array(5)].map((_, i) => (
                                        <div key={i} className={`h-1.5 w-full rounded-full ${i < (trade.disciplineScore / 20) ? (isWin ? 'bg-emerald-500' : 'bg-rose-500') : 'bg-gray-700'}`}></div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Footer Logo */}
                        <div className="relative z-10 mt-auto pt-6 border-t border-white/10 flex justify-between items-end">
                            <div>
                                <span className="text-[10px] text-gray-500">Généré par</span>
                                <div className="text-sm font-bold text-white flex items-center gap-1">
                                    <Wallet size={14} className="text-indigo-500" /> Mon Journal Pro
                                </div>
                            </div>
                            <div className="text-[10px] text-gray-600 italic">
                                #TradingDiscipline
                            </div>
                        </div>
                    </div>
                </div>

                {/* Footer Actions */}
                <div className="p-6 bg-neutral-900 border-t border-white/5">
                    <button
                        onClick={handleDownload}
                        disabled={isGenerating}
                        className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {isGenerating ? 'Génération...' : <><Download size={18} /> Télécharger l'image</>}
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ShareTradeModal;

=== src/components/Sidebar.jsx ===
import React from 'react';
import { LayoutDashboard, LineChart, Calendar, Calculator, Megaphone, Settings, LogOut, Crown, ClipboardList, TrendingUp, Wallet, Bell, User, ShieldAlert, Sparkles } from 'lucide-react';
import { api } from '../api';

const Sidebar = ({ user, activeTab, onNavClick, onLogout, hasNewUpdates, unreadNotifsCount, onOpenNotif }) => {

    const menuItems = [
        { id: 'journal', icon: LayoutDashboard, label: 'Journal' },
        { id: 'routine', icon: ClipboardList, label: 'Routine' },
        { id: 'graphs', icon: LineChart, label: 'Analyses', isPro: true },
        { id: 'calendar', icon: Calendar, label: 'Calendrier', isPro: true },
        { id: 'simulator', icon: TrendingUp, label: 'Simulateur', isPro: true },
        { id: 'calculator', icon: Calculator, label: 'Calculatrice' },
        { id: 'updates', icon: Megaphone, label: 'Nouveautés', hasBadge: hasNewUpdates },
    ];

    if (user?.is_pro === 7) {
        menuItems.push({ id: 'admin', icon: ShieldAlert, label: 'Admin Panel' });
    }

    const avatarSrc = user ? api.getAvatarUrl(user.avatar_url) : null;

    // --- LOGIQUE DE BADGE RESTAURÉE ---
    const renderBadge = () => { if (user.is_pro === 7) return <span className="px-2.5 py-0.5 rounded-lg text-[10px] font-bold bg-gradient-to-r from-fuchsia-500 to-purple-600 text-white border border-purple-400/30 inline-flex items-center gap-1.5 shadow-sm min-w-[60px] justify-center"><ShieldAlert size={10} fill="currentColor" /> ADMIN</span>; if (user.is_pro === 2) return <span className="px-2.5 py-0.5 rounded-lg text-[10px] font-bold bg-gradient-to-r from-emerald-400 to-teal-500 text-white border border-emerald-400/30 inline-flex items-center gap-1.5 shadow-sm min-w-[60px] justify-center"><Sparkles size={10} fill="currentColor" /> VIP</span>; if (user.is_pro === 1) return <span className="px-2.5 py-0.5 rounded-lg text-[10px] font-bold bg-gradient-to-r from-amber-300 to-yellow-500 text-yellow-900 border border-yellow-400/30 inline-flex items-center gap-1.5 shadow-sm min-w-[60px] justify-center"><Crown size={10} fill="currentColor" /> PRO</span>; return <span className="px-2.5 py-0.5 rounded-lg text-[10px] font-bold bg-gray-100 text-gray-500 border border-gray-200 dark:bg-white/10 dark:text-gray-300 dark:border-white/10 inline-flex items-center gap-1.5 min-w-[60px] justify-center"><User size={10} /> FREE</span>; };


    return (
        <aside className="hidden md:flex flex-col w-64 h-full bg-white dark:bg-[#262626] border-r border-gray-200 dark:border-neutral-800 relative z-20 transition-colors duration-300">
            {/* Header User */}
            <div className="p-6 border-b border-gray-100 dark:border-neutral-800">
                <div className="flex items-center gap-3 mb-4">
                    <div className="w-10 h-10 rounded-full bg-gray-100 dark:bg-neutral-800 overflow-hidden border border-gray-200 dark:border-white/10 flex-shrink-0 flex items-center justify-center">
                        {avatarSrc ? (
                            <img src={avatarSrc} alt="Profile" className="w-full h-full object-cover" />
                        ) : (
                            <User size={20} className="text-gray-400" />
                        )}
                    </div>
                    <div className="flex-1 min-w-0">
                        <h3 className="font-bold text-gray-900 dark:text-white truncate">{user?.first_name || 'Trader'}</h3>
                        <div className="flex items-center gap-1.5 mt-1">
                            {renderBadge()}
                        </div>
                    </div>
                </div>

                <button onClick={onOpenNotif} className="w-full flex items-center justify-between px-3 py-2 rounded-xl bg-gray-50 dark:bg-neutral-900 hover:bg-gray-100 dark:hover:bg-neutral-800 border border-gray-200 dark:border-neutral-800 transition-colors group">
                    <div className="flex items-center gap-2 text-xs font-bold text-gray-500 dark:text-gray-400 group-hover:text-indigo-500">
                        <Bell size={14} /> Notifications
                    </div>
                    {unreadNotifsCount > 0 && (
                        <span className="bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[18px] text-center">
                            {unreadNotifsCount}
                        </span>
                    )}
                </button>
            </div>

            {/* Navigation */}
            <nav className="flex-1 overflow-y-auto py-4 px-3 space-y-1 scrollbar-hide">
                {menuItems.map((item) => {
                    const isActive = activeTab === item.id;
                    const Icon = item.icon;
                    const isLocked = item.isPro && user.is_pro === 0;

                    return (
                        <button
                            key={item.id}
                            onClick={() => onNavClick(item.id)}
                            className={`w-full flex items-center justify-between px-3 py-2.5 rounded-xl transition-all group ${
                                isActive
                                    ? 'bg-indigo-50 text-indigo-600 dark:bg-indigo-500/10 dark:text-indigo-400 font-bold'
                                    : 'text-gray-500 hover:bg-gray-50 dark:text-gray-400 dark:hover:bg-white/5 hover:text-gray-900 dark:hover:text-white'
                            }`}
                        >
                            <div className="flex items-center gap-3">
                                <Icon size={18} className={isActive ? 'text-indigo-600 dark:text-indigo-400' : 'text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300'} />
                                <span className="text-sm">{item.label}</span>
                            </div>

                            {isLocked && <Crown size={12} className="text-amber-500" />}
                            {item.hasBadge && <span className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>}
                        </button>
                    );
                })}
            </nav>

            {/* Footer */}
            <div className="p-3 border-t border-gray-200 dark:border-neutral-800 space-y-1">
                <button onClick={() => onNavClick('settings')} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all ${activeTab === 'settings' ? 'bg-gray-100 dark:bg-white/10 text-gray-900 dark:text-white font-bold' : 'text-gray-500 hover:bg-gray-50 dark:text-gray-400 dark:hover:bg-white/5'}`}>
                    <Settings size={18} />
                    <span className="text-sm">Paramètres</span>
                </button>
                <button onClick={onLogout} className="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/10 transition-all">
                    <LogOut size={18} />
                    <span className="text-sm font-medium">Déconnexion</span>
                </button>
            </div>
        </aside>
    );
};

export default Sidebar;

=== src/components/TodoView.jsx ===
import React, { useState, useEffect, useLayoutEffect, useRef } from 'react';
import { CheckSquare, Plus, Trash2, Activity, Zap, GripVertical, Trophy, Lock, Edit2 } from 'lucide-react';
import { api } from '../api';
import TodoListModal, { ICON_MAP } from './TodoListModal';

const FREQ_CONFIG = {
    'DAILY': { label: 'Jour', fullLabel: 'Quotidien', color: 'indigo', bg: 'bg-indigo-50 dark:bg-indigo-500/20', text: 'text-indigo-600 dark:text-indigo-300', border: 'border-indigo-200 dark:border-indigo-500/30', bar: 'bg-indigo-500' },
    'WEEKLY': { label: 'Semaine', fullLabel: 'Hebdomadaire', color: 'purple', bg: 'bg-purple-50 dark:bg-purple-500/20', text: 'text-purple-600 dark:text-purple-300', border: 'border-purple-200 dark:border-purple-500/30', bar: 'bg-purple-500' },
    'MONTHLY': { label: 'Mois', fullLabel: 'Mensuel', color: 'emerald', bg: 'bg-emerald-50 dark:bg-emerald-500/20', text: 'text-emerald-600 dark:text-emerald-300', border: 'border-emerald-200 dark:border-emerald-500/30', bar: 'bg-emerald-500' },
    'YEARLY': { label: 'Année', fullLabel: 'Annuel', color: 'amber', bg: 'bg-amber-50 dark:bg-amber-500/20', text: 'text-amber-600 dark:text-amber-300', border: 'border-amber-200 dark:border-amber-500/30', bar: 'bg-amber-500' },
    'ONCE': { label: 'Unique', fullLabel: 'Unique', color: 'gray', bg: 'bg-gray-100 dark:bg-gray-800', text: 'text-gray-500 dark:text-gray-400', border: 'border-gray-200 dark:border-gray-700', bar: 'bg-gray-400' },
};

const TodoView = ({ user, onShowUpgrade }) => {
    const [todoLists, setTodoLists] = useState([]);
    const [loading, setLoading] = useState(true);
    const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
    const [editingList, setEditingList] = useState(null);
    const [newTasks, setNewTasks] = useState({});
    const [animateProgress, setAnimateProgress] = useState(false);

    const dragItemIndex = useRef(null);
    const [activeId, setActiveId] = useState(null);
    const listRefs = useRef(new Map());
    const prevRects = useRef(new Map());

    useEffect(() => {
        loadData();
        setTimeout(() => setAnimateProgress(true), 100);
    }, []);

    const listOrderSignature = todoLists.map(l => l.id).join(',');
    useLayoutEffect(() => {
        listRefs.current.forEach((node, id) => {
            const prevRect = prevRects.current.get(id);
            if (prevRect && node) {
                const currentRect = node.getBoundingClientRect();
                const deltaX = prevRect.left - currentRect.left;
                const deltaY = prevRect.top - currentRect.top;
                if (deltaX !== 0 || deltaY !== 0) {
                    node.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                    node.style.transition = 'none';
                }
            }
        });
        requestAnimationFrame(() => {
            listRefs.current.forEach((node) => {
                if (node) {
                    // eslint-disable-next-line no-unused-expressions
                    node.getBoundingClientRect();
                    node.style.transform = '';
                    const isDraggingThisNode = node.getAttribute('data-is-dragging') === 'true';
                    node.style.transition = isDraggingThisNode ? 'none' : 'transform 300ms cubic-bezier(0.2, 0, 0.2, 1)';
                }
            });
        });
    }, [listOrderSignature]);

    const snapshotPositions = () => {
        prevRects.current.clear();
        listRefs.current.forEach((node, id) => {
            if (node) {
                prevRects.current.set(id, node.getBoundingClientRect());
            }
        });
    };

    const loadData = async () => {
        try {
            const data = await api.getTodoLists();
            setTodoLists(data);
        } catch (error) { console.error(error); } finally { setLoading(false); }
    };

    const handleDragStart = (e, index, id) => { e.stopPropagation(); dragItemIndex.current = index; setActiveId(id); e.dataTransfer.effectAllowed = "move"; snapshotPositions(); };
    const handleDragEnter = (e, index) => { e.stopPropagation(); if (dragItemIndex.current === null || dragItemIndex.current === index) return; snapshotPositions(); const newLists = [...todoLists]; const draggedItemContent = newLists[dragItemIndex.current]; newLists.splice(dragItemIndex.current, 1); newLists.splice(index, 0, draggedItemContent); dragItemIndex.current = index; setTodoLists(newLists); };
    const handleDragEnd = async (e) => { e.stopPropagation(); dragItemIndex.current = null; setActiveId(null); try { const listsToOrder = todoLists.map((l, index) => ({ id: l.id, position: index })); await api.reorderTodoLists(listsToOrder); } catch (error) { console.error("Erreur save order", error); } };

    const handleSaveList = async (listData) => {
        const payload = { ...listData };
        if (user.is_pro === 0) {
            payload.color = 'indigo';
            payload.icon = null;
        }

        try {
            if (editingList) {
                const updatedList = await api.updateTodoList(editingList.id, payload);
                setTodoLists(todoLists.map(l => l.id === editingList.id ? { ...l, ...updatedList, tasks: l.tasks } : l));
            } else {
                const newList = await api.createTodoList(payload);
                setTodoLists([...todoLists, newList]);
            }
        } catch (error) {
            console.error(error);
            if (error.message.includes('403')) {
                alert("Limite atteinte.");
                onShowUpgrade();
            } else {
                alert("Erreur sauvegarde liste");
            }
        }
    };

    const handleDeleteList = async (id) => {
        if (!window.confirm("Supprimer cette liste et toutes ses missions ?")) return;
        try {
            await api.deleteTodoList(id);
            setTodoLists(todoLists.filter(l => l.id !== id));
        } catch (error) { console.error(error); }
    };

    const handleEditClick = (list) => {
        setEditingList(list);
        setIsCreateModalOpen(true);
    };

    const handleCreateClick = () => {
        const canCreate = user.is_pro >= 1 || todoLists.length < 3;
        if (canCreate) {
            setEditingList(null);
            setIsCreateModalOpen(true);
        } else {
            onShowUpgrade();
        }
    };

    const handleAddTask = async (e, listId) => { e.preventDefault(); const text = newTasks[listId]; if (!text || !text.trim()) return; const currentList = todoLists.find(l => l.id === listId); if (user.is_pro === 0 && currentList.tasks.length >= 10) { alert("Limite de 10 tâches atteinte. Passez en PRO !"); onShowUpgrade(); return; } try { const addedTask = await api.addTodo({ list_id: listId, text: text }); const updatedLists = todoLists.map(list => { if (list.id === listId) return { ...list, tasks: [...list.tasks, addedTask] }; return list; }); setTodoLists(updatedLists); setNewTasks({ ...newTasks, [listId]: '' }); } catch (error) { console.error(error); } };
    const handleToggleTask = async (listId, taskId, currentStatus) => { const newStatus = currentStatus ? 0 : 1; const updatedLists = todoLists.map(list => { if (list.id === listId) return { ...list, tasks: list.tasks.map(t => t.id === taskId ? { ...t, is_completed: newStatus } : t) }; return list; }); setTodoLists(updatedLists); try { await api.toggleTodo(taskId, newStatus); } catch (error) { loadData(); } };
    const handleDeleteTask = async (listId, taskId) => { const updatedLists = todoLists.map(list => { if (list.id === listId) return { ...list, tasks: list.tasks.filter(t => t.id !== taskId) }; return list; }); setTodoLists(updatedLists); try { await api.deleteTodo(taskId); } catch (error) { loadData(); } };
    const calculateProgress = (frequency) => { const lists = todoLists.filter(l => l.frequency === frequency); const tasks = lists.flatMap(l => l.tasks); const total = tasks.length; const completed = tasks.filter(t => t.is_completed).length; return total === 0 ? 0 : Math.round((completed / total) * 100); };
    const allTasks = todoLists.flatMap(l => l.tasks); const totalGlobal = allTasks.length; const completedGlobal = allTasks.filter(t => t.is_completed).length; const progressGlobal = totalGlobal === 0 ? 0 : Math.round((completedGlobal / totalGlobal) * 100);
    const dailyProg = calculateProgress('DAILY'); const weeklyProg = calculateProgress('WEEKLY'); const monthlyProg = calculateProgress('MONTHLY'); const yearlyProg = calculateProgress('YEARLY');

    const MiniProgressBar = ({ freqKey, percent }) => {
        const config = FREQ_CONFIG[freqKey];
        const isComplete = percent === 100;
        const baseColor = config.color;
        return (
            <div className={`p-4 rounded-xl border flex flex-col justify-between h-full transition-all duration-500 ${isComplete ? `bg-${baseColor}-50/80 dark:bg-${baseColor}-900/20 border-${baseColor}-500/50 shadow-md shadow-${baseColor}-500/20` : 'bg-gray-50 dark:bg-black/20 border-gray-100 dark:border-white/5'}`}>
                <div className="flex justify-between items-end mb-3"><span className={`text-[10px] font-bold uppercase tracking-wide flex items-center gap-1 ${isComplete ? `text-${baseColor}-600 dark:text-${baseColor}-400` : 'text-gray-500 dark:text-gray-400'}`}>{config.label}{isComplete && <CheckSquare size={10} />}</span><span className={`text-xl font-black transition-all ${isComplete ? `text-${baseColor}-600 dark:text-${baseColor}-400 scale-110` : config.text}`}>{percent}%</span></div>
                <div className="w-full h-2 bg-gray-200 dark:bg-neutral-800 rounded-full overflow-hidden"><div className={`h-full transition-all duration-1000 ease-out ${isComplete ? `bg-gradient-to-r from-${baseColor}-400 to-${baseColor}-600` : config.bar}`} style={{ width: animateProgress ? `${percent}%` : '0%' }}></div></div>
            </div>
        );
    };

    return (
        <div className="max-w-6xl mx-auto pb-20 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {/* Header Dashboard */}
            <div className={`mb-8 backdrop-blur-xl rounded-3xl p-6 md:p-8 border shadow-sm relative overflow-hidden transition-all duration-700 ${progressGlobal === 100 ? 'bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 border-indigo-500/30 shadow-[0_0_30px_rgba(99,102,241,0.15)]' : 'bg-white/60 dark:bg-neutral-900/60 border-white/20 dark:border-white/5'}`}>
                {progressGlobal === 100 && (<div className="absolute top-0 right-0 p-10 opacity-10 pointer-events-none"><Trophy size={150} className="text-indigo-500 rotate-12" /></div>)}
                <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4 relative z-10"><div><h2 className="text-2xl font-black text-gray-900 dark:text-white flex items-center gap-2">{progressGlobal === 100 ? <Trophy className="text-yellow-500 animate-bounce" /> : <Activity className="text-indigo-500" />}Dashboard Routine</h2><p className="text-sm text-gray-500 dark:text-gray-400 mt-1">{progressGlobal === 100 ? "Félicitations ! Tous les objectifs sont atteints." : `${totalGlobal} missions actives réparties sur ${todoLists.length} listes.`}</p></div><div className="text-left md:text-right"><span className={`text-5xl font-black transition-colors duration-500 ${progressGlobal === 100 ? 'text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-600' : 'text-indigo-600 dark:text-indigo-400'}`}>{progressGlobal}%</span><span className="text-xs font-bold text-gray-400 uppercase block mt-1">Accompli Globalement</span></div></div>
                <div className="w-full h-4 bg-gray-200 dark:bg-neutral-800 rounded-full overflow-hidden mb-8 shadow-inner relative z-10"><div className={`h-full transition-all duration-1000 ease-out ${progressGlobal === 100 ? 'bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500 bg-[length:200%_100%] animate-[gradient_3s_infinite]' : 'bg-gradient-to-r from-indigo-500 to-purple-600'}`} style={{ width: animateProgress ? `${progressGlobal}%` : '0%' }}></div></div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 relative z-10"><MiniProgressBar freqKey="DAILY" percent={dailyProg} /><MiniProgressBar freqKey="WEEKLY" percent={weeklyProg} /><MiniProgressBar freqKey="MONTHLY" percent={monthlyProg} /><MiniProgressBar freqKey="YEARLY" percent={yearlyProg} /></div>
            </div>

            {/* Listes Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {todoLists.map((list, index) => {
                    const Icon = list.icon ? (ICON_MAP[list.icon] || Zap) : Zap;
                    const colorClass = `text-${list.color}-500`;
                    const bgClass = `bg-${list.color}-50 dark:bg-${list.color}-900/10`;
                    const badgeConfig = FREQ_CONFIG[list.frequency] || FREQ_CONFIG['DAILY'];
                    const isDragging = activeId === list.id;

                    return (
                        <div key={list.id} ref={(el) => listRefs.current.set(list.id, el)} data-is-dragging={isDragging} className={`rounded-3xl p-5 border flex flex-col h-full min-h-[350px] relative group cursor-grab active:cursor-grabbing transition-all duration-300 ease-out ${isDragging ? 'bg-indigo-50/30 dark:bg-indigo-900/5 border-dashed border-2 border-indigo-300 dark:border-indigo-700 opacity-60 scale-[0.98]' : 'bg-white dark:bg-neutral-900/40 dark:border-white/5 hover:shadow-lg hover:border-indigo-200 dark:hover:border-indigo-800'}`} draggable onDragStart={(e) => handleDragStart(e, index, list.id)} onDragEnter={(e) => handleDragEnter(e, index)} onDragEnd={handleDragEnd} onDragOver={(e) => e.preventDefault()}>
                            <div className={`transition-opacity duration-200 flex flex-col h-full ${isDragging ? 'opacity-0' : 'opacity-100'}`}>
                                <div className="absolute top-4 right-4 flex gap-2">
                                    <GripVertical className="text-gray-300 dark:text-neutral-700 cursor-grab opacity-50 group-hover:opacity-100" size={16} />
                                    {/* Bouton EDIT */}
                                    <button onClick={() => handleEditClick(list)} className="text-gray-300 hover:text-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-lg transition-colors opacity-0 group-hover:opacity-100 p-1"><Edit2 size={16} /></button>
                                    <button onClick={() => handleDeleteList(list.id)} className="text-gray-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors opacity-0 group-hover:opacity-100 p-1"><Trash2 size={16} /></button>
                                </div>
                                <div className="flex items-center gap-3 mb-2 pr-16 flex-shrink-0">
                                    {list.icon && (<div className={`p-2.5 rounded-xl ${bgClass} ${colorClass}`}><Icon size={20} /></div>)}
                                    <div><h3 className="font-bold text-lg text-gray-900 dark:text-white truncate max-w-[150px]">{list.title}</h3><span className={`text-[10px] font-bold uppercase px-2 py-0.5 rounded border ${badgeConfig.bg} ${badgeConfig.text} ${badgeConfig.border}`}>{badgeConfig.fullLabel}</span></div>
                                </div>
                                <div className="h-px bg-gray-100 dark:bg-neutral-800 my-4 flex-shrink-0"></div>
                                <div className="space-y-3 flex-1 overflow-y-auto min-h-0 scrollbar-hide">
                                    {list.tasks.length > 0 ? (list.tasks.map(task => (<div key={task.id} className="flex items-start gap-3 group/task"><button onClick={() => handleToggleTask(list.id, task.id, task.is_completed)} className={`mt-0.5 flex-shrink-0 w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${task.is_completed ? `bg-${list.color}-500 border-${list.color}-500 text-white` : 'border-gray-300 dark:border-neutral-600 hover:border-indigo-400'}`}>{!!task.is_completed && <CheckSquare size={12} />}</button><span className={`text-sm flex-1 break-words ${task.is_completed ? 'line-through text-gray-400 dark:text-gray-600' : 'text-gray-700 dark:text-gray-200'}`}>{task.text}</span><button onClick={() => handleDeleteTask(list.id, task.id)} className="opacity-0 group-hover/task:opacity-100 text-gray-300 hover:text-red-500 transition-opacity"><XIcon size={14} /></button></div>))) : (<div className="text-center py-6 text-gray-400 text-xs italic">Aucune mission</div>)}
                                </div>
                                <form onSubmit={(e) => handleAddTask(e, list.id)} className="mt-auto pt-3 border-t border-gray-100 dark:border-neutral-800 flex-shrink-0">
                                    <div className="relative"><input type="text" placeholder="Ajouter une mission..." className="w-full bg-gray-50 dark:bg-neutral-950/50 border border-gray-200 dark:border-neutral-800 rounded-xl py-2 pl-3 pr-9 text-xs font-bold outline-none focus:ring-1 focus:ring-indigo-500 text-gray-900 dark:text-white" value={newTasks[list.id] || ''} onChange={(e) => setNewTasks({ ...newTasks, [list.id]: e.target.value })} /><button type="submit" className={`absolute right-2 top-1/2 -translate-y-1/2 ${colorClass} hover:scale-110 transition-transform`}><Plus size={16} /></button></div>
                                </form>
                            </div>
                        </div>
                    );
                })}

                <button onClick={handleCreateClick} className="border-2 border-dashed border-gray-300 dark:border-neutral-700 rounded-3xl p-6 flex flex-col items-center justify-center gap-4 text-gray-400 hover:text-indigo-500 hover:border-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/10 transition-all min-h-[350px] group">
                    <div className="w-16 h-16 rounded-full bg-gray-100 dark:bg-neutral-800 flex items-center justify-center group-hover:scale-110 transition-transform">
                        {user.is_pro >= 1 || todoLists.length < 3 ? <Plus size={32} /> : <Lock size={32} className="text-amber-500" />}
                    </div>
                    <span className="font-bold">{user.is_pro >= 1 ? 'Créer une nouvelle liste' : todoLists.length < 3 ? 'Créer une liste (Gratuit)' : 'Limite atteinte (3/3)'}</span>
                </button>
            </div>

            <TodoListModal isOpen={isCreateModalOpen} onClose={() => setIsCreateModalOpen(false)} onSave={handleSaveList} user={user} listToEdit={editingList} />
        </div>
    );
};

const XIcon = ({size}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>);

export default TodoView;

=== src/components/NotificationModal.jsx ===
import React from 'react';
import { Bell, X, Crown } from 'lucide-react';

const NotificationModal = ({ isOpen, onClose, notifications }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 z-[150] flex items-start justify-end p-4 md:p-6 animate-in fade-in slide-in-from-right-10 duration-300">
            <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
            <div className="relative bg-white dark:bg-neutral-900 w-full max-w-sm rounded-3xl shadow-2xl border border-white/20 dark:border-white/10 overflow-hidden mt-16 md:mt-0">
                <div className="p-4 border-b border-gray-100 dark:border-neutral-800 flex justify-between items-center bg-gray-50 dark:bg-white/5">
                    <h3 className="font-bold text-gray-900 dark:text-white flex items-center gap-2"><Bell size={18} className="text-indigo-500" /> Notifications</h3>
                    <button onClick={onClose}><X size={20} className="text-gray-500" /></button>
                </div>
                <div className="max-h-[60vh] overflow-y-auto p-4 space-y-3 scrollbar-hide">
                    {notifications.length === 0 ? (
                        <div className="text-center py-8 text-gray-400 text-sm">Aucune notification.</div>
                    ) : (
                        notifications.map(notif => (
                            <div key={notif.id} className={`p-4 rounded-xl text-sm border ${notif.is_read ? 'bg-white dark:bg-black/20 border-gray-100 dark:border-white/5 opacity-60' : 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-100 dark:border-indigo-500/20'}`}>
                                <div className="flex justify-between items-start mb-1">
                                    {/* Style Badge Violet pour GRADE ici aussi */}
                                    <span className={`flex items-center gap-1 text-[10px] font-bold px-2 py-0.5 rounded ${notif.type === 'GRADE' ? 'bg-purple-100 text-purple-600 dark:bg-purple-500/20 dark:text-purple-300' : 'bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-300'}`}>
                                        {notif.type === 'GRADE' && <Crown size={12} />}
                                        {notif.type}
                                    </span>
                                    <span className="text-[10px] text-gray-400">{notif.date}</span>
                                </div>
                                <p className="text-gray-800 dark:text-gray-200 mt-1 leading-snug">{notif.message}</p>
                            </div>
                        ))
                    )}
                </div>
            </div>
        </div>
    );
};

export default NotificationModal;

=== src/components/TradeForm.jsx ===
import React, { useState, useRef, useEffect } from 'react';
import { PlusCircle, X, Calendar, ChevronDown, Check, ArrowRightLeft, Wallet, TrendingUp, Save, RefreshCw, Calculator, Camera, Loader2, Lock, Crown, BrainCircuit, Target, AlertTriangle } from 'lucide-react';
import Tesseract from 'tesseract.js';
import { calculateDisciplineScore, checkRiskCompliance, checkRRCompliance } from '../utils/discipline';

const PAIRS = [
    { code: 'EURUSD', name: 'Euro / US Dollar', type: 'FOREX' },
    { code: 'GBPUSD', name: 'Great Britain Pound', type: 'FOREX' },
    { code: 'USDJPY', name: 'US Dollar / Yen', type: 'FOREX' },
    { code: 'XAUUSD', name: 'Gold', type: 'METAL' },
    { code: 'US30', name: 'Dow Jones', type: 'INDICE' },
    { code: 'BTCUSD', name: 'Bitcoin', type: 'CRYPTO' },
    { code: 'ETHUSD', name: 'Ethereum', type: 'CRYPTO' },
];

const TradeForm = ({ isOpen, onClose, onAddTrade, onUpdateTrade, tradeToEdit, currencySymbol, currentAccount, user, onShowUpgrade, currentBalance }) => {
    if (!isOpen) return null;

    const [mode, setMode] = useState('trade');
    const [isScanning, setIsScanning] = useState(false);
    const fileScanRef = useRef(null);

    const [formData, setFormData] = useState({
        pair: '', date: new Date().toISOString().split('T')[0], time: '12:00',
        type: 'BUY', entry: '', exit: '', sl: '', tp: '', lot: '', profit: '', fees: '',
        tags: '', hasScreenshot: false
    });

    const [transferData, setTransferData] = useState({ type: 'DEPOSIT', amount: '', date: new Date().toISOString().split('T')[0] });
    const [isPairOpen, setIsPairOpen] = useState(false);
    const [autoCalculate, setAutoCalculate] = useState(true);
    const [calcStatus, setCalcStatus] = useState('');

    const [liveStats, setLiveStats] = useState({ riskPct: 0, rr: 0, riskOk: false, rrOk: false });

    const dropdownRef = useRef(null);

    const formatTags = (value) => {
        if (!value) return '';
        if (Array.isArray(value)) return value.join(', ');
        if (typeof value === 'object') return '';
        return value;
    };

    // --- INITIALISATION ---
    useEffect(() => {
        if (tradeToEdit) {
            if (tradeToEdit.pair === 'SOLDE') {
                setMode('transfer');
                setTransferData({
                    type: tradeToEdit.type,
                    amount: Math.abs(parseFloat(tradeToEdit.profit)).toString(),
                    date: tradeToEdit.date
                });
            } else {
                setMode('trade');
                setFormData({
                    ...tradeToEdit,
                    tags: formatTags(tradeToEdit.tags),
                    hasScreenshot: tradeToEdit.hasScreenshot || false,
                    fees: tradeToEdit.fees || ''
                });
                setAutoCalculate(false);
            }
        } else {
            setMode('trade');
            setFormData({
                pair: '', date: new Date().toISOString().split('T')[0], time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                type: 'BUY', entry: '', exit: '', sl: '', tp: '', lot: '', profit: '', fees: '',
                tags: '',
                hasScreenshot: false
            });
            setTransferData({ type: 'DEPOSIT', amount: '', date: new Date().toISOString().split('T')[0] });
            setAutoCalculate(true);
            setCalcStatus('');
            setLiveStats({ riskPct: 0, rr: 0, riskOk: false, rrOk: false });
        }
    }, [tradeToEdit, isOpen]);

    useEffect(() => {
        function handleClickOutside(event) {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setIsPairOpen(false);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    // --- LOGIQUE OCR / PARSING MT5 (Ajoutée) ---
    const parseMT5Data = (text) => {
        const extracted = { fees: 0, time: '' };
        // Nettoyage de base
        const cleanText = text.replace(/->|→|>/g, ' ').toUpperCase();
        const lines = cleanText.split('\n').map(l => l.trim()).filter(l => l.length > 2);

        let mainLineIndex = -1;

        // 1. Trouver la ligne principale (BUY/SELL)
        for (let i = lines.length - 1; i >= 0; i--) {
            const line = lines[i];
            // Regex qui cherche BUY ou SELL suivi d'un chiffre (le lot)
            if (line.match(/(BUY|SELL)\s+\d/)) {
                if (PAIRS.some(p => line.includes(p.code)) || line.match(/[A-Z]{6}/)) {
                    mainLineIndex = i;
                    const foundPair = PAIRS.find(p => line.includes(p.code));
                    extracted.pair = foundPair ? foundPair.code : line.match(/\b([A-Z]{6})\b/)[1];

                    const typeLotMatch = line.match(/(BUY|SELL)\s+([0-9\.]+)/);
                    if (typeLotMatch) {
                        extracted.type = typeLotMatch[1];
                        extracted.lot = typeLotMatch[2];
                    }
                    break;
                }
            }
        }

        if (mainLineIndex === -1) return extracted;

        // 2. Analyser les lignes autour (Date, SL, TP, Fees, Profit)
        // On regarde les 15 lignes suivantes (ou jusqu'à la fin)
        const relevantLines = lines.slice(mainLineIndex + 1, mainLineIndex + 15);

        for (const line of relevantLines) {
            // Date & Heure
            if (!extracted.date) {
                const dateTimeMatch = line.match(/(\d{4})[\.-](\d{2})[\.-](\d{2})\s+(\d{2})[:\.](\d{2})(?:[:\.](\d{2}))?/);
                if (dateTimeMatch) {
                    extracted.date = `${dateTimeMatch[1]}-${dateTimeMatch[2]}-${dateTimeMatch[3]}`;
                    extracted.time = `${dateTimeMatch[4]}:${dateTimeMatch[5]}`;
                } else {
                    const d = line.match(/(\d{4})[\.-](\d{2})[\.-](\d{2})/);
                    if (d) extracted.date = `${d[1]}-${d[2]}-${d[3]}`;
                }
            }

            // SL / TP
            if (!extracted.sl) { const sl = line.match(/(?:S|5)[\s\/\\I\|\.]*L[:\s]*([\d\.]+)/); if (sl) extracted.sl = sl[1]; }
            if (!extracted.tp) { const tp = line.match(/T[\s\/\\I\|\.]*P[:\s]*([\d\.]+)/); if (tp) extracted.tp = tp[1]; }

            // Frais (Swap / Commission)
            const chargesMatch = line.match(/(?:CHARGES|COMMISSION|C\s*H\s*A\s*R\s*G\s*E\s*S)[:\s]*([-]?[\d\.]+)/);
            if (chargesMatch) extracted.fees += Math.abs(parseFloat(chargesMatch[1]));

            const swapMatch = line.match(/(?:SWAP|S\s*W\s*A\s*P)[:\s]*([-]?[\d\.]+)/);
            if (swapMatch) extracted.fees += Math.abs(parseFloat(swapMatch[1]));

            // Prix (Entry, Exit) & Profit
            if (!extracted.entry && !line.includes(extracted.date)) {
                // Ignore les lignes SL/TP/SWAP pour la recherche de prix nus
                if (line.match(/(?:S|5)[\s\/\\I\|\.]*L/) || line.match(/T[\s\/\\I\|\.]*P/)) continue;
                if (line.match(/(?:CHARGES|COMMISSION|SWAP)/)) continue;

                if (!extracted.profit) {
                    const profitLabelMatch = line.match(/PROFIT[:\s]*([-]?[\d\.]+)/);
                    if (profitLabelMatch) extracted.profit = profitLabelMatch[1];
                }

                // Cherche une séquence de nombres (ex: 1.08500 -> 1.08600)
                const nums = line.match(/([-]?\d+\.\d{2,})/g);
                if (nums) {
                    if (nums.length >= 3) {
                        extracted.entry = nums[0];
                        extracted.exit = nums[1];
                        extracted.profit = nums[2];
                    } else if (nums.length === 2) {
                        extracted.entry = nums[0];
                        extracted.exit = nums[1];
                    }
                }
            }
        }

        // Nettoyage final
        if (parseFloat(extracted.sl) === 0) extracted.sl = '';
        if (parseFloat(extracted.tp) === 0) extracted.tp = '';

        return extracted;
    };

    const handleScanImage = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setIsScanning(true);
        try {
            const result = await Tesseract.recognize(file, 'eng');
            const data = parseMT5Data(result.data.text);

            if (data.pair) {
                // Mise à jour du formulaire avec les données extraites
                setFormData(prev => ({
                    ...prev,
                    pair: data.pair || prev.pair,
                    type: data.type || prev.type,
                    lot: data.lot || prev.lot,
                    entry: data.entry || prev.entry,
                    exit: data.exit || prev.exit,
                    sl: data.sl || prev.sl,
                    tp: data.tp || prev.tp,
                    profit: data.profit || prev.profit,
                    fees: data.fees ? data.fees.toFixed(2) : prev.fees,
                    date: data.date || prev.date,
                    time: data.time || prev.time,
                    // Marquer qu'on a utilisé le scan
                    hasScreenshot: true,
                    tags: 'Scan MT5'
                }));
                setAutoCalculate(false); // Désactiver le calcul auto pour ne pas écraser le profit lu
            } else {
                alert("Impossible de lire les détails du trade. Assurez-vous que l'image est nette.");
            }
        } catch (error) {
            console.error(error);
            alert("Erreur lors de la lecture de l'image.");
        } finally {
            setIsScanning(false);
        }
    };

    const handleScanClick = () => { if (user?.is_pro >= 1) fileScanRef.current?.click(); else onShowUpgrade(); };


    // --- CALCULS LIVE & HELPERS (Existants) ---
    useEffect(() => {
        if (mode !== 'trade') return;
        const entry = parseFloat(formData.entry);
        const sl = parseFloat(formData.sl);
        const tp = parseFloat(formData.tp);
        const lot = parseFloat(formData.lot);
        let stats = { riskPct: 0, rr: 0, riskOk: false, rrOk: false };

        if (!isNaN(entry) && !isNaN(sl) && !isNaN(lot) && lot > 0) {
            let contractSize = 100000;
            const p = formData.pair ? formData.pair.toUpperCase() : '';
            if (p.includes('XAU') || p.includes('GOLD')) contractSize = 100;
            else if (p.includes('BTC') || p.includes('ETH') || p.includes('US30') || p.includes('NDX')) contractSize = 1;
            else if (p.includes('JPY')) contractSize = 1000;

            const riskDist = Math.abs(entry - sl);
            const riskAmt = riskDist * lot * contractSize;
            const balanceToUse = currentBalance > 0 ? currentBalance : 0;

            if (balanceToUse > 0) {
                stats.riskPct = (riskAmt / balanceToUse) * 100;
                const targetRisk = parseFloat(currentAccount?.max_risk) || 2.0;
                stats.riskOk = checkRiskCompliance(stats.riskPct, targetRisk);
            }

            if (!isNaN(tp) && riskDist > 0) {
                const rewardDist = Math.abs(tp - entry);
                stats.rr = rewardDist / riskDist;
                const targetRR = parseFloat(currentAccount?.default_rr) || 2.0;
                stats.rrOk = checkRRCompliance(stats.rr, targetRR);
            }
        }
        setLiveStats(stats);
    }, [formData.entry, formData.sl, formData.tp, formData.lot, formData.pair, currentAccount, currentBalance]);

    const getContractSize = (pairCode) => { if (!pairCode) return 100000; const p = pairCode.toUpperCase(); if (p.includes('XAU') || p.includes('GOLD')) return 100; if (p.includes('BTC') || p.includes('ETH') || p.includes('US30') || p.includes('NDX')) return 1; if (p.includes('JPY')) return 1000; return 100000; };

    const calculateProfit = async (entryPrice, exitPrice, lotSize, pairCode, tradeType, manualFees = null) => {
        const entry = parseFloat(entryPrice); const exit = parseFloat(exitPrice); const lot = parseFloat(lotSize);
        if (isNaN(entry) || isNaN(exit) || isNaN(lot)) return;
        let diff = tradeType === 'BUY' ? (exit - entry) : (entry - exit);
        const contractSize = getContractSize(pairCode);
        let grossProfit = diff * lot * contractSize;

        if (pairCode.endsWith('USD')) { /* OK */ }
        else if (pairCode.startsWith('USD')) { grossProfit = grossProfit / exit; }

        let commission = 0;
        if (manualFees !== null && manualFees !== '') commission = Math.abs(parseFloat(manualFees));

        const netProfit = grossProfit - commission;
        setCalcStatus(commission > 0 ? `(Comm: ${commission.toFixed(2)})` : '');
        setFormData(prev => ({ ...prev, profit: netProfit.toFixed(2), fees: (manualFees !== null) ? manualFees : (commission > 0 ? commission.toFixed(2) : '') }));
    };

    useEffect(() => {
        if (!autoCalculate || mode !== 'trade') return;
        const timer = setTimeout(() => { if (formData.entry && formData.exit && formData.lot) calculateProfit(formData.entry, formData.exit, formData.lot, formData.pair, formData.type, formData.fees); }, 500);
        return () => clearTimeout(timer);
    }, [formData.entry, formData.exit, formData.lot, formData.pair, formData.type, formData.fees, autoCalculate]);


    // --- SOUMISSION ---
    const handleSubmit = (e) => {
        e.preventDefault();
        let finalData = {};

        if (mode === 'trade') {
            if(!formData.pair || !formData.entry) return;

            const tagsArray = typeof formData.tags === 'string'
                ? formData.tags.split(',').map(t => t.trim()).filter(t => t)
                : [];

            const dataForScore = { ...formData, tags: tagsArray };
            const discipline = calculateDisciplineScore(dataForScore, currentAccount, currentBalance);

            finalData = {
                ...dataForScore,
                tags: tagsArray.join(', '),
                disciplineScore: discipline.total,
                disciplineDetails: discipline.details
            };
        } else {
            if(!transferData.amount) return;
            const profitValue = transferData.type === 'DEPOSIT' ? parseFloat(transferData.amount) : -parseFloat(transferData.amount);
            finalData = { pair: 'SOLDE', type: transferData.type, date: transferData.date, entry: 0, exit: 0, sl: 0, tp: 0, lot: 0, profit: profitValue };
        }

        if (tradeToEdit) onUpdateTrade({ ...finalData, id: tradeToEdit.id });
        else onAddTrade(finalData);
    };

    const handleChange = (e) => {
        const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
        setFormData({ ...formData, [e.target.name]: value });
    };
    const selectPair = (code) => { setFormData({ ...formData, pair: code }); setIsPairOpen(false); }

    const inputContainerClass = "flex flex-col gap-1 w-full";
    const labelClass = "text-xs font-bold text-gray-700 dark:text-gray-400 uppercase tracking-wider ml-1";
    const inputClass = "w-full bg-gray-100 dark:bg-neutral-800 border border-transparent focus:border-indigo-500 dark:focus:border-indigo-500 rounded-xl px-4 py-3 text-sm font-medium outline-none transition-all text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 min-w-0 appearance-none";
    const tabClass = (active) => `flex-1 py-3 text-sm font-bold rounded-xl transition-all flex items-center justify-center gap-2 ${active ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'bg-gray-200 text-gray-600 hover:bg-gray-300 dark:bg-neutral-800 dark:text-neutral-400 dark:hover:bg-neutral-700'}`;

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white dark:bg-neutral-900 w-full max-w-2xl rounded-3xl shadow-2xl border border-white/20 dark:border-white/10 overflow-hidden animate-in zoom-in-95 duration-200 flex flex-col max-h-[90vh]">

                <div className="px-6 md:px-8 py-6 border-b border-gray-200 dark:border-neutral-800 flex justify-between items-center bg-gray-50 dark:bg-neutral-900/50 flex-shrink-0">
                    <h3 className="text-xl font-bold flex items-center text-gray-900 dark:text-white">
                        {mode === 'trade' ? <TrendingUp className="mr-2 text-indigo-500" /> : <Wallet className="mr-2 text-emerald-500" />}
                        {tradeToEdit ? 'Modifier' : (mode === 'trade' ? 'Nouveau Trade' : 'Gestion Solde')}
                    </h3>
                    <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-neutral-800 text-gray-500 transition-colors"><X size={20} /></button>
                </div>

                <div className="overflow-y-auto p-6 md:p-8 scrollbar-hide">
                    {/* BOUTON SCANNER */}
                    {mode === 'trade' && !tradeToEdit && (
                        <div className="mb-6 relative">
                            <input type="file" ref={fileScanRef} onChange={handleScanImage} accept="image/*" className="hidden" />
                            <button onClick={handleScanClick} disabled={isScanning} className={`w-full py-4 rounded-xl border-2 border-dashed transition-all flex flex-col items-center justify-center gap-2 group relative overflow-hidden ${user?.is_pro >= 1 ? 'border-indigo-300 dark:border-indigo-800 bg-indigo-50 dark:bg-indigo-900/10 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/30' : 'border-amber-300 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/10 text-amber-600 dark:text-amber-500 hover:bg-amber-100 dark:hover:bg-amber-900/20'}`}>
                                {isScanning ? (<><Loader2 size={24} className="animate-spin" /><span className="font-bold text-sm">Lecture de l'image...</span></>) : (<><Camera size={24} className="group-hover:scale-110 transition-transform" /><div className="text-center"><span className="block font-bold text-sm">Scanner capture MT5</span></div></>)}
                            </button>
                        </div>
                    )}

                    <div className="flex gap-4 mb-8">
                        <button type="button" onClick={() => setMode('trade')} className={tabClass(mode === 'trade')}><TrendingUp size={16} /> Trading</button>
                        <button type="button" onClick={() => setMode('transfer')} className={tabClass(mode === 'transfer')}><Wallet size={16} /> Dépôt</button>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-6">
                        {mode === 'trade' && (
                            <>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className={inputContainerClass} ref={dropdownRef}>
                                        <label className={labelClass}>Paire</label>
                                        <div className="relative w-full">
                                            <button type="button" onClick={() => setIsPairOpen(!isPairOpen)} className={`${inputClass} flex items-center justify-between text-left`}>{formData.pair ? (<div className="flex items-center gap-3 truncate"><img src={`/icons/${formData.pair.toLowerCase()}.png`} alt={formData.pair} className="w-6 h-6 object-contain flex-shrink-0" onError={(e) => {e.target.style.display='none'}} /><span className="truncate">{formData.pair}</span></div>) : <span className="text-gray-400">Sélectionner</span>}<ChevronDown size={16} className={`text-gray-400 transition-transform flex-shrink-0 ${isPairOpen ? 'rotate-180' : ''}`} /></button>
                                            {isPairOpen && (<div className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-neutral-800 rounded-xl shadow-xl border border-gray-200 dark:border-neutral-700 max-h-40 overflow-y-auto z-10 p-1 w-full">{PAIRS.map((pair) => (<button key={pair.code} type="button" onClick={() => selectPair(pair.code)} className="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-indigo-50 dark:hover:bg-neutral-700 rounded-lg transition-colors group"><img src={`/icons/${pair.code.toLowerCase()}.png`} alt={pair.code} className="w-6 h-6 object-contain flex-shrink-0" onError={(e) => {e.target.style.display='none'}} /><div className="text-left truncate"><div className="font-bold text-gray-900 dark:text-gray-200 text-sm truncate">{pair.code}</div></div>{formData.pair === pair.code && <Check size={16} className="ml-auto text-indigo-500 flex-shrink-0" />}</button>))}</div>)}
                                        </div>
                                    </div>
                                    <div className={inputContainerClass}><label className={labelClass}>Date & Heure</label><div className="flex gap-2"><div className="relative flex-1 min-w-0"><div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none"><Calendar size={18} /></div><input type="date" name="date" value={formData.date} onChange={handleChange} className={`${inputClass} pl-10 w-full`} /></div><div className="relative w-24 flex-shrink-0"><input type="time" name="time" value={formData.time} onChange={handleChange} className={`${inputClass} px-1 text-center w-full`} /></div></div></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className={inputContainerClass}><label className={labelClass}>Direction</label><div className="grid grid-cols-2 gap-2 p-1 bg-gray-100 dark:bg-neutral-800 rounded-xl w-full"><button type="button" onClick={() => setFormData({...formData, type: 'BUY'})} className={`py-2 rounded-lg text-sm font-bold transition-all ${formData.type === 'BUY' ? 'bg-white text-blue-600 shadow-sm dark:bg-neutral-700 dark:text-blue-400' : 'text-gray-500 hover:text-gray-700 dark:text-gray-400'}`}>BUY</button><button type="button" onClick={() => setFormData({...formData, type: 'SELL'})} className={`py-2 rounded-lg text-sm font-bold transition-all ${formData.type === 'SELL' ? 'bg-white text-orange-600 shadow-sm dark:bg-neutral-700 dark:text-orange-400' : 'text-gray-500 hover:text-gray-700 dark:text-gray-400'}`}>SELL</button></div></div><div className={inputContainerClass}><label className={labelClass}>Lot Size</label><input type="number" name="lot" placeholder="0.00" value={formData.lot} onChange={handleChange} className={inputClass} step="0.01" /></div></div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4"><div className={inputContainerClass}><label className={labelClass}>Entrée</label><input type="number" name="entry" value={formData.entry} onChange={handleChange} className={inputClass} step="0.00001" /></div><div className={inputContainerClass}><label className={labelClass}>Sortie</label><input type="number" name="exit" value={formData.exit} onChange={handleChange} className={inputClass} step="0.00001" /></div><div className={inputContainerClass}><label className={labelClass}>Stop Loss</label><input type="number" name="sl" value={formData.sl} onChange={handleChange} className={inputClass} step="0.00001" /></div><div className={inputContainerClass}><label className={labelClass}>Take Profit</label><input type="number" name="tp" value={formData.tp} onChange={handleChange} className={inputClass} step="0.00001" /></div></div>

                                <hr className="border-gray-200 dark:border-neutral-800" />

                                {/* --- ANALYSE LIVE --- */}
                                <div>
                                    <div className="flex items-center gap-2 mb-4"><BrainCircuit className="text-indigo-500" size={18} /><h4 className="text-sm font-black uppercase tracking-wider text-gray-500 dark:text-gray-400">Analyse Stratégie (Live)</h4></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className={`p-4 rounded-xl border flex flex-col items-center justify-center text-center transition-all ${liveStats.riskPct > 0 ? (liveStats.riskOk ? 'bg-emerald-50 border-emerald-200 dark:bg-emerald-900/20 dark:border-emerald-800' : 'bg-rose-50 border-rose-200 dark:bg-rose-900/20 dark:border-rose-800') : 'bg-gray-50 border-gray-200 dark:bg-neutral-800/50 dark:border-neutral-800'}`}>
                                            <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Risque</span>
                                            <div className="font-black text-2xl my-1" style={{ color: liveStats.riskPct > 0 ? (liveStats.riskOk ? '#10b981' : '#f43f5e') : 'inherit' }}>{liveStats.riskPct > 0 ? liveStats.riskPct.toFixed(2) + '%' : '-'}</div>
                                            <div className="flex items-center gap-1 text-[10px] font-medium text-gray-500"><Target size={10} /><span>Cible : {currentAccount?.max_risk || 2}%</span></div>
                                        </div>
                                        <div className={`p-4 rounded-xl border flex flex-col items-center justify-center text-center transition-all ${liveStats.rr > 0 ? (liveStats.rrOk ? 'bg-emerald-50 border-emerald-200 dark:bg-emerald-900/20 dark:border-emerald-800' : 'bg-orange-50 border-orange-200 dark:bg-orange-900/20 dark:border-orange-800') : 'bg-gray-50 border-gray-200 dark:bg-neutral-800/50 dark:border-neutral-800'}`}>
                                            <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">R:R Ratio</span>
                                            <div className="font-black text-2xl my-1" style={{ color: liveStats.rr > 0 ? (liveStats.rrOk ? '#10b981' : '#f97316') : 'inherit' }}>{liveStats.rr > 0 ? liveStats.rr.toFixed(2) : '-'}</div>
                                            <div className="flex items-center gap-1 text-[10px] font-medium text-gray-500"><Target size={10} /><span>Cible : {currentAccount?.default_rr || 2}</span></div>
                                        </div>
                                    </div>

                                    <div className={inputContainerClass + " mt-4"}>
                                        <label className={labelClass}>Tags / Stratégie</label>
                                        <input type="text" name="tags" placeholder="Ex: Scalping, News, Gold..." value={formData.tags} onChange={handleChange} className={inputClass} />
                                    </div>
                                </div>

                                <hr className="border-gray-200 dark:border-neutral-800" />

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className={inputContainerClass}><label className={labelClass}>Commission ($)</label><input type="number" name="fees" placeholder="0.00" value={formData.fees} onChange={handleChange} className={inputClass} step="0.01" /><p className="text-[9px] text-gray-400 mt-1 ml-1">Déduit automatiquement</p></div>
                                    <div className="md:col-span-2">
                                        <div className="flex justify-between items-center mb-1"><div className="flex items-center gap-2"><label className={labelClass}>Profit Net ({currencySymbol})</label>{currentBalance > 0 && formData.profit && (<span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${parseFloat(formData.profit) >= 0 ? 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400' : 'bg-rose-100 text-rose-600 dark:bg-rose-900/30 dark:text-rose-400'}`}>{parseFloat(formData.profit) > 0 ? '+' : ''}{((parseFloat(formData.profit) / currentBalance) * 100).toFixed(2)}%</span>)}{currentBalance > 0 && <span className="text-[9px] text-gray-400">(Solde: {currentBalance}{currencySymbol})</span>}</div><div className="flex items-center gap-2"><span className="text-[10px] text-gray-400 truncate max-w-[150px]">{calcStatus}</span><button type="button" onClick={() => setAutoCalculate(!autoCalculate)} className={`text-[10px] flex items-center gap-1 font-bold px-2 py-1 rounded-md transition-colors ${autoCalculate ? 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400' : 'bg-gray-100 text-gray-500 dark:bg-neutral-800'}`}><RefreshCw size={10} className={autoCalculate ? "animate-spin-slow" : ""} /> {autoCalculate ? 'Auto' : 'Manuel'}</button></div></div>
                                        <input type="number" name="profit" placeholder="0.00" value={formData.profit} onChange={(e) => { setFormData({...formData, profit: e.target.value}); setAutoCalculate(false); }} className={`w-full bg-transparent text-3xl font-bold outline-none mt-1 ${parseFloat(formData.profit) >= 0 ? 'text-emerald-500' : 'text-rose-500'} placeholder-gray-300 dark:placeholder-gray-600`} />
                                    </div>
                                </div>
                            </>
                        )}
                        {mode === 'transfer' && (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="grid grid-cols-2 gap-4"><button type="button" onClick={() => setTransferData({...transferData, type: 'DEPOSIT'})} className={`p-4 rounded-2xl border-2 transition-all flex flex-col items-center justify-center gap-2 ${transferData.type === 'DEPOSIT' ? 'border-emerald-500 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400' : 'border-gray-200 dark:border-neutral-700 text-gray-500'}`}><Wallet size={24} /> <span className="font-bold">Dépôt</span></button><button type="button" onClick={() => setTransferData({...transferData, type: 'WITHDRAWAL'})} className={`p-4 rounded-2xl border-2 transition-all flex flex-col items-center justify-center gap-2 ${transferData.type === 'WITHDRAWAL' ? 'border-rose-500 bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400' : 'border-gray-200 dark:border-neutral-700 text-gray-500'}`}><ArrowRightLeft size={24} /> <span className="font-bold">Retrait</span></button></div>
                                <div className={inputContainerClass}><label className={labelClass}>Date</label><input type="date" value={transferData.date} onChange={(e) => setTransferData({...transferData, date: e.target.value})} className={`${inputClass} dark:[color-scheme:dark] min-w-0 w-full`} /></div>
                                <div className={inputContainerClass}><label className={labelClass}>Montant ({currencySymbol})</label><input type="number" placeholder="0.00" value={transferData.amount} onChange={(e) => setTransferData({...transferData, amount: e.target.value})} className={`${inputClass} text-2xl font-bold`} /></div>
                            </div>
                        )}
                        <div className="pt-4 flex flex-col-reverse md:flex-row justify-end gap-3 border-t border-gray-200 dark:border-neutral-800"><button type="button" onClick={onClose} className="w-full md:w-auto px-6 py-3 rounded-xl font-medium text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-neutral-800 transition-colors text-center">Annuler</button><button type="submit" className="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 flex items-center justify-center gap-2">{tradeToEdit ? <Save size={18} /> : <PlusCircle size={18} />}{tradeToEdit ? 'Mettre à jour' : 'Valider'}</button></div>
                    </form>
                </div>
            </div>
        </div>
    );
};

export default TradeForm;

=== src/components/Auth.jsx ===
import React, { useState, useEffect, useRef } from 'react';
import { api } from '../api';
import { Lock, Mail, LogIn, UserPlus, AlertCircle, User, CheckCircle, ArrowLeft } from 'lucide-react';

const Auth = ({ onLoginSuccess, initialSignUp }) => {
    const [loading, setLoading] = useState(false);
    const [isSignUp, setIsSignUp] = useState(initialSignUp);
    const [error, setError] = useState('');

    // --- NOUVEAU STATE POUR LA VÉRIFICATION ---
    const [verificationStep, setVerificationStep] = useState(false);
    const [verificationCode, setVerificationCode] = useState(['', '', '', '', '', '']); // Tableau pour 6 chiffres
    const inputRefs = useRef([]);

    // Champs du formulaire
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [firstName, setFirstName] = useState('');
    const [lastName, setLastName] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');

    const handleAuth = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            if (isSignUp) {
                // --- LOGIQUE INSCRIPTION ---
                if (password !== confirmPassword) throw new Error("Les mots de passe ne correspondent pas.");
                if (password.length < 6) throw new Error("Mot de passe trop court.");

                const data = await api.register(email, password, firstName, lastName);

                if (data.error) throw new Error(data.error);

                // Si l'API nous dit que la vérif est requise
                if (data.requiresVerification) {
                    setVerificationStep(true); // On passe à l'écran de code
                    setLoading(false);
                    return; // On arrête là, on attend le code
                }
            } else {
                // --- LOGIQUE LOGIN ---
                const data = await api.login(email, password);
                if (data.error) throw new Error(data.error);

                api.setToken(data.token);
                api.setUser(data.user);
                onLoginSuccess(data.user);
            }
        } catch (err) {
            setError(err.message);
            setLoading(false);
        }
    };

    // --- GESTION DU CODE OTP ---
    const handleCodeChange = (index, value) => {
        if (isNaN(value)) return;
        const newCode = [...verificationCode];
        newCode[index] = value;
        setVerificationCode(newCode);

        // Focus automatique case suivante
        if (value && index < 5) {
            inputRefs.current[index + 1].focus();
        }
    };

    const handleKeyDown = (index, e) => {
        // Retour arrière : Focus case précédente
        if (e.key === 'Backspace' && !verificationCode[index] && index > 0) {
            inputRefs.current[index - 1].focus();
        }
    };

    const handleVerifySubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);
        const codeString = verificationCode.join('');

        try {
            const data = await api.verifyEmail(email, codeString);
            if (data.error) throw new Error(data.error);

            // Succès : On connecte l'utilisateur
            api.setToken(data.token);
            api.setUser(data.user);
            onLoginSuccess(data.user);
        } catch (err) {
            setError(err.message || "Code invalide");
            setLoading(false);
        }
    };

    // Revenir pour corriger l'email (Réinitialise la vue vérification mais garde les champs remplis)
    const handleBackToEdit = () => {
        setVerificationStep(false);
        setError(null);
        setVerificationCode(['', '', '', '', '', '']);
    };

    const inputClass = "w-full bg-white/50 dark:bg-neutral-950/50 border border-gray-200 dark:border-neutral-800 text-gray-900 dark:text-white px-4 py-3 pl-10 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all placeholder:text-gray-400";

    useEffect(() => {
        const sessionMsg = localStorage.getItem('auth_message');
        if (sessionMsg) { setError(sessionMsg); localStorage.removeItem('auth_message'); }
    }, []);

    return (
        <div className="flex items-center justify-center min-h-[80vh]">
            <div className="w-full max-w-md bg-white/80 dark:bg-neutral-900/80 backdrop-blur-xl p-8 rounded-3xl border border-white/20 shadow-2xl animate-in fade-in zoom-in duration-500 relative">

                {/* --- HEADER --- */}
                <div className="text-center mb-8">
                    <div className="inline-flex p-3 rounded-full bg-indigo-100 dark:bg-indigo-900/30 mb-4 text-indigo-600 dark:text-indigo-400">
                        {verificationStep ? <CheckCircle size={32}/> : (isSignUp ? <UserPlus size={32} /> : <LogIn size={32} />)}
                    </div>
                    <h1 className="text-3xl font-black text-gray-900 dark:text-white tracking-tight">
                        {verificationStep ? 'Vérification' : (isSignUp ? 'Créer un compte' : 'Bon retour')}
                    </h1>
                    <p className="text-gray-500 dark:text-gray-400 mt-2 text-sm">
                        {verificationStep
                            ? `Un code a été envoyé à ${email}`
                            : (isSignUp ? 'Rejoignez FollowTrade et suivez vos performances' : 'Connectez-vous pour accéder à votre journal')}
                    </p>
                </div>

                {error && (
                    <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl flex items-center gap-3 text-red-600 dark:text-red-400 animate-pulse">
                        <AlertCircle size={20} />
                        <span className="text-sm font-medium">{error}</span>
                    </div>
                )}

                {/* --- VUE VÉRIFICATION (CODE) --- */}
                {verificationStep ? (
                    <form onSubmit={handleVerifySubmit} className="space-y-6 animate-in slide-in-from-right duration-300">
                        <div className="flex justify-center gap-2">
                            {verificationCode.map((digit, idx) => (
                                <input
                                    key={idx}
                                    ref={el => inputRefs.current[idx] = el}
                                    type="text"
                                    maxLength="1"
                                    value={digit}
                                    onChange={(e) => handleCodeChange(idx, e.target.value)}
                                    onKeyDown={(e) => handleKeyDown(idx, e)}
                                    className="w-12 h-12 text-center text-xl font-bold bg-white dark:bg-black border border-gray-300 dark:border-neutral-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900 dark:text-white outline-none transition-all"
                                />
                            ))}
                        </div>

                        <button disabled={loading} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2">
                            {loading ? 'Validation...' : 'Valider le compte'}
                        </button>

                        <div className="text-center pt-2">
                            <button type="button" onClick={handleBackToEdit} className="text-sm text-gray-500 hover:text-gray-900 dark:hover:text-white flex items-center justify-center gap-2 mx-auto transition-colors">
                                <ArrowLeft size={16}/> Je me suis trompé d'email
                            </button>
                        </div>
                    </form>
                ) : (
                    /* --- VUE NORMALE (LOGIN / REGISTER) --- */
                    <form onSubmit={handleAuth} className="space-y-4">
                        {isSignUp && (
                            <div className="grid grid-cols-2 gap-4 animate-in slide-in-from-top-2 fade-in duration-300">
                                <div className="relative"><User className="absolute left-3 top-3.5 text-gray-400" size={18} /><input type="text" placeholder="Prénom" value={firstName} onChange={(e) => setFirstName(e.target.value)} className={inputClass} required /></div>
                                <div className="relative"><User className="absolute left-3 top-3.5 text-gray-400" size={18} /><input type="text" placeholder="Nom" value={lastName} onChange={(e) => setLastName(e.target.value)} className={inputClass} required /></div>
                            </div>
                        )}

                        <div className="relative"><Mail className="absolute left-3 top-3.5 text-gray-400" size={18} /><input type="email" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} className={inputClass} required /></div>
                        <div className="relative"><Lock className="absolute left-3 top-3.5 text-gray-400" size={18} /><input type="password" placeholder="Mot de passe" value={password} onChange={(e) => setPassword(e.target.value)} className={inputClass} required /></div>

                        {isSignUp && (
                            <div className="relative animate-in slide-in-from-top-2 fade-in duration-300"><Lock className="absolute left-3 top-3.5 text-gray-400" size={18} /><input type="password" placeholder="Confirmer mot de passe" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className={`${inputClass} ${confirmPassword && password !== confirmPassword ? 'border-red-500 focus:ring-red-500' : ''}`} required /></div>
                        )}

                        <button disabled={loading} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-indigo-500/30 flex items-center justify-center gap-2 disabled:opacity-50 mt-2">
                            {loading ? 'Chargement...' : isSignUp ? <><UserPlus size={18} /> S'inscrire</> : <><LogIn size={18} /> Se connecter</>}
                        </button>
                    </form>
                )}

                {!verificationStep && (
                    <div className="mt-6 text-center">
                        <button onClick={() => { setIsSignUp(!isSignUp); setError(null); }} className="text-sm text-indigo-600 dark:text-indigo-400 hover:underline font-medium">
                            {isSignUp ? "Déjà un compte ? Se connecter" : "Pas de compte ? S'inscrire"}
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
};

export default Auth;

=== src/components/AlertPopup.jsx ===
import React from 'react';
import { Sparkles, Crown, ShieldAlert, User, CheckCircle2 } from 'lucide-react';

const AlertPopup = ({ notification, onClose }) => {
    if (!notification) return null;

    const getTheme = (msg) => {
        const text = msg.toLowerCase();

        // STYLE COMMUN VIOLET (Demandé)
        const purpleBadgeStyle = {
            iconColor: 'text-purple-600 dark:text-purple-300',
            badgeBg: 'bg-purple-100 text-purple-600 border-purple-200 dark:bg-purple-500/20 dark:text-purple-300 dark:border-purple-500/30',
        };

        // VIP (Visuel Vert, Badge Violet)
        if (text.includes("vip")) return {
            type: 'VIP',
            gradient: 'from-emerald-500 to-teal-600',
            icon: Sparkles,
            ...purpleBadgeStyle,
            title: 'Nouveau Grade Débloqué !'
        };

        // PRO (Visuel Or, Badge Violet)
        if (text.includes("pro")) return {
            type: 'PRO',
            gradient: 'from-amber-400 to-orange-500',
            icon: Crown,
            ...purpleBadgeStyle,
            title: 'Upgrade Réussi !'
        };

        // ADMIN (Visuel Rouge/Violet, Badge Violet)
        if (text.includes("administrateur") || text.includes("admin")) return {
            type: 'ADMIN',
            gradient: 'from-fuchsia-500 to-purple-600',
            icon: ShieldAlert,
            ...purpleBadgeStyle,
            title: 'Droits Administrateur'
        };

        // FREE (Visuel Gris, Badge Violet)
        if (text.includes("free") || text.includes("standard")) return {
            type: 'FREE',
            gradient: 'from-gray-400 to-slate-500',
            icon: User,
            ...purpleBadgeStyle,
            title: 'Changement de Statut'
        };

        // DÉFAUT
        return {
            type: 'INFO',
            gradient: 'from-indigo-500 to-blue-600',
            icon: CheckCircle2,
            iconColor: 'text-indigo-600 dark:text-indigo-400',
            badgeBg: 'bg-indigo-50 text-indigo-700 border-indigo-100 dark:bg-indigo-900/50 dark:text-indigo-200 dark:border-indigo-800',
            title: 'Information'
        };
    };

    const theme = getTheme(notification.message);
    const Icon = theme.icon;

    return (
        <div className="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-black/80 backdrop-blur-md animate-in fade-in duration-300">
            <div className="bg-white dark:bg-neutral-900 w-full max-w-sm rounded-3xl shadow-2xl border border-white/20 dark:border-neutral-700 overflow-hidden relative animate-in zoom-in-95 duration-300">

                {/* Header Visuel */}
                <div className={`h-36 bg-gradient-to-br ${theme.gradient} relative flex items-center justify-center`}>
                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-30"></div>
                    <div className="w-20 h-20 bg-white dark:bg-neutral-800 rounded-full shadow-2xl flex items-center justify-center transform translate-y-8 animate-bounce ring-4 ring-white/20 dark:ring-black/20">
                        <Icon size={40} className={theme.iconColor} />
                    </div>
                </div>

                <div className="px-8 pt-12 pb-8 text-center">
                    <div className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold border mb-5 uppercase tracking-wider shadow-sm ${theme.badgeBg}`}>
                        <Icon size={14} fill="currentColor" /> {theme.type}
                    </div>

                    <h2 className="text-2xl font-black text-gray-900 dark:text-white mb-3 tracking-tight">
                        {theme.title}
                    </h2>

                    <p className="text-gray-600 dark:text-gray-400 text-sm leading-relaxed mb-8 font-medium">
                        {notification.message}
                    </p>

                    <button onClick={() => onClose(notification.id)} className={`w-full py-3.5 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/20 transition-all active:scale-95 bg-gradient-to-r ${theme.gradient} hover:brightness-110`}>
                        C'est noté !
                    </button>
                </div>
            </div>
        </div>
    );
};

export default AlertPopup;

=== src/components/SettingsView.jsx ===
import React, { useState, useRef, useEffect } from 'react';
import { User, Lock, Mail, Save, AlertTriangle, Sliders, Eye, Layout, CheckCircle, ChevronDown, Check, DollarSign, Euro, PoundSterling, ArrowLeft, Camera, LogOut, ShieldAlert, PaintBucket, RotateCcw, Crown, Sparkles, CheckSquare, CreditCard, ExternalLink } from 'lucide-react';
import { api } from '../api';

const CURRENCIES = [
    { code: 'USD', name: 'US Dollar', icon: DollarSign },
    { code: 'EUR', name: 'Euro', icon: Euro },
    { code: 'GBP', name: 'British Pound', icon: PoundSterling },
];

const DEFAULT_COLORS = { balance: '#4f46e5', buy: '#2563eb', sell: '#ea580c', win: '#10b981', loss: '#f43f5e' };

const PLANS = [
    { id: 0, name: 'Free', icon: User, color: 'bg-gray-500', price: 'Gratuit', features: ['Journal de base', 'Publicités'], disabled: false },
    { id: 1, name: 'PRO', icon: Crown, color: 'bg-amber-500', price: 'Bientôt disponible', features: ['Couleurs perso', 'Zéro Pubs', 'Support Prio'], disabled: true, badge: 'Bientôt' },
    { id: 2, name: 'VIP', icon: Sparkles, color: 'bg-emerald-500', price: 'Sur demande', features: ['Accès Calendrier', 'Analyses Graphiques', 'Thèmes & Couleurs'], disabled: false, action: 'TELEGRAM' },
];

const SettingsView = ({ user, onUpdateUser, onClose, onLogout, onNavigate }) => {
    const BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';
    const TELEGRAM_LINK = "https://t.me/Sohan_Birotheau";

    const [formData, setFormData] = useState({
        first_name: '', last_name: '', email: '', password: '', confirmPassword: '',
        default_risk: 1.0, defaultView: 'journal', showImages: true, currency: 'USD',
        colors: DEFAULT_COLORS, is_pro: 0
    });

    const [avatarUrl, setAvatarUrl] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [message, setMessage] = useState(null);
    const [isCurrencyOpen, setIsCurrencyOpen] = useState(false);
    const [isDirty, setIsDirty] = useState(false);

    // État pour le scroll
    const [isScrolled, setIsScrolled] = useState(false);

    const fileInputRef = useRef(null);
    const currencyDropdownRef = useRef(null);

    useEffect(() => {
        if (user) {
            setFormData({
                first_name: user.first_name || '', last_name: user.last_name || '', email: user.email || '',
                password: '', confirmPassword: '', default_risk: user.default_risk || 1.0,
                defaultView: user.preferences?.defaultView || 'journal', showImages: user.preferences?.showImages !== false,
                currency: user.preferences?.currency || 'USD', colors: user.colors || DEFAULT_COLORS, is_pro: user.is_pro || 0
            });
            setAvatarUrl(user.avatar_url || '');
        }
    }, [user]);

    // DÉTECTION DU SCROLL (Pour l'effet de flou)
    useEffect(() => {
        const handleScroll = (e) => {
            // On utilise window ou l'élément cible selon le cas, ici on capture tout
            const scrollTop = window.scrollY || e.target.scrollTop || 0;
            setIsScrolled(scrollTop > 20); // Se déclenche après 20px de descente
        };
        // 'true' active la capture, utile si c'est une div interne qui scroll
        window.addEventListener('scroll', handleScroll, true);
        return () => window.removeEventListener('scroll', handleScroll, true);
    }, []);

    useEffect(() => {
        function handleClickOutside(event) {
            if (currencyDropdownRef.current && !currencyDropdownRef.current.contains(event.target)) setIsCurrencyOpen(false);
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const markAsDirty = () => setIsDirty(true);

    const handleChange = (e) => {
        setFormData(prev => ({ ...prev, [e.target.name]: e.target.type === 'checkbox' ? e.target.checked : e.target.value }));
        markAsDirty();
    };

    const handleColorChange = (key, color) => {
        setFormData(prev => ({ ...prev, colors: { ...prev.colors, [key]: color } }));
        markAsDirty();
    };

    const handlePlanClick = (plan) => {
        if (plan.disabled) return;
        if (plan.action === 'TELEGRAM') { window.open(TELEGRAM_LINK, '_blank'); return; }
    };

    const handleFileChange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setAvatarUrl(URL.createObjectURL(file));
        try {
            const res = await api.uploadAvatar(file);
            if (res.avatar_url) {
                const updatedUser = { ...user, avatar_url: res.avatar_url };
                api.setUser(updatedUser); onUpdateUser(updatedUser);
                setMessage({ type: 'success', text: "Photo mise à jour" });
            }
        } catch (error) { setMessage({ type: 'error', text: "Erreur upload" }); }
    };

    const handleSubmit = async (e) => {
        e.preventDefault(); setIsLoading(true); setMessage(null);
        if (formData.password && formData.password !== formData.confirmPassword) { setMessage({ type: 'error', text: "Mots de passe différents." }); setIsLoading(false); return; }
        try {
            const { confirmPassword, ...dataToSend } = formData;
            if (!dataToSend.password) delete dataToSend.password;
            const preferences = { defaultView: dataToSend.defaultView, showImages: dataToSend.showImages, currency: dataToSend.currency };
            await onUpdateUser({ ...dataToSend, preferences, colors: dataToSend.colors });
            setMessage({ type: 'success', text: "Paramètres sauvegardés !" });
            setFormData(prev => ({ ...prev, password: '', confirmPassword: '' }));
            setIsDirty(false);
            setTimeout(() => setMessage(null), 3000);
        } catch (error) { setMessage({ type: 'error', text: "Erreur sauvegarde." }); } finally { setIsLoading(false); }
    };

    const resetColors = () => { setFormData(prev => ({ ...prev, colors: DEFAULT_COLORS })); markAsDirty(); };

    // Styles
    const sectionClass = "bg-white/60 dark:bg-neutral-900/60 backdrop-blur-xl rounded-3xl p-6 md:p-8 border border-white/20 dark:border-white/5 shadow-sm mb-8";
    const labelClass = "block text-[11px] font-bold text-gray-400 dark:text-neutral-500 uppercase tracking-wider mb-2 ml-1";
    const inputClass = "w-full bg-white dark:bg-neutral-950 border border-gray-100 dark:border-neutral-800 text-gray-900 dark:text-white px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all placeholder:text-gray-300 dark:placeholder:text-neutral-700 font-medium";
    const colorInputWrapper = "flex flex-col gap-2 p-3 rounded-2xl bg-white/50 dark:bg-neutral-950/50 border border-gray-100 dark:border-neutral-800 transition-colors";
    const currentCurrency = CURRENCIES.find(c => c.code === formData.currency) || CURRENCIES[0];
    const CurrencyIcon = currentCurrency.icon;
    let displayAvatar = null;
    if (avatarUrl) displayAvatar = (avatarUrl.startsWith('blob:') || avatarUrl.startsWith('http')) ? avatarUrl : `${BASE_URL}${avatarUrl}`;

    const renderColorInput = (label, key) => (
        <div className={colorInputWrapper}>
            <label className={labelClass}>{label}</label>
            <div className="flex items-center gap-3">
                <div className="relative w-8 h-8 rounded-full border border-gray-200 dark:border-neutral-700 shadow-sm overflow-hidden hover:scale-110 transition-transform cursor-pointer">
                    <div className="absolute inset-0 pointer-events-none" style={{backgroundColor: formData.colors[key]}}></div>
                    <input type="color" value={formData.colors[key]} onChange={(e) => handleColorChange(key, e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                </div>
                <span className="text-xs font-mono text-gray-600 dark:text-gray-400 uppercase">{formData.colors[key]}</span>
            </div>
        </div>
    );

    return (
        <div className="max-w-3xl mx-auto pb-32 animate-in fade-in slide-in-from-bottom-4 duration-300 relative">

            {/* --- HEADER STICKY (CORRIGÉ) --- */}
            <div className={`
                z-40 flex items-center justify-between mb-8
                /* CORRECTION ICI : On utilise -top-4 (mobile) et -top-8 (pc) pour compenser les marges négatives */
                -top-4 -mt-4 -mx-4 px-4 py-4 
                md:-top-8 md:-mt-8 md:-mx-8 md:px-8 md:py-6
                transition-all duration-300 ease-in-out
                ${isScrolled
                ? 'bg-white/70 dark:bg-black/70 backdrop-blur-xl shadow-lg shadow-black/5 border-b border-gray-200/50 dark:border-neutral-800/50'
                : 'bg-transparent border-b border-transparent'}
            `}>
                <div className="flex items-center gap-4">
                    <button onClick={onClose} className={`p-2.5 rounded-full text-gray-700 dark:text-gray-200 border hover:scale-105 transition-all ${isScrolled ? 'bg-white/50 dark:bg-neutral-800/50 border-gray-200 dark:border-neutral-700' : 'bg-white dark:bg-neutral-900 border-gray-200 dark:border-neutral-800 shadow-sm'}`}>
                        <ArrowLeft size={20} />
                    </button>
                    <div><h2 className="text-xl md:text-2xl font-black text-gray-900 dark:text-white transition-opacity">Paramètres</h2></div>
                </div>
            </div>

            {message && (<div className={`mb-8 p-4 rounded-2xl flex items-center gap-3 animate-in fade-in slide-in-from-top-4 ${message.type === 'error' ? 'bg-red-500/10 text-red-500 border border-red-500/20' : 'bg-emerald-500/10 text-emerald-500 border border-emerald-500/20'}`}>{message.type === 'error' ? <AlertTriangle size={20} /> : <CheckCircle size={20} />}<span className="font-bold text-sm">{message.text}</span></div>)}

            <form onSubmit={handleSubmit}>
                {/* 1. PROFIL */}
                <section className={sectionClass}>
                    <div className="flex items-center gap-2 mb-6 border-b border-gray-100 dark:border-neutral-800 pb-4"><User size={20} className="text-indigo-500" /><h3 className="text-lg font-bold text-gray-900 dark:text-white">Profil & Sécurité</h3></div>
                    <div className="flex flex-col md:flex-row gap-8">
                        <div className="flex flex-col items-center justify-start pt-2">
                            <div className="relative group">
                                <div className="w-28 h-28 rounded-full overflow-hidden border-4 border-white dark:border-neutral-800 shadow-2xl bg-gray-100 dark:bg-neutral-800 flex items-center justify-center">{displayAvatar ? <img src={displayAvatar} alt="Profile" className="w-full h-full object-cover" /> : <User size={40} className="text-gray-400" />}</div>
                                <button type="button" onClick={() => fileInputRef.current?.click()} className="absolute bottom-0 right-0 p-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-lg transition-transform hover:scale-110 border-4 border-white dark:border-black"><Camera size={16} /></button>
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept="image/*" />
                            </div>
                        </div>
                        <div className="flex-1 space-y-5">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-5"><div><label className={labelClass}>Prénom</label><input type="text" name="first_name" value={formData.first_name} onChange={handleChange} className={inputClass} /></div><div><label className={labelClass}>Nom</label><input type="text" name="last_name" value={formData.last_name} onChange={handleChange} className={inputClass} /></div></div>
                            <div><label className={labelClass}>Email</label><div className="relative"><Mail className="absolute left-4 top-3.5 text-gray-400" size={18} /><input type="email" name="email" value={formData.email} onChange={handleChange} className={`${inputClass} pl-11`} /></div></div>
                            <div className="pt-4 border-t border-gray-100 dark:border-neutral-800/50 mt-4"><div className="grid grid-cols-1 md:grid-cols-2 gap-5"><div><label className={labelClass}>Nouveau mot de passe</label><div className="relative"><Lock className="absolute left-4 top-3.5 text-gray-400" size={18} /><input type="password" name="password" value={formData.password} onChange={handleChange} className={`${inputClass} pl-11`} placeholder="••••••••" /></div></div><div><label className={labelClass}>Confirmer</label><div className="relative"><Check className="absolute left-4 top-3.5 text-gray-400" size={18} /><input type="password" name="confirmPassword" value={formData.confirmPassword} onChange={handleChange} className={`${inputClass} pl-11`} placeholder="••••••••" /></div></div></div></div>
                        </div>
                    </div>
                </section>

                {/* 2. PRÉFÉRENCES */}
                <section className={sectionClass}>
                    <div className="flex items-center gap-2 mb-6 border-b border-gray-100 dark:border-neutral-800 pb-4"><Sliders size={20} className="text-indigo-500" /><h3 className="text-lg font-bold text-gray-900 dark:text-white">Préférences</h3></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label className={labelClass}>Risque par défaut</label><div className="relative"><input type="number" step="0.1" name="default_risk" value={formData.default_risk} onChange={handleChange} className={`${inputClass} pr-12`} /><span className="absolute right-4 top-3.5 text-gray-400 font-bold text-sm">%</span></div></div>
                        <div ref={currencyDropdownRef} className="relative">
                            <label className={labelClass}>Devise du compte</label>
                            <button type="button" onClick={() => setIsCurrencyOpen(!isCurrencyOpen)} className={`${inputClass} flex items-center justify-between text-left`}><div className="flex items-center gap-2"><div className="w-6 h-6 rounded-full bg-gray-100 dark:bg-neutral-800 flex items-center justify-center text-gray-600 dark:text-gray-300"><CurrencyIcon size={14} /></div><span>{currentCurrency.code}</span></div><ChevronDown size={16} className={`text-gray-400 transition-transform ${isCurrencyOpen ? 'rotate-180' : ''}`} /></button>
                            {isCurrencyOpen && <div className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-neutral-900 border border-gray-100 dark:border-neutral-800 rounded-xl shadow-xl z-20 overflow-hidden animate-in zoom-in-95 duration-200">{CURRENCIES.map((curr) => { const Icon = curr.icon; return (<button key={curr.code} type="button" onClick={() => { setFormData(prev => ({ ...prev, currency: curr.code })); setIsCurrencyOpen(false); markAsDirty(); }} className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-neutral-800 transition-colors"><div className="flex items-center gap-3"><div className="w-6 h-6 rounded-full bg-gray-100 dark:bg-neutral-800 flex items-center justify-center text-gray-600 dark:text-gray-300"><Icon size={12} /></div><span className="font-bold text-gray-700 dark:text-gray-300 text-sm">{curr.code}</span></div>{formData.currency === curr.code && <Check size={16} className="text-indigo-600" />}</button>); })}</div>}
                        </div>
                    </div>
                    <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-neutral-950/30 rounded-2xl border border-gray-100 dark:border-neutral-800"><div className="flex items-center gap-3"><div className="p-2 bg-white dark:bg-neutral-900 rounded-lg text-gray-500 shadow-sm"><Layout size={18} /></div><span className="font-bold text-sm text-gray-700 dark:text-gray-300">Vue par défaut</span></div><select name="defaultView" value={formData.defaultView} onChange={handleChange} className="bg-transparent text-sm font-bold text-indigo-600 outline-none cursor-pointer text-right"><option value="journal">Journal</option><option value="calendar">Calendrier</option><option value="calculator">Calculatrice</option></select></div>
                        <div onClick={() => { setFormData(prev => ({ ...prev, showImages: !prev.showImages })); markAsDirty(); }} className="flex items-center justify-between p-4 bg-gray-50 dark:bg-neutral-950/30 rounded-2xl border border-gray-100 dark:border-neutral-800 cursor-pointer group"><div className="flex items-center gap-3"><div className="p-2 bg-white dark:bg-neutral-900 rounded-lg text-gray-500 shadow-sm"><Eye size={18} /></div><span className="font-bold text-sm text-gray-700 dark:text-gray-300">Logos des paires</span></div><div className={`w-10 h-6 flex items-center rounded-full p-1 transition-colors duration-300 ${formData.showImages ? 'bg-indigo-600' : 'bg-gray-300 dark:bg-neutral-700'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-300 ${formData.showImages ? 'translate-x-4' : 'translate-x-0'}`}></div></div></div>
                    </div>
                </section>

                {/* 3. COULEURS */}
                <section className={`${sectionClass} ${formData.is_pro < 1 ? 'opacity-50 grayscale select-none pointer-events-none' : ''} relative`}>
                    {formData.is_pro < 1 && (<div className="absolute inset-0 z-10 flex items-center justify-center bg-white/10 backdrop-blur-[1px] rounded-3xl"><div className="bg-white dark:bg-neutral-900 px-6 py-3 rounded-full shadow-2xl border border-amber-200 dark:border-neutral-700 flex items-center gap-2"><Lock size={16} className="text-amber-500" /><span className="text-xs font-bold text-gray-900 dark:text-white">Réservé aux membres PRO</span></div></div>)}
                    <div className="flex items-center justify-between mb-6 border-b border-gray-100 dark:border-neutral-800 pb-4"><div className="flex items-center gap-2"><PaintBucket size={20} className="text-indigo-500" /><h3 className="text-lg font-bold text-gray-900 dark:text-white">Thème Personnalisé</h3></div><button type="button" onClick={resetColors} className="text-xs flex items-center gap-1 text-gray-400 hover:text-indigo-500 font-bold transition-colors"><RotateCcw size={12}/> Rétablir</button></div>
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3">{renderColorInput("Solde", "balance")}{renderColorInput("Achat", "buy")}{renderColorInput("Vente", "sell")}{renderColorInput("Gain", "win")}{renderColorInput("Perte", "loss")}</div>
                </section>

                {/* 4. ABONNEMENT */}
                <section className={sectionClass + " border-l-4 border-l-indigo-500"}>
                    <div className="flex items-center gap-2 mb-6 border-b border-gray-100 dark:border-neutral-800 pb-4"><CreditCard size={20} className="text-indigo-500" /><h3 className="text-lg font-bold text-gray-900 dark:text-white">Mon Abonnement</h3></div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {PLANS.map((plan) => {
                            const isCurrent = formData.is_pro === plan.id;
                            const Icon = plan.icon;
                            const containerClass = `relative rounded-2xl p-4 border-2 transition-all flex flex-col justify-between h-full group ${isCurrent ? 'bg-white dark:bg-neutral-800 border-indigo-600 shadow-xl shadow-indigo-500/10 cursor-default' : ''} ${!isCurrent && !plan.disabled ? 'bg-transparent border-gray-200 dark:border-neutral-800 hover:border-indigo-300 dark:hover:border-neutral-700 hover:bg-gray-50 dark:hover:bg-neutral-800/50 cursor-pointer' : ''} ${plan.disabled && !isCurrent ? 'bg-gray-50 dark:bg-neutral-900 border-gray-100 dark:border-neutral-800 opacity-60 cursor-not-allowed' : ''}`;
                            return (
                                <div key={plan.id} onClick={() => handlePlanClick(plan)} className={containerClass}>
                                    {isCurrent && <div className="absolute -top-3 left-1/2 -translate-x-1/2 bg-indigo-600 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-md">ACTUEL</div>}
                                    {plan.badge && !isCurrent && <div className="absolute -top-3 left-1/2 -translate-x-1/2 bg-amber-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-md">{plan.badge}</div>}
                                    <div><div className={`w-10 h-10 rounded-full flex items-center justify-center mb-3 ${plan.id === 0 ? 'bg-gray-100 text-gray-500' : (plan.id === 1 ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600')}`}><Icon size={20} /></div><h4 className="text-lg font-black text-gray-900 dark:text-white mb-1">{plan.name}</h4><p className="text-xs font-bold text-gray-400 mb-4">{plan.price}</p><ul className="space-y-2 mb-4">{plan.features.map((f, i) => (<li key={i} className="flex items-center gap-2 text-[10px] font-bold text-gray-500 dark:text-gray-400"><CheckSquare size={12} className="text-indigo-500" /> {f}</li>))}</ul></div>
                                    <div className={`w-full py-2 rounded-xl text-center text-xs font-bold transition-colors flex items-center justify-center gap-2 ${isCurrent ? 'bg-indigo-600 text-white' : ''} ${!isCurrent && !plan.disabled ? 'bg-gray-100 dark:bg-neutral-800 text-gray-500 group-hover:bg-indigo-100 dark:group-hover:bg-indigo-900/30 group-hover:text-indigo-600' : ''} ${plan.disabled && !isCurrent ? 'bg-gray-100 dark:bg-neutral-800 text-gray-300' : ''}`}>{isCurrent ? 'Plan Actif' : (plan.disabled ? 'Indisponible' : (plan.action === 'TELEGRAM' ? <><ExternalLink size={12}/> Contacter</> : 'Choisir'))}</div>
                                </div>
                            );
                        })}
                    </div>
                    {user?.is_pro === 7 && <div className="mt-4 text-center"><button type="button" onClick={() => setFormData(prev => ({...prev, is_pro: 7}))} className="text-xs text-purple-500 font-bold hover:underline opacity-50 hover:opacity-100">Restaurer Grade Admin</button></div>}
                </section>

                <div className="pt-6 mt-8 border-t border-gray-200 dark:border-neutral-800 flex flex-col md:flex-row justify-between items-center gap-4">
                    <button type="button" onClick={onLogout} className="flex items-center gap-2 text-red-500 hover:text-red-600 font-bold text-sm px-4 py-2 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-xl transition-colors"><LogOut size={18} /> Déconnexion</button>
                    {user?.is_pro === 7 && <button type="button" onClick={() => onNavigate('admin')} className="flex items-center gap-2 text-purple-500 hover:text-purple-600 font-bold text-sm px-4 py-2 hover:bg-purple-50 dark:hover:bg-purple-900/10 rounded-xl transition-colors"><ShieldAlert size={18} /> Admin Panel</button>}
                </div>

            </form>

            {/* --- BOUTON DE SAUVEGARDE FLOTTANT (FAB) --- */}
            <div className={`fixed bottom-6 right-6 z-50 transition-all duration-300 transform ${isDirty ? 'translate-y-0 opacity-100' : 'translate-y-20 opacity-0 pointer-events-none'}`}>
                <button onClick={handleSubmit} disabled={isLoading} className="flex items-center gap-3 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-4 rounded-full font-bold shadow-2xl shadow-indigo-500/40 hover:shadow-indigo-500/60 active:scale-95 transition-all animate-in zoom-in-95 duration-200">
                    {isLoading ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : <Save size={20} />}<span>Enregistrer les modifications</span>
                </button>
            </div>

        </div>
    );
};

export default SettingsView;

=== src/components/PositionCalculator.jsx ===
import React, { useState, useEffect, useRef } from 'react';
import { createChart, ColorType, CandlestickSeries, BaselineSeries } from 'lightweight-charts';
import { Calculator, AlertCircle, Target, Wallet, ArrowDownToLine, ChevronDown, TrendingUp, Lock, Unlock } from 'lucide-react';

const API_SYMBOLS = {
    'EURUSD': 'EURUSDT',
    'GBPUSD': 'GBPUSDT',
    'USDJPY': 'USDJPY',
    'XAUUSD': 'PAXGUSDT',
    'BTCUSD': 'BTCUSDT',
    'ETHUSD': 'ETHUSDT',
};

const PAIRS = [
    { code: 'EURUSD', name: 'Euro / US Dollar', type: 'FOREX' },
    { code: 'GBPUSD', name: 'Great Britain Pound', type: 'FOREX' },
    { code: 'USDJPY', name: 'US Dollar / Yen', type: 'FOREX' },
    { code: 'XAUUSD', name: 'Gold', type: 'COMMODITY' },
    { code: 'BTCUSD', name: 'Bitcoin', type: 'CRYPTO' },
    { code: 'ETHUSD', name: 'Ethereum', type: 'CRYPTO' },
];

const TIMEFRAMES = [
    { label: '1m', value: '1m' },
    { label: '3m', value: '3m' },
    { label: '5m', value: '5m' },
    { label: '15m', value: '15m' },
    { label: '30m', value: '30m' },
    { label: '1h', value: '1h' },
    { label: '4h', value: '4h' },
    { label: '1j', value: '1d' },
];

// Helper HEX -> RGBA
const hexToRgba = (hex, alpha = 1) => {
    let c;
    if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
        c= hex.substring(1).split('');
        if(c.length=== 3){
            c= [c[0], c[0], c[1], c[1], c[2], c[2]];
        }
        c= '0x'+c.join('');
        return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
    }
    return `rgba(128,128,128,${alpha})`;
}

const PositionCalculator = ({ currentBalance, defaultRisk, currencySymbol = "$", colors }) => {
    // --- COULEURS DYNAMIQUES ---
    const themeColors = {
        win: colors?.win || '#10b981',
        loss: colors?.loss || '#ef4444',
        entry: colors?.buy || '#3b82f6',
        text: '#9CA3AF'
    };

    // --- STATES ---
    const [balance, setBalance] = useState(currentBalance || 10000);
    const [riskPercent, setRiskPercent] = useState(defaultRisk || 1.0);
    const [pair, setPair] = useState(PAIRS[0]);
    const [timeframe, setTimeframe] = useState('1h');

    // NOUVEAU : État pour le suivi automatique du prix
    const [isAutoEntry, setIsAutoEntry] = useState(true);

    const [isPairOpen, setIsPairOpen] = useState(false);
    const dropdownRef = useRef(null);

    // Inputs Prix
    const [entryPrice, setEntryPrice] = useState('');
    const [stopLoss, setStopLoss] = useState('');
    const [takeProfit, setTakeProfit] = useState('');

    // Data Store
    const [candleData, setCandleData] = useState([]);

    // Chart Refs
    const chartContainerRef = useRef();
    const chartInstance = useRef(null);
    const candlestickSeries = useRef(null);
    const tpSeriesRef = useRef(null);
    const slSeriesRef = useRef(null);

    const parseInput = (val) => parseFloat(val.toString().replace(',', '.')) || 0;

    // Reset auto entry quand on change de paire
    useEffect(() => {
        setIsAutoEntry(true);
        setStopLoss('');
        setTakeProfit('');
    }, [pair]);

    // --- 1. INITIALISATION DU GRAPHE ---
    useEffect(() => {
        if (!chartContainerRef.current) return;

        const chart = createChart(chartContainerRef.current, {
            layout: {
                background: { type: ColorType.Solid, color: 'transparent' },
                textColor: themeColors.text,
            },
            grid: {
                vertLines: { color: 'rgba(40, 40, 40, 0.1)' },
                horzLines: { color: 'rgba(40, 40, 40, 0.1)' },
            },
            width: chartContainerRef.current.clientWidth,
            height: 300,
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
            },
        });

        // A. Zone de Gain
        const tpSeries = chart.addSeries(BaselineSeries, {
            baseValue: { type: 'price', price: 0 },
            topFillColor1: hexToRgba(themeColors.win, 0.15),
            topFillColor2: hexToRgba(themeColors.win, 0.15),
            topLineColor: 'rgba(0,0,0,0)',
            bottomFillColor1: 'rgba(0,0,0,0)',
            bottomFillColor2: 'rgba(0,0,0,0)',
            bottomLineColor: 'rgba(0,0,0,0)',
        });

        // B. Zone de Perte
        const slSeries = chart.addSeries(BaselineSeries, {
            baseValue: { type: 'price', price: 0 },
            topFillColor1: 'rgba(0,0,0,0)',
            topFillColor2: 'rgba(0,0,0,0)',
            topLineColor: 'rgba(0,0,0,0)',
            bottomFillColor1: hexToRgba(themeColors.loss, 0.15),
            bottomFillColor2: hexToRgba(themeColors.loss, 0.15),
            bottomLineColor: 'rgba(0,0,0,0)',
        });

        // C. Bougies
        const candles = chart.addSeries(CandlestickSeries, {
            upColor: themeColors.win,
            downColor: themeColors.loss,
            borderVisible: false,
            wickUpColor: themeColors.win,
            wickDownColor: themeColors.loss,
        });

        chartInstance.current = chart;
        candlestickSeries.current = candles;
        tpSeriesRef.current = tpSeries;
        slSeriesRef.current = slSeries;

        const handleResize = () => {
            chart.applyOptions({ width: chartContainerRef.current.clientWidth });
        };
        window.addEventListener('resize', handleResize);

        return () => {
            window.removeEventListener('resize', handleResize);
            chart.remove();
        };
    }, []);

    // --- 1.5 MISE À JOUR DYNAMIQUE COULEURS ---
    useEffect(() => {
        if(!chartInstance.current) return;
        if(candlestickSeries.current) {
            candlestickSeries.current.applyOptions({
                upColor: themeColors.win, downColor: themeColors.loss,
                wickUpColor: themeColors.win, wickDownColor: themeColors.loss,
            });
        }
        if(tpSeriesRef.current) {
            tpSeriesRef.current.applyOptions({
                topFillColor1: hexToRgba(themeColors.win, 0.15),
                topFillColor2: hexToRgba(themeColors.win, 0.15),
            });
        }
        if(slSeriesRef.current) {
            slSeriesRef.current.applyOptions({
                bottomFillColor1: hexToRgba(themeColors.loss, 0.15),
                bottomFillColor2: hexToRgba(themeColors.loss, 0.15),
            });
        }
    }, [colors]);

    // --- 2. FETCH DONNÉES & AUTO UPDATE ---
    useEffect(() => {
        const fetchCandles = async () => {
            const symbol = API_SYMBOLS[pair.code];
            if (!symbol) return;

            try {
                const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${timeframe}&limit=200`);
                const data = await response.json();

                const candles = data.map(d => ({
                    time: d[0] / 1000,
                    open: parseFloat(d[1]),
                    high: parseFloat(d[2]),
                    low: parseFloat(d[3]),
                    close: parseFloat(d[4]),
                }));

                setCandleData(candles);

                if (candlestickSeries.current) {
                    candlestickSeries.current.setData(candles);

                    // --- LOGIQUE AUTO UPDATE ---
                    if (candles.length > 0) {
                        const currentPrice = candles[candles.length - 1].close;

                        // Si le mode auto est activé OU si le champ est vide
                        if (isAutoEntry || !entryPrice) {
                            setEntryPrice(currentPrice.toString());
                        }
                    }
                }
            } catch (error) {
                console.error("Erreur Fetch:", error);
            }
        };

        fetchCandles();
        // Mise à jour toutes les 2 secondes pour plus de fluidité si auto update
        const interval = setInterval(fetchCandles, 2000);
        return () => clearInterval(interval);

    }, [pair, timeframe, isAutoEntry]); // Ajout de isAutoEntry aux dépendances pour réagir au changement

    // --- 3. GESTION INPUT MANUEL ---
    const handleEntryChange = (e) => {
        setEntryPrice(e.target.value);
        setIsAutoEntry(false); // Désactive l'auto-update si l'utilisateur tape
    };

    // --- 4. MISE À JOUR DES LIGNES ---
    const entryLineRef = useRef(null);
    const slLineRef = useRef(null);
    const tpLineRef = useRef(null);

    useEffect(() => {
        const series = candlestickSeries.current;
        if (!series) return;

        const updateLine = (ref, price, color, title) => {
            const val = parseInput(price);
            if (val > 0) {
                const opts = { price: val, color: color, lineWidth: 2, lineStyle: 2, axisLabelVisible: true, title: title };
                if (ref.current) ref.current.applyOptions(opts);
                else ref.current = series.createPriceLine(opts);
            } else if (ref.current) {
                series.removePriceLine(ref.current);
                ref.current = null;
            }
        };

        updateLine(entryLineRef, entryPrice, themeColors.entry, 'ENTRÉE');
        updateLine(slLineRef, stopLoss, themeColors.loss, 'SL');
        updateLine(tpLineRef, takeProfit, themeColors.win, 'TP');

        const entryVal = parseInput(entryPrice);
        const slVal = parseInput(stopLoss);
        const tpVal = parseInput(takeProfit);

        if (tpSeriesRef.current && slSeriesRef.current && candleData.length > 0 && entryVal > 0) {
            const baseOptions = { baseValue: { type: 'price', price: entryVal } };
            tpSeriesRef.current.applyOptions(baseOptions);
            slSeriesRef.current.applyOptions(baseOptions);

            const tpData = candleData.map(c => ({ time: c.time, value: tpVal > 0 ? tpVal : entryVal }));
            const slData = candleData.map(c => ({ time: c.time, value: slVal > 0 ? slVal : entryVal }));

            tpSeriesRef.current.setData(tpData);
            slSeriesRef.current.setData(slData);
        }

    }, [entryPrice, stopLoss, takeProfit, candleData, colors]);

    // --- CALCULS ---
    const riskAmount = (parseInput(balance) * parseInput(riskPercent)) / 100;
    const entry = parseInput(entryPrice);
    const sl = parseInput(stopLoss);
    const tp = parseInput(takeProfit);

    let lotSize = 0;
    let rewardAmount = 0;
    let rrRatio = 0;

    if (entry > 0 && sl > 0) {
        const priceDistance = Math.abs(entry - sl);
        if (priceDistance > 0) {
            let units = 0;
            if (pair.code === 'USDJPY') units = (riskAmount * entry) / priceDistance;
            else units = riskAmount / priceDistance;

            if (pair.type === 'FOREX') lotSize = units / 100000;
            else if (pair.type === 'COMMODITY') lotSize = units / 100;
            else lotSize = units;

            if (tp > 0) {
                const profitDistance = Math.abs(tp - entry);
                const ratio = profitDistance / priceDistance;
                rewardAmount = riskAmount * ratio;
                rrRatio = ratio;
            }
        }
    }

    const formatLotSize = (size) => {
        if (!isFinite(size) || size <= 0) return "0.00";
        if (size < 0.1) return size.toFixed(4);
        if (size < 1) return size.toFixed(3);
        return size.toFixed(2);
    };

    const inputClass = "w-full bg-white/50 dark:bg-black/20 border border-gray-200 dark:border-neutral-700 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all dark:text-white placeholder-gray-400";
    const labelClass = "text-xs font-bold text-gray-500 dark:text-neutral-500 uppercase tracking-wider mb-2 block";

    return (
        <div className="bg-white/60 dark:bg-neutral-900/40 backdrop-blur-xl p-6 md:p-8 rounded-3xl shadow-xl border border-white/40 dark:border-white/5 max-w-4xl mx-auto animate-in fade-in slide-in-from-bottom-4 mb-20">

            <div className="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4">
                <h2 className="text-xl font-bold flex items-center text-indigo-900 dark:text-white">
                    <Calculator className="mr-3 text-indigo-500" size={24} /> Trading Companion
                </h2>
                <div className="flex bg-gray-100 dark:bg-neutral-800 p-1 rounded-lg overflow-x-auto max-w-full">
                    {TIMEFRAMES.map((tf) => (
                        <button
                            key={tf.value}
                            onClick={() => setTimeframe(tf.value)}
                            className={`px-3 py-1 text-xs font-bold rounded-md transition-all whitespace-nowrap ${
                                timeframe === tf.value
                                    ? 'bg-white dark:bg-neutral-600 text-indigo-600 dark:text-white shadow-sm'
                                    : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'
                            }`}
                        >
                            {tf.label}
                        </button>
                    ))}
                </div>
            </div>

            <div className="mb-8 bg-white dark:bg-black/20 rounded-2xl border border-gray-200 dark:border-neutral-800 overflow-hidden relative">
                <div className="absolute top-4 left-4 z-10 flex items-center gap-2">
                    <span className="font-bold text-lg dark:text-white">{pair.code}</span>
                    <span className="text-xs bg-gray-200 dark:bg-neutral-700 px-2 py-0.5 rounded text-gray-600 dark:text-gray-300">{timeframe}</span>
                </div>

                <div ref={chartContainerRef} className="w-full h-[300px]" />

                <div className="absolute bottom-2 right-2 flex gap-3 text-[10px] font-bold bg-white/80 dark:bg-black/60 px-2 py-1 rounded-lg backdrop-blur-sm z-20">
                    <span style={{color: themeColors.entry}}>ENTRY</span>
                    <span style={{color: themeColors.loss}}>SL</span>
                    <span style={{color: themeColors.win}}>TP</span>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label className={labelClass}>Capital</label>
                    <div className="relative">
                        <Wallet className="absolute left-3 top-3.5 text-gray-400" size={16} />
                        <input type="number" value={balance} onChange={(e) => setBalance(e.target.value)} className={`${inputClass} pl-10`} />
                    </div>
                </div>
                <div>
                    <label className={labelClass}>Risque %</label>
                    <div className="relative">
                        <AlertCircle className="absolute left-3 top-3.5 text-gray-400" size={16} />
                        <input type="number" step="0.1" value={riskPercent} onChange={(e) => setRiskPercent(e.target.value)} className={`${inputClass} pl-10`} />
                    </div>
                </div>
                <div ref={dropdownRef}>
                    <label className={labelClass}>Paire</label>
                    <div className="relative">
                        <button type="button" onClick={() => setIsPairOpen(!isPairOpen)} className={`${inputClass} flex items-center justify-between text-left h-[46px]`}>
                            <div className="flex items-center gap-3">
                                <span className="font-bold">{pair.code}</span>
                            </div>
                            <ChevronDown size={16} className={`text-gray-400 transition-transform ${isPairOpen ? 'rotate-180' : ''}`} />
                        </button>
                        {isPairOpen && (
                            <div className="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-neutral-800 rounded-xl shadow-xl z-50 p-1 max-h-60 overflow-y-auto">
                                {PAIRS.map((p) => (
                                    <button key={p.code} onClick={() => { setPair(p); setIsPairOpen(false); }} className="w-full flex items-center gap-3 px-3 py-2 hover:bg-indigo-50 dark:hover:bg-neutral-700 rounded-lg">
                                        <span className="text-sm font-bold dark:text-white">{p.code}</span>
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>

            <div className="h-px bg-gray-200 dark:bg-neutral-800 my-6"></div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div className="space-y-4 md:col-span-1">

                    {/* INPUT PRIX D'ENTRÉE AVEC LOCK */}
                    <div>
                        <div className="flex justify-between items-center mb-2">
                            <label className={labelClass.replace('mb-2', 'mb-0')}>Prix d'Entrée</label>
                            <button
                                onClick={() => setIsAutoEntry(!isAutoEntry)}
                                className={`text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 transition-all ${
                                    isAutoEntry
                                        ? 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400'
                                        : 'bg-gray-100 text-gray-500 dark:bg-neutral-800 dark:text-gray-400'
                                }`}
                            >
                                {isAutoEntry ? <Unlock size={10} /> : <Lock size={10} />}
                                {isAutoEntry ? 'AUTO' : 'MANUEL'}
                            </button>
                        </div>
                        <div className="relative">
                            <Target className="absolute left-3 top-3.5" style={{color: themeColors.entry}} size={16} />
                            <input
                                type="number"
                                placeholder="0.0000"
                                value={entryPrice}
                                onChange={handleEntryChange}
                                className={`${inputClass} pl-10 focus:ring-1 pr-10`}
                                style={{borderColor: themeColors.entry + '40'}}
                            />
                            {/* Petit indicateur visuel de live dans l'input */}
                            {isAutoEntry && (
                                <span className="absolute right-3 top-4 flex h-2 w-2">
                                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                                  <span className="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"></span>
                                </span>
                            )}
                        </div>
                    </div>

                    <div>
                        <label className={labelClass}>Stop Loss</label>
                        <div className="relative">
                            <ArrowDownToLine className="absolute left-3 top-3.5" style={{color: themeColors.loss}} size={16} />
                            <input type="number" placeholder="0.0000" value={stopLoss} onChange={(e) => setStopLoss(e.target.value)} className={`${inputClass} pl-10 focus:ring-1`} style={{borderColor: themeColors.loss + '40'}} />
                        </div>
                    </div>
                    <div>
                        <label className={labelClass}>Take Profit</label>
                        <div className="relative">
                            <TrendingUp className="absolute left-3 top-3.5" style={{color: themeColors.win}} size={16} />
                            <input type="number" placeholder="Optionnel" value={takeProfit} onChange={(e) => setTakeProfit(e.target.value)} className={`${inputClass} pl-10 focus:ring-1`} style={{borderColor: themeColors.win + '40'}} />
                        </div>
                    </div>
                </div>

                <div className="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div className="bg-gray-50 dark:bg-black/30 rounded-2xl p-6 border border-gray-100 dark:border-neutral-800 flex flex-col justify-center items-center text-center">
                        <span className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Taille Position</span>
                        <div className="text-4xl font-extrabold text-indigo-600 dark:text-indigo-400">
                            {formatLotSize(lotSize)}
                        </div>
                        <span className="text-xs font-bold text-gray-500 mt-1">
                             {pair.type === 'FOREX' ? 'LOTS' : pair.type === 'CRYPTO' ? pair.code.substring(0,3) : 'CONTRATS'}
                        </span>
                        <div className="mt-4 text-xs font-mono text-gray-400">
                            Risque: -{riskAmount.toFixed(2)} {currencySymbol}
                        </div>
                    </div>

                    <div className={`rounded-2xl p-6 border flex flex-col justify-center items-center text-center transition-colors`}
                         style={{
                             backgroundColor: tp > 0 ? hexToRgba(themeColors.win, 0.05) : '',
                             borderColor: tp > 0 ? hexToRgba(themeColors.win, 0.2) : ''
                         }}
                    >
                        <span className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Gain Potentiel</span>
                        {tp > 0 && entry > 0 ? (
                            <>
                                <div className="text-4xl font-extrabold" style={{color: themeColors.win}}>
                                    +{rewardAmount.toFixed(2)} {currencySymbol}
                                </div>
                                <div className="flex items-center gap-2 mt-2">
                                    <span className="px-2 py-0.5 text-xs font-bold rounded" style={{ backgroundColor: hexToRgba(themeColors.win, 0.2), color: themeColors.win }}>
                                        RR 1:{rrRatio.toFixed(1)}
                                    </span>
                                </div>
                            </>
                        ) : (
                            <div className="text-gray-300 dark:text-gray-600 text-sm italic">
                                Entrez un TP pour calculer
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

export default PositionCalculator;

=== src/components/CalendarView.jsx ===
import React, { useState, useMemo } from 'react';
import { ChevronLeft, ChevronRight, Calendar as CalIcon } from 'lucide-react';

const CalendarView = ({ trades, currencySymbol }) => {
    const [currentDate, setCurrentDate] = useState(new Date());

    // --- 1. AGREGATION ET CALCULS ---
    const dailyData = useMemo(() => {
        const sortedTrades = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
        const stats = {};
        let currentBalance = 0;

        sortedTrades.forEach(trade => {
            const date = trade.date;
            if (!stats[date]) {
                stats[date] = { profit: 0, startBalance: currentBalance, deposits: 0 };
            }
            const val = parseFloat(trade.profit) || 0;
            if (trade.pair === 'SOLDE') {
                if (trade.type === 'DEPOSIT') stats[date].deposits += val;
                currentBalance += val;
            } else {
                stats[date].profit += val;
                currentBalance += val;
            }
        });
        return stats;
    }, [trades]);

    // --- 2. LOGIQUE CALENDRIER ---
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    const getDaysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
    const getFirstDayOfMonth = (y, m) => {
        const day = new Date(y, m, 1).getDay();
        return day === 0 ? 6 : day - 1; // Lundi = 0
    };

    const daysInMonth = getDaysInMonth(year, month);
    const startDay = getFirstDayOfMonth(year, month);
    const blanks = Array(startDay).fill(null);
    const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

    const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
    const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
    const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];

    return (
        <div className="bg-white/60 dark:bg-neutral-900/40 backdrop-blur-xl p-4 md:p-8 rounded-3xl shadow-xl border border-white/40 dark:border-white/5 animate-in fade-in slide-in-from-bottom-4 mb-20">

            {/* HEADER */}
            <div className="flex items-center justify-between mb-8">
                <h2 className="text-xl font-bold flex items-center text-indigo-900 dark:text-white capitalize">
                    <CalIcon className="mr-3 text-indigo-500" size={24} />
                    {monthNames[month]} {year}
                </h2>
                <div className="flex gap-2">
                    <button onClick={prevMonth} className="p-2 rounded-full hover:bg-white dark:hover:bg-neutral-800 border border-transparent hover:border-gray-200 dark:hover:border-neutral-700 transition-all">
                        <ChevronLeft size={20} className="text-gray-600 dark:text-gray-300" />
                    </button>
                    <button onClick={nextMonth} className="p-2 rounded-full hover:bg-white dark:hover:bg-neutral-800 border border-transparent hover:border-gray-200 dark:hover:border-neutral-700 transition-all">
                        <ChevronRight size={20} className="text-gray-600 dark:text-gray-300" />
                    </button>
                </div>
            </div>

            {/* JOURS SEMAINE (Visible uniquement sur MD+) */}
            <div className="hidden md:grid grid-cols-7 mb-4">
                {['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].map(d => (
                    <div key={d} className="text-center text-xs font-bold text-gray-400 uppercase tracking-wider">
                        {d}
                    </div>
                ))}
            </div>

            {/* GRILLE RESPONSIVE */}
            <div className="grid grid-cols-2 md:grid-cols-7 gap-3 auto-rows-[100px]">

                {blanks.map((_, i) => (
                    <div key={`blank-${i}`} className="hidden md:block rounded-2xl bg-transparent"></div>
                ))}

                {days.map(d => {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dayStat = dailyData[dateString];

                    let dailyProfit = 0;
                    let percent = 0;
                    let hasData = false;

                    if (dayStat) {
                        dailyProfit = dayStat.profit;
                        hasData = true;
                        const effectiveCapital = dayStat.startBalance + dayStat.deposits;
                        if (effectiveCapital > 0 && dailyProfit !== 0) {
                            percent = (dailyProfit / effectiveCapital) * 100;
                        }
                    }

                    // Styles conditionnels
                    let bgColor = "bg-gray-100 dark:bg-neutral-800/50 border-gray-200 dark:border-neutral-800";
                    let textColor = "text-gray-400 dark:text-neutral-600";
                    let profitColor = "";

                    if (hasData && dailyProfit > 0) {
                        bgColor = "bg-emerald-500 shadow-lg shadow-emerald-500/20 border-emerald-400";
                        textColor = "text-white/80";
                        profitColor = "text-white";
                    } else if (hasData && dailyProfit < 0) {
                        bgColor = "bg-rose-500 shadow-lg shadow-rose-500/20 border-rose-400";
                        textColor = "text-white/80";
                        profitColor = "text-white";
                    } else {
                        profitColor = "text-gray-800 dark:text-white";
                    }

                    return (
                        <div
                            key={d}
                            className={`relative rounded-2xl border ${bgColor} p-3 flex flex-col justify-between transition-transform hover:scale-105 group cursor-default h-[100px]`}
                        >
                            <span className={`text-sm md:text-xs font-bold ${textColor}`}>{d}</span>

                            {hasData && dailyProfit !== 0 ? (
                                <div className="text-center self-center w-full">
                                    <div className={`font-extrabold text-xl md:text-base leading-tight ${profitColor}`}>
                                        {dailyProfit > 0 ? '+' : ''}{dailyProfit.toFixed(0)}
                                        <span className="text-xs font-normal opacity-70 ml-0.5">{currencySymbol}</span>
                                    </div>
                                    <div className="text-xs md:text-[10px] font-bold text-white opacity-90 mt-1">
                                        {percent > 0 ? '+' : ''}{percent.toFixed(2)}%
                                    </div>
                                </div>
                            ) : (
                                <div className="flex-1 flex items-center justify-center opacity-10">
                                    <div className="w-1 h-1 bg-current rounded-full"></div>
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>

            {/* Légende */}
            <div className="mt-8 flex gap-4 md:gap-6 justify-center flex-wrap text-xs text-gray-500 dark:text-neutral-400 font-medium">
                <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-emerald-500"></div> <span className="hidden sm:inline">Jour</span> Gagnant
                </div>
                <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-gray-200 dark:bg-neutral-800"></div> Neutre
                </div>
                <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-rose-500"></div> <span className="hidden sm:inline">Jour</span> Perdant
                </div>
            </div>

        </div>
    );
};

export default CalendarView;

=== src/components/Home.jsx ===
import React, { Suspense, memo } from 'react';
// Import dynamique (Lazy load)
const Spline = React.lazy(() => import('@splinetool/react-spline'));
import { TrendingUp, Shield, Zap, ChevronRight, BarChart3, Smartphone, Loader2 } from 'lucide-react';

// --- COMPOSANT 3D ISOLÉ ---
const SplineScene = memo(() => {
    return (
        <Spline scene="/crypto_bars.splinecode" />
    );
});

const Home = ({ onNavigateToAuth }) => {
    return (
        <div className="relative min-h-screen w-full bg-black text-white font-sans selection:bg-indigo-500/30 overflow-x-hidden">

            <style>{`
                /* --- HACK POUR CACHER LE LOGO SPLINE --- */
                canvas + a {
                    display: none !important;
                    opacity: 0 !important;
                    pointer-events: none !important;
                }

                /* --- TEXTE SCINTILLANT (SHIMMER) --- */
                @keyframes shimmer {
                    from { background-position: 0 0; }
                    to { background-position: -200% 0; }
                }
                .animate-shimmer {
                    background: linear-gradient(to right, #6366f1 4%, #ffffff 25%, #6366f1 36%);
                    background-size: 200% auto;
                    background-clip: text;
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    animation: shimmer 4s linear infinite;
                }

                /* --- ANIMATION ORBES DE FOND --- */
                @keyframes float {
                    0% { transform: translate(0px, 0px) scale(1); }
                    33% { transform: translate(30px, -50px) scale(1.1); }
                    66% { transform: translate(-20px, 20px) scale(0.9); }
                    100% { transform: translate(0px, 0px) scale(1); }
                }
                .animate-blob {
                    animation: float 7s infinite;
                }
                .animation-delay-2000 {
                    animation-delay: 2s;
                }
                .animation-delay-4000 {
                    animation-delay: 4s;
                }

                /* --- FOND GRILLE --- */
                .bg-grid-white {
                    background-size: 40px 40px;
                    background-image: linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                                      linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
                }

                /* --- DEGRADÉ LOGO --- */
                .text-gradient-logo {
                    background: linear-gradient(to right, #818cf8, #c084fc);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                }
            `}</style>

            {/* --- BACKGROUND FX --- */}
            <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden">
                <div className="absolute inset-0 bg-grid-white opacity-20" />
                {/* Orbes ajustés */}
                <div className="absolute top-0 left-[-10%] w-64 h-64 md:w-96 md:h-96 bg-indigo-500/30 rounded-full mix-blend-screen filter blur-[80px] md:blur-[100px] opacity-40 animate-blob" />
                <div className="absolute top-[20%] right-[-10%] w-64 h-64 md:w-96 md:h-96 bg-purple-500/30 rounded-full mix-blend-screen filter blur-[80px] md:blur-[100px] opacity-40 animate-blob animation-delay-2000" />
                <div className="absolute -bottom-32 left-1/3 w-64 h-64 md:w-96 md:h-96 bg-blue-500/30 rounded-full mix-blend-screen filter blur-[80px] md:blur-[100px] opacity-40 animate-blob animation-delay-4000" />
            </div>

            {/* --- NAVBAR --- */}
            <nav className="fixed top-4 left-0 right-0 z-50 flex justify-center px-4 md:top-6">
                <div className="flex items-center justify-between w-full max-w-6xl px-4 py-3 md:px-6 bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl md:rounded-full shadow-2xl shadow-black/50">
                    <div className="flex items-center gap-3 cursor-pointer" onClick={() => window.scrollTo(0,0)}>
                        {/* --- MODIFICATION LOGO IMAGE --- */}
                        <img
                            src="/apple-touch-icon.png"
                            alt="FollowTrade Logo"
                            className="w-8 h-8 rounded-lg shadow-lg shadow-indigo-500/20 object-contain"
                        />
                        <span className="font-bold text-lg tracking-tight hidden sm:block">FollowTrade</span>
                    </div>

                    <div className="flex items-center gap-3 md:gap-4">
                        <button onClick={() => onNavigateToAuth(false)} className="text-xs md:text-sm font-medium text-gray-300 hover:text-white transition-colors px-2 py-1">Connexion</button>
                        <button onClick={() => onNavigateToAuth(true)} className="bg-white text-black px-4 py-2 md:px-5 md:py-2 rounded-full text-xs md:text-sm font-bold hover:bg-gray-200 transition-all active:scale-95">
                            S'inscrire
                        </button>
                    </div>
                </div>
            </nav>

            {/* --- HERO SECTION --- */}
            <header className="relative pt-28 pb-12 md:pt-48 md:pb-24 px-4 md:px-6 max-w-7xl mx-auto z-10">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 md:gap-12 items-center">

                    {/* 1. TEXTE */}
                    <div className="flex flex-col items-center lg:items-start text-center lg:text-left relative z-20 order-1">

                        <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20 text-indigo-300 text-[10px] md:text-xs font-medium mb-6 animate-in fade-in slide-in-from-bottom-4 duration-700 backdrop-blur-sm">
                            <span className="relative flex h-2 w-2">
                                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                                <span className="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"></span>
                            </span>
                            Nouvelle Version
                        </div>

                        <h1 className="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-black tracking-tight leading-[1.1] mb-6 animate-in fade-in slide-in-from-bottom-6 duration-1000">
                            Ne jouez plus.<br />
                            Devenez <span className="animate-shimmer cursor-default relative inline-block">
                                Enfin Rentable
                                <svg className="absolute w-full h-2 md:h-3 -bottom-1 left-0 text-indigo-500 opacity-60" viewBox="0 0 100 10" preserveAspectRatio="none">
                                     <path d="M0 5 Q 50 10 100 5" stroke="currentColor" strokeWidth="4" fill="none" />
                                </svg>
                            </span>.
                        </h1>

                        <p className="text-base md:text-lg text-gray-400 max-w-xl mb-8 leading-relaxed animate-in fade-in slide-in-from-bottom-6 duration-1000 delay-100 px-2 md:px-0">
                            Le journal de trading nouvelle génération. Analysez votre psychologie et <span className="text-white font-semibold">éliminez les erreurs coûteuses</span>.
                        </p>

                        <div className="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto animate-in fade-in slide-in-from-bottom-6 duration-1000 delay-200">
                            <button onClick={() => onNavigateToAuth(true)} className="group w-full sm:w-auto px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl md:rounded-2xl font-bold text-lg transition-all hover:scale-105 active:scale-95 shadow-[0_0_40px_-10px_rgba(99,102,241,0.5)] flex items-center justify-center">
                                Commencer <ChevronRight className="ml-2" size={20} />
                            </button>
                        </div>
                    </div>

                    {/* 2. SPLINE 3D */}
                    {/* --- MODIFICATION : 'hidden' par défaut, 'lg:flex' sur grand écran --- */}
                    <div className="hidden lg:flex relative order-2 h-[400px] lg:h-[600px] w-full items-center justify-center animate-in fade-in zoom-in duration-1000 delay-100 pointer-events-none">

                        <div className="absolute inset-0 bg-gradient-to-tr from-indigo-600/10 to-violet-600/10 rounded-full opacity-60 -z-10 transform scale-75"></div>

                        <div className="w-full h-full relative z-10">
                            <Suspense fallback={<div className="flex items-center justify-center h-full text-indigo-500/50"><Loader2 className="animate-spin w-8 h-8"/></div>}>
                                <SplineScene />
                            </Suspense>
                        </div>
                    </div>

                </div>
            </header>

            {/* --- BENTO GRID --- */}
            <section className="px-4 md:px-6 py-12 md:py-24 max-w-6xl mx-auto relative z-10">
                <div className="text-center mb-10 md:mb-16">
                    <h2 className="text-3xl md:text-5xl font-bold tracking-tight mb-4">Tout ce qu'il vous faut pour <span className="text-gradient-logo">scaler</span>.</h2>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-6 gap-4 md:gap-6">

                    <div className="md:col-span-4 bg-neutral-900/40 border border-white/10 rounded-3xl p-6 md:p-8 relative overflow-hidden group hover:border-indigo-500/30 transition-all hover:shadow-2xl hover:shadow-indigo-500/10 duration-500">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-600/10 rounded-full blur-[80px] -mr-16 -mt-16 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div className="relative z-10">
                            <div className="w-10 h-10 md:w-12 md:h-12 bg-neutral-800 rounded-2xl flex items-center justify-center mb-4 md:mb-6 text-indigo-400 border border-white/5"><BarChart3 size={20} className="md:w-6 md:h-6" /></div>
                            <h3 className="text-xl md:text-2xl font-bold mb-2 text-white">Analyses de Précision</h3>
                            <p className="text-sm md:text-base text-gray-400">Visualisez votre Equity Curve, votre Winrate et votre Risk/Reward ratio en temps réel.</p>
                        </div>
                    </div>

                    <div className="md:col-span-2 bg-neutral-900/40 border border-white/10 rounded-3xl p-6 md:p-8 relative overflow-hidden group hover:border-indigo-500/30 transition-all duration-500">
                        <div className="relative z-10">
                            <div className="w-10 h-10 md:w-12 md:h-12 bg-neutral-800 rounded-2xl flex items-center justify-center mb-4 md:mb-6 text-violet-400 border border-white/5"><Smartphone size={20} className="md:w-6 md:h-6" /></div>
                            <h3 className="text-lg md:text-xl font-bold mb-2">100% Mobile</h3>
                            <p className="text-sm md:text-base text-gray-400">Tradez sur votre setup, journalisez sur votre téléphone.</p>
                        </div>
                    </div>

                    <div className="md:col-span-2 bg-neutral-900/40 border border-white/10 rounded-3xl p-6 md:p-8 relative overflow-hidden group hover:border-indigo-500/30 transition-all duration-500">
                        <div className="relative z-10">
                            <div className="w-10 h-10 md:w-12 md:h-12 bg-neutral-800 rounded-2xl flex items-center justify-center mb-4 md:mb-6 text-blue-400 border border-white/5"><Shield size={20} className="md:w-6 md:h-6" /></div>
                            <h3 className="text-lg md:text-xl font-bold mb-2">Sécurisé</h3>
                            <p className="text-sm md:text-base text-gray-400">Chiffrement de bout en bout.</p>
                        </div>
                    </div>

                    <div className="md:col-span-4 bg-neutral-900/40 border border-white/10 rounded-3xl p-6 md:p-8 relative overflow-hidden group hover:border-indigo-500/30 transition-all hover:shadow-2xl hover:shadow-indigo-500/10 duration-500">
                        <div className="absolute bottom-0 right-0 w-64 h-64 bg-violet-600/10 rounded-full blur-[80px] pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div className="relative z-10">
                            <div className="flex justify-between items-start">
                                <div className="w-10 h-10 md:w-12 md:h-12 bg-neutral-800 rounded-2xl flex items-center justify-center mb-4 md:mb-6 text-indigo-400 border border-white/5"><Zap size={20} className="md:w-6 md:h-6" /></div>
                                <div className="px-2 py-1 md:px-3 bg-indigo-500/10 border border-indigo-500/20 rounded-full text-indigo-300 text-[10px] md:text-xs font-bold uppercase tracking-wide">OCR IA</div>
                            </div>
                            <h3 className="text-xl md:text-2xl font-bold mb-2">Saisie Éclair</h3>
                            <p className="text-sm md:text-base text-gray-400">Importez vos trades via capture d'écran grâce à notre IA.</p>
                        </div>
                    </div>
                </div>
            </section>

            {/* --- CTA --- */}
            <section className="px-4 md:px-6 py-12 md:py-20 text-center relative z-10">
                <div className="max-w-4xl mx-auto bg-gradient-to-b from-neutral-900 to-black border border-white/10 rounded-[2rem] md:rounded-[2.5rem] p-8 md:p-20 relative overflow-hidden shadow-2xl">
                    <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[300px] md:w-[600px] h-[300px] bg-indigo-500/10 rounded-full blur-[100px] pointer-events-none"></div>
                    <div className="relative z-10 flex flex-col items-center">
                        <h2 className="text-3xl md:text-5xl font-black mb-6 tracking-tight">Le Trading n'est pas un jeu.</h2>
                        <button onClick={() => onNavigateToAuth(true)} className="w-full md:w-auto bg-white text-black hover:bg-indigo-50 px-8 py-4 rounded-xl font-bold text-lg transition-transform hover:scale-105 active:scale-95 shadow-xl">
                            Créer mon compte
                        </button>
                    </div>
                </div>
            </section>

            <footer className="border-t border-white/5 py-8 md:py-12 text-center relative z-10 bg-black text-gray-500 text-xs md:text-sm">
                <p>&copy; 2025 FollowTrade.</p>
            </footer>
        </div>
    );
};

export default Home;

=== src/main.jsx ===
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.jsx'

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <App />
  </StrictMode>,
)


=== src/App.jsx ===
import React, { useState, useEffect } from 'react';
import { Sun, Moon, Wallet, Plus, Settings, Bell, ShieldAlert, Sparkles, Crown, User, UploadCloud, Loader2, TrendingUp, BrainCircuit, Activity } from 'lucide-react';
import Tesseract from 'tesseract.js';
import { api } from './api';
import { calculateDisciplineScore } from './utils/discipline';

// --- IMPORTS DES COMPOSANTS ---
import TradingBackground from './components/TradingBackground';
import TradeForm from './components/TradeForm';
import TradeHistory from './components/TradeHistory';
import PositionCalculator from './components/PositionCalculator';
import CalendarView from './components/CalendarView';
import SettingsView from './components/SettingsView';
import GraphView from './components/GraphView';
import UpdatesView from './components/UpdatesView';
import AdminPanel from './components/AdminPanel';
import Auth from './components/Auth';
import Home from './components/Home';
import UpgradeModal from './components/UpgradeModal';
import AlertPopup from './components/AlertPopup';
import NotificationModal from './components/NotificationModal';
import Sidebar from './components/Sidebar';
import MobileMenu from './components/MobileMenu';
import AccountSelector from './components/AccountSelector';
import AccountFormModal from './components/AccountFormModal';
import TodoView from './components/TodoView';
import ShareTradeModal from './components/ShareTradeModal';
import SimulatorView from './components/SimulatorView';

// CONSTANTES
const DEFAULT_COLORS = { balance: '#4f46e5', buy: '#2563eb', sell: '#ea580c', win: '#10b981', loss: '#f43f5e' };
const PAIRS = [
    { code: 'EURUSD', type: 'FOREX' }, { code: 'GBPUSD', type: 'FOREX' }, { code: 'USDJPY', type: 'FOREX' },
    { code: 'XAUUSD', type: 'METAL' }, { code: 'US30', type: 'INDICE' },
    { code: 'BTCUSD', type: 'CRYPTO' }, { code: 'ETHUSD', type: 'CRYPTO' },
];

function App() {
    const [user, setUser] = useState(null);
    const [activeTab, setActiveTab] = useState('journal');
    const [isDark, setIsDark] = useState(true);
    const [trades, setTrades] = useState([]);
    const [loadingData, setLoadingData] = useState(false);

    // COMPTES
    const [accounts, setAccounts] = useState([]);
    const [currentAccount, setCurrentAccount] = useState(null);
    const [isAccountModalOpen, setIsAccountModalOpen] = useState(false);
    const [editingAccount, setEditingAccount] = useState(null);

    // Modals & Popups
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingTrade, setEditingTrade] = useState(null);

    // NOUVEAUX ÉTATS POUR LES MODALS
    const [tradeToShare, setTradeToShare] = useState(null);
    const [viewingTrade, setViewingTrade] = useState(null);

    const [showUpgradeModal, setShowUpgradeModal] = useState(false);
    const [showNotifModal, setShowNotifModal] = useState(false);
    const [systemAlert, setSystemAlert] = useState(null);

    // Drag & Drop States
    const [isDragging, setIsDragging] = useState(false);
    const [isProcessingFile, setIsProcessingFile] = useState(false);

    // Notifications
    const [notifications, setNotifications] = useState([]);
    const [unreadNotifsCount, setUnreadNotifsCount] = useState(0);
    const [hasNewUpdates, setHasNewUpdates] = useState(false);
    const [latestUpdateId, setLatestUpdateId] = useState(0);

    const [viewMode, setViewMode] = useState('home');
    const [authInitialState, setAuthInitialState] = useState(false);
    const colors = (user?.colors) ? user.colors : DEFAULT_COLORS;

    // --- INIT ---
    useEffect(() => {
        const root = document.documentElement;
        if (viewMode === 'home' || viewMode === 'auth') root.style.setProperty('--bg-global', '#000000');
        else root.style.setProperty('--bg-global', isDark ? '#262626' : '#FFFFFF');
    }, [viewMode, isDark]);

    useEffect(() => { isDark ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark'); }, [isDark]);

    useEffect(() => {
        const savedUser = api.getUser();
        const token = api.getToken();
        if (savedUser && token) {
            setUser(savedUser);
            if (savedUser.preferences?.defaultView) setActiveTab(savedUser.preferences.defaultView);
            setViewMode('app');
            loadAccounts();
            checkUpdates();
            checkForSystemAlerts();
            loadNotifications();
        } else {
            setViewMode('home');
        }
    }, []);

    // --- LOGIQUE METIER & OCR ---
    const getContractSize = (pairCode) => {
        const pairInfo = PAIRS.find(p => p.code === pairCode);
        const type = pairInfo ? pairInfo.type : 'FOREX';
        switch (type) {
            case 'FOREX': return 100000; case 'METAL': return 100; case 'INDICE': return 1; case 'CRYPTO': return 1; default: return 100000;
        }
    };

    const getConversionRate = async (fromCurrency, toCurrency) => {
        if (fromCurrency === toCurrency) return 1;
        const binanceFrom = fromCurrency === 'USD' ? 'USDT' : fromCurrency;
        const binanceTo = toCurrency === 'USD' ? 'USDT' : toCurrency;
        const symbol = `${binanceFrom}${binanceTo}`;
        const inverseSymbol = `${binanceTo}${binanceFrom}`;
        try {
            let res = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`);
            if (res.ok) { const data = await res.json(); return parseFloat(data.price); }
            res = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${inverseSymbol}`);
            if (res.ok) { const data = await res.json(); return 1 / parseFloat(data.price); }
            return null;
        } catch (e) { return null; }
    };

    const parseMT5Data = (text) => {
        const extracted = { fees: 0, time: '' };
        const cleanText = text.replace(/->|→|>/g, ' ').toUpperCase();
        const lines = cleanText.split('\n').map(l => l.trim()).filter(l => l.length > 2);
        let mainLineIndex = -1;
        for (let i = lines.length - 1; i >= 0; i--) {
            const line = lines[i];
            if (line.match(/(BUY|SELL)\s+\d/)) {
                if (PAIRS.some(p => line.includes(p.code)) || line.match(/[A-Z]{6}/)) {
                    mainLineIndex = i;
                    const foundPair = PAIRS.find(p => line.includes(p.code));
                    extracted.pair = foundPair ? foundPair.code : line.match(/\b([A-Z]{6})\b/)[1];
                    const typeLotMatch = line.match(/(BUY|SELL)\s+([0-9\.]+)/);
                    if (typeLotMatch) { extracted.type = typeLotMatch[1]; extracted.lot = typeLotMatch[2]; }
                    break;
                }
            }
        }
        if (mainLineIndex === -1) return extracted;
        const relevantLines = lines.slice(mainLineIndex + 1, mainLineIndex + 15);
        for (const line of relevantLines) {
            if (!extracted.date) {
                const dateTimeMatch = line.match(/(\d{4})[\.-](\d{2})[\.-](\d{2})\s+(\d{2})[:\.](\d{2})(?:[:\.](\d{2}))?/);
                if (dateTimeMatch) { extracted.date = `${dateTimeMatch[1]}-${dateTimeMatch[2]}-${dateTimeMatch[3]}`; extracted.time = `${dateTimeMatch[4]}:${dateTimeMatch[5]}`; }
                else { const d = line.match(/(\d{4})[\.-](\d{2})[\.-](\d{2})/); if (d) extracted.date = `${d[1]}-${d[2]}-${d[3]}`; }
            }
            if (!extracted.sl) { const sl = line.match(/(?:S|5)[\s\/\\I\|\.]*L[:\s]*([\d\.]+)/); if (sl) extracted.sl = sl[1]; }
            if (!extracted.tp) { const tp = line.match(/T[\s\/\\I\|\.]*P[:\s]*([\d\.]+)/); if (tp) extracted.tp = tp[1]; }
            const chargesMatch = line.match(/(?:CHARGES|COMMISSION|C\s*H\s*A\s*R\s*G\s*E\s*A)[:\s]*([-]?[\d\.]+)/); if (chargesMatch) extracted.fees += Math.abs(parseFloat(chargesMatch[1]));
            const swapMatch = line.match(/(?:SWAP|S\s*W\s*A\s*P)[:\s]*([-]?[\d\.]+)/); if (swapMatch) extracted.fees += Math.abs(parseFloat(swapMatch[1]));
            if (!extracted.entry && !line.includes(extracted.date)) {
                if (line.match(/(?:S|5)[\s\/\\I\|\.]*L/) || line.match(/T[\s\/\\I\|\.]*P/)) continue;
                if (line.match(/(?:CHARGES|COMMISSION|SWAP)/)) continue;
                if (!extracted.profit) { const profitLabelMatch = line.match(/PROFIT[:\s]*([-]?[\d\.]+)/); if (profitLabelMatch) extracted.profit = profitLabelMatch[1]; }
                const nums = line.match(/([-]?\d+\.\d{2,})/g);
                if (nums) { if (nums.length >= 3) { extracted.entry = nums[0]; extracted.exit = nums[1]; extracted.profit = nums[2]; } else if (nums.length === 2) { extracted.entry = nums[0]; extracted.exit = nums[1]; } }
            }
        }
        if (parseFloat(extracted.sl) === 0) extracted.sl = ''; if (parseFloat(extracted.tp) === 0) extracted.tp = ''; return extracted;
    };

    const processFileAndAddTrade = async (file) => {
        if (!currentAccount) { alert("Veuillez sélectionner un compte avant d'ajouter un trade."); return; }
        setIsProcessingFile(true);
        try {
            const result = await Tesseract.recognize(file, 'eng');
            const data = parseMT5Data(result.data.text);
            if (!data.pair) { throw new Error("Données illisibles."); }

            let finalProfit = 0;
            if (data.profit) {
                finalProfit = parseFloat(data.profit);
            } else {
                if (!data.entry || !data.exit) throw new Error("Prix manquants.");
                const entry = parseFloat(data.entry); const exit = parseFloat(data.exit); const lot = parseFloat(data.lot);
                const diff = data.type === 'BUY' ? (exit - entry) : (entry - exit);
                const contractSize = getContractSize(data.pair);
                let grossProfitQuote = diff * lot * contractSize;
                let quoteCurrency = 'USD';
                if (data.pair.length === 6) quoteCurrency = data.pair.substring(3);
                else if (['XAUUSD','US30','BTCUSD'].includes(data.pair)) quoteCurrency = 'USD';
                finalProfit = grossProfitQuote;
                if (currentAccount.currency !== quoteCurrency) {
                    if (data.pair.startsWith(currentAccount.currency)) { finalProfit = grossProfitQuote / exit; }
                    else { const rate = await getConversionRate(currentAccount.currency, quoteCurrency); if (rate) finalProfit = grossProfitQuote / rate; }
                }
                if (data.fees) finalProfit -= parseFloat(data.fees);
            }

            const currentBalance = trades.reduce((acc, t) => acc + (parseFloat(t.profit) || 0), 0);

            const tradeForScore = {
                entry: data.entry, sl: data.sl, lot: data.lot, pair: data.pair, exit: data.exit || 0, tp: data.tp || 0,
                date: data.date, time: data.time || '12:00', isOffPlan: false, riskRespected: true, slMoved: false, tags: ['DragDrop'], hasScreenshot: true
            };
            const discipline = calculateDisciplineScore(tradeForScore, currentAccount, currentBalance);

            const newTrade = {
                account_id: currentAccount.id, pair: data.pair, type: data.type, lot: data.lot,
                entry: data.entry || 0, exit: data.exit || 0, sl: data.sl || 0, tp: data.tp || 0,
                profit: finalProfit.toFixed(2), date: data.date || new Date().toISOString().split('T')[0], time: data.time || '',
                disciplineScore: discipline.total, disciplineDetails: discipline.details
            };

            const addedTrade = await api.addTrade(newTrade);
            setTrades([addedTrade, ...trades]);
            setTimeout(() => setIsProcessingFile(false), 800);
        } catch (error) { console.error(error); alert("Erreur : " + error.message); setIsProcessingFile(false); }
    };

    const handleDragOver = (e) => {
        e.preventDefault();
        if (activeTab !== 'journal' || isModalOpen) return;
        if (!e.dataTransfer.types.includes('Files')) return;
        setIsDragging(true);
    };

    const handleDragLeave = (e) => {
        e.preventDefault();
        if (activeTab !== 'journal' || isModalOpen) return;
        setIsDragging(false);
    };

    const handleDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);

        if (activeTab !== 'journal' || isModalOpen) return;
        if (!e.dataTransfer.types.includes('Files')) return;

        if (!user || user.is_pro < 1) { setShowUpgradeModal(true); return; }
        if (e.dataTransfer.files && e.dataTransfer.files[0]) processFileAndAddTrade(e.dataTransfer.files[0]);
    };

    const loadAccounts = async () => { try { const accs = await api.getAccounts(); setAccounts(accs); if (accs.length > 0) { if (currentAccount) { const updated = accs.find(a => a.id === currentAccount.id); if (updated) setCurrentAccount(updated); else setCurrentAccount(accs[0]); } else { setCurrentAccount(accs[0]); } } } catch (e) { console.error(e); } };

    const loadTrades = async () => {
        if (!currentAccount) return;
        setLoadingData(true);
        try {
            const data = await api.getTrades(currentAccount.id);
            let runningBalance = 0;
            const processedTrades = data.sort((a,b) => new Date(a.date) - new Date(b.date)).map(t => {
                const profit = parseFloat(t.profit) || 0;
                runningBalance += profit;
                if (t.pair !== 'SOLDE' && (!t.disciplineScore || t.disciplineScore === 0) && currentAccount) {
                    const tempScore = calculateDisciplineScore(t, currentAccount, runningBalance);
                    return { ...t, disciplineScore: tempScore.total, disciplineDetails: tempScore.details };
                }
                return t;
            });
            setTrades(processedTrades.reverse());
        } catch (e) { console.error(e); } finally { setLoadingData(false); }
    };

    useEffect(() => { if (currentAccount) loadTrades(); else setTrades([]); }, [currentAccount]);

    const handleCreateAccount = async (data) => { try { const newAcc = await api.createAccount(data); setAccounts([...accounts, newAcc]); setCurrentAccount(newAcc); } catch (e) { alert("Erreur création"); } };
    const handleUpdateAccount = async (id, data) => { try { await api.updateAccount(id, data); await loadAccounts(); setIsAccountModalOpen(false); } catch (e) { alert("Erreur sauvegarde"); } };
    const handleDeleteAccount = async (id) => { if(!window.confirm("Supprimer ?")) return; try { await api.deleteAccount(id); await loadAccounts(); } catch (e) { alert("Erreur suppression"); } };
    const checkUpdates = async () => { try { const updates = await api.getUpdates(); if (Array.isArray(updates) && updates.length > 0) { const sorted = updates.sort((a,b) => b.id - a.id); const newest = sorted[0]; setLatestUpdateId(newest.id); const lastRead = parseInt(localStorage.getItem('last_read_update') || '0'); if (newest.id > lastRead) setHasNewUpdates(true); } } catch (e) {} };
    const loadNotifications = async () => { try { const data = await api.getNotifications(); if (Array.isArray(data)) { setNotifications(data); const unread = data.filter(n => n.is_read === 0).length; setUnreadNotifsCount(unread); } } catch (e) {} };
    const checkForSystemAlerts = async () => { try { const data = await api.getNotifications(); const alert = data.find(n => n.is_read === 0 && n.type === 'GRADE'); if (alert) setSystemAlert(alert); } catch (e) {} };
    const closeSystemAlert = async (id) => { setSystemAlert(null); await api.markSingleNotificationRead(id); loadNotifications(); };
    const openNotifModal = async () => { setShowNotifModal(true); setUnreadNotifsCount(0); await api.markNotificationsRead(); loadNotifications(); };
    const handleLoginSuccess = async (userData) => { setUser(userData); if (userData.preferences?.defaultView) setActiveTab(userData.preferences.defaultView); setViewMode('app'); await loadAccounts(); setTimeout(() => { checkUpdates(); checkForSystemAlerts(); loadNotifications(); }, 500); };
    const handleLogout = () => { api.removeToken(); setUser(null); setTrades([]); setAccounts([]); setCurrentAccount(null); setActiveTab('journal'); setViewMode('home'); };
    const handleUpdateUser = async (updatedData) => { const res = await api.updateUser(updatedData); setUser(res.user); api.setUser(res.user); };
    const navigateToAuth = (isSignUp = false) => { setAuthInitialState(isSignUp); setViewMode('auth'); };

    // --- GESTION NAVIGATION ET ACCES ---
    const handleNavClick = (tab) => {
        // Liste des onglets accessibles aux utilisateurs gratuits
        const freeTabs = ['journal', 'calculator', 'settings', 'updates', 'routine'];

        if (tab === 'updates') {
            setHasNewUpdates(false);
            if (latestUpdateId > 0) localStorage.setItem('last_read_update', latestUpdateId.toString());
        }

        // Si l'utilisateur est PRO ou si l'onglet est gratuit, on navigue
        // Sinon (pour 'simulator', 'graphs', 'calendar'), on montre la modal
        if (user?.is_pro >= 1 || freeTabs.includes(tab)) {
            setActiveTab(tab);
        } else {
            setShowUpgradeModal(true);
        }
    };

    const handleOpenAddModal = () => { setEditingTrade(null); setIsModalOpen(true); };
    const handleOpenEditModal = (trade) => { setEditingTrade(trade); setIsModalOpen(true); };
    const handleCloseModal = () => { setIsModalOpen(false); setEditingTrade(null); };

    // --- NOUVELLES FONCTIONS DE HANDLER ---
    const handleShareTrade = (trade) => { setTradeToShare(trade); };
    const handleViewTrade = (trade) => { setViewingTrade(trade); };

    const addTrade = async (trade) => { if (!currentAccount) return alert("Sélectionnez un compte"); const currentBalance = trades.reduce((acc, t) => acc + (parseFloat(t.profit) || 0), 0); let discipline = { total: 0, details: {} }; if (trade.pair !== 'SOLDE') { discipline = calculateDisciplineScore(trade, currentAccount, currentBalance); } const tradeWithAccount = { ...trade, account_id: currentAccount.id, disciplineScore: discipline.total, disciplineDetails: discipline.details }; const newTrade = await api.addTrade(tradeWithAccount); setTrades([newTrade, ...trades]); handleCloseModal(); };
    const updateTrade = async (tradeData) => { const currentBalance = trades.reduce((acc, t) => acc + (parseFloat(t.profit) || 0), 0); let discipline = { total: tradeData.disciplineScore, details: tradeData.disciplineDetails }; if (tradeData.pair !== 'SOLDE') { discipline = calculateDisciplineScore(tradeData, currentAccount, currentBalance); } const updatedData = { ...tradeData, disciplineScore: discipline.total, disciplineDetails: discipline.details }; const updatedTrade = await api.updateTrade(updatedData.id, updatedData); setTrades(trades.map(t => t.id === updatedTrade.id ? updatedTrade : t)); handleCloseModal(); };
    const deleteTrade = async (id) => { if (!window.confirm("Supprimer ?")) return; await api.deleteTrade(id); setTrades(trades.filter(t => t.id !== id)); };
    const getCurrencySymbol = (code) => { switch(code) { case 'EUR': return '€'; case 'GBP': return '£'; default: return '$'; } };
    const currencyCode = currentAccount?.currency || user?.preferences?.currency || 'USD';
    const currencySymbol = getCurrencySymbol(currencyCode);
    const avatarSrc = user ? api.getAvatarUrl(user.avatar_url) : null;
    const activeColor = currentAccount?.color || DEFAULT_COLORS.balance;

    const currentBalance = trades.reduce((acc, t) => acc + (parseFloat(t.profit) || 0), 0);
    const realTrades = trades.filter(t => t.pair !== 'SOLDE');
    const totalPnL = realTrades.reduce((acc, t) => acc + (parseFloat(t.profit) || 0), 0);
    const avgDiscipline = realTrades.length > 0 ? Math.round(realTrades.reduce((acc, t) => acc + (t.disciplineScore || 0), 0) / realTrades.length) : 0;
    const investedCapital = currentBalance - totalPnL;
    const totalGainPct = investedCapital > 0 ? (totalPnL / investedCapital) * 100 : 0;

    const handleOpenCreateAccount = () => { setEditingAccount(null); setIsAccountModalOpen(true); };
    const handleOpenEditAccount = (acc) => { setEditingAccount(acc); setIsAccountModalOpen(true); };
    const handleSaveAccount = async (formData) => { try { if (editingAccount) { await api.updateAccount(editingAccount.id, formData); } else { await api.createAccount(formData); } await loadAccounts(); setIsAccountModalOpen(false); } catch (e) { alert("Erreur sauvegarde"); } };
    const renderMobileBadge = () => { if (user.is_pro === 7) return <span className="px-2.5 py-0.5 rounded-lg text-[10px] font-bold bg-gradient-to-r from-fuchsia-500 to-purple-600 text-white border border-purple-400/30 inline-flex items-center gap-1.5 shadow-sm min-w-[60px] justify-center"><ShieldAlert size={10} fill="currentColor" /> ADMIN</span>; if (user.is_pro === 2) return <span className="px-2.5 py-0.5 rounded-lg text-[10px] font-bold bg-gradient-to-r from-emerald-400 to-teal-500 text-white border border-emerald-400/30 inline-flex items-center gap-1.5 shadow-sm min-w-[60px] justify-center"><Sparkles size={10} fill="currentColor" /> VIP</span>; if (user.is_pro === 1) return <span className="px-2.5 py-0.5 rounded-lg text-[10px] font-bold bg-gradient-to-r from-amber-300 to-yellow-500 text-yellow-900 border border-yellow-400/30 inline-flex items-center gap-1.5 shadow-sm min-w-[60px] justify-center"><Crown size={10} fill="currentColor" /> PRO</span>; return <span className="px-2.5 py-0.5 rounded-lg text-[10px] font-bold bg-gray-100 text-gray-500 border border-gray-200 dark:bg-white/10 dark:text-gray-300 dark:border-white/10 inline-flex items-center gap-1.5 min-w-[60px] justify-center"><User size={10} /> FREE</span>; };

    if (viewMode === 'home') return <div className={`min-h-screen transition-colors duration-300 ${isDark ? 'dark' : ''}`}><TradingBackground /><Home onNavigateToAuth={navigateToAuth} /></div>;
    if (viewMode === 'auth') return <div className={`min-h-screen transition-colors duration-300 ${isDark ? 'dark' : ''}`}><TradingBackground /><div className="relative z-10 container mx-auto px-4 py-8 pt-[calc(2rem+env(safe-area-inset-top))]"><div className="flex justify-between mb-4"><button onClick={() => setViewMode('home')} className="text-white/70 hover:text-white font-bold flex items-center gap-2">← Retour</button><button onClick={() => setIsDark(!isDark)} className="p-3 bg-white/10 backdrop-blur-md rounded-full text-white hover:bg-white/20">{isDark ? <Sun size={20} /> : <Moon size={20} />}</button></div><Auth onLoginSuccess={handleLoginSuccess} initialSignUp={authInitialState} /></div></div>;

    return (
        <div className={`h-[100dvh] w-full transition-colors duration-300 ${isDark ? 'dark' : ''} overflow-hidden flex flex-col relative`} onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop}>
            <TradingBackground />

            {isDragging && (<div className="absolute inset-0 z-[100] bg-indigo-600/90 backdrop-blur-sm flex flex-col items-center justify-center animate-in fade-in duration-200">{user?.is_pro >= 1 ? (<><UploadCloud size={80} className="text-white mb-4 animate-bounce" /><h2 className="text-3xl font-black text-white">Relâchez pour ajouter !</h2></>) : (<><Crown size={80} className="text-amber-400 mb-4 animate-pulse" /><h2 className="text-3xl font-black text-white">Premium Only</h2></>)}</div>)}
            {isProcessingFile && (<div className="absolute inset-0 z-[100] bg-black/80 backdrop-blur-md flex flex-col items-center justify-center animate-in fade-in duration-300"><div className="relative"><div className="absolute inset-0 bg-indigo-500 blur-xl opacity-50 rounded-full animate-pulse"></div><Loader2 size={64} className="text-white animate-spin relative z-10" /></div><h2 className="text-2xl font-bold text-white mt-6">Lecture de l'image...</h2><p className="text-gray-400 mt-2">Récupération du profit réel affiché</p></div>)}

            {/* MODALS GLOBAUX */}
            <AccountFormModal isOpen={isAccountModalOpen} onClose={() => setIsAccountModalOpen(false)} onSave={handleSaveAccount} accountToEdit={editingAccount} />
            <UpgradeModal isOpen={showUpgradeModal} onClose={() => setShowUpgradeModal(false)} />
            <AlertPopup notification={systemAlert} onClose={closeSystemAlert} />
            <NotificationModal isOpen={showNotifModal} onClose={() => setShowNotifModal(false)} notifications={notifications} />

            {/* MODALS SPÉCIFIQUES TRADE */}
            <ShareTradeModal isOpen={!!tradeToShare} onClose={() => setTradeToShare(null)} trade={tradeToShare} currencySymbol={currencySymbol} />

            <div className="relative z-10 flex flex-1 h-full overflow-hidden">
                <Sidebar user={user} activeTab={activeTab} onNavClick={handleNavClick} onLogout={handleLogout} hasNewUpdates={hasNewUpdates} unreadNotifsCount={unreadNotifsCount} onOpenNotif={openNotifModal} />

                <div className="flex-1 flex flex-col h-full overflow-hidden relative">
                    <header className="flex-none md:hidden h-[calc(4rem+env(safe-area-inset-top))] pt-[env(safe-area-inset-top)] bg-white/80 dark:bg-[#262626] backdrop-blur-xl border-b border-gray-200 dark:border-neutral-800 flex items-center justify-between px-4 z-20"><div className="flex items-center gap-3 overflow-hidden"><div className="w-9 h-9 rounded-full overflow-hidden border border-gray-200 dark:border-white/10 flex-shrink-0 bg-gray-100 dark:bg-neutral-800 flex items-center justify-center">{avatarSrc ? <img src={avatarSrc} alt="Profile" className="w-full h-full object-cover" /> : <User size={18} className="text-gray-400" />}</div><div className="flex flex-row items-center gap-2 min-w-0"><span className="font-bold text-sm text-gray-900 dark:text-white truncate leading-tight">{user?.first_name || 'Trader'}</span><div className="flex-shrink-0">{renderMobileBadge()}</div></div></div><div className="flex items-center gap-2 flex-shrink-0"><button onClick={openNotifModal} className="relative p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10 text-gray-500 dark:text-gray-400 transition-colors"><Bell size={20} className={unreadNotifsCount > 0 ? "text-indigo-500" : ""} />{unreadNotifsCount > 0 && <span className="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full border border-white dark:border-[#262626]"></span>}</button><button onClick={() => handleNavClick('settings')} className="p-2 text-gray-500 hover:text-indigo-500 dark:text-gray-400 transition-colors"><Settings size={20} /></button><button onClick={() => setIsDark(!isDark)} className="p-2 text-gray-500 dark:text-gray-400">{isDark ? <Sun size={20} /> : <Moon size={20} />}</button></div></header>

                    <div className="flex-1 overflow-y-auto scrollbar-hide p-4 pb-20 md:p-8 md:pb-8 bg-gray-50 dark:bg-black relative">
                        <div className="absolute top-6 right-8 z-30 hidden md:block"><button onClick={() => setIsDark(!isDark)} className="p-3 bg-white/80 dark:bg-neutral-900/80 backdrop-blur-md rounded-full shadow-lg border border-gray-200 dark:border-neutral-800 text-gray-600 dark:text-gray-300 hover:scale-110 transition-all active:scale-95 group">{isDark ? <Sun size={20} className="group-hover:rotate-90 transition-transform duration-500" /> : <Moon size={20} className="group-hover:-rotate-12 transition-transform duration-500" />}</button></div>

                        <main className="max-w-7xl mx-auto pb-6">
                            {['journal', 'graphs', 'calendar'].includes(activeTab) && (
                                <div className="animate-in fade-in slide-in-from-top-4 duration-500">
                                    <AccountSelector accounts={accounts} currentAccount={currentAccount} onSelect={setCurrentAccount} onCreate={handleCreateAccount} onUpdate={handleUpdateAccount} onDelete={handleDeleteAccount} onOpenCreate={handleOpenCreateAccount} onOpenEdit={handleOpenEditAccount} isDark={isDark} />
                                </div>
                            )}

                            {activeTab === 'journal' && (
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
                                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-8">
                                        <div className="col-span-2 lg:col-span-1 rounded-3xl p-5 md:p-6 text-white relative overflow-hidden shadow-lg transition-all" style={{ background: `linear-gradient(135deg, ${activeColor}, ${isDark ? '#171717' : '#e5e7eb'})` }}>
                                            <div className="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8 blur-xl"></div>
                                            <div className="relative z-10"><div className="flex items-center gap-2 text-white/80 mb-2 text-xs font-bold uppercase tracking-wider"><Wallet size={16} /> Solde Actuel</div><div className="text-3xl md:text-4xl font-black tracking-tight">{currentBalance.toLocaleString('en-US', { style: 'currency', currency: currencyCode })}</div><div className="mt-1 text-[10px] md:text-xs opacity-60 font-medium truncate">{currentAccount?.name || 'Sélectionnez un compte'}</div></div>
                                        </div>
                                        <div className="bg-white dark:bg-neutral-900 rounded-3xl p-5 border border-gray-100 dark:border-neutral-800 shadow-sm flex flex-col justify-center"><div className="flex items-center gap-2 text-gray-400 mb-2 text-xs font-bold uppercase tracking-wider"><BrainCircuit size={16} className={avgDiscipline >= 90 ? 'text-emerald-500' : (avgDiscipline >= 50 ? 'text-indigo-500' : 'text-rose-500')} /><span>Discipline</span></div><div className={`text-2xl md:text-3xl font-black ${avgDiscipline >= 90 ? 'text-emerald-500' : (avgDiscipline >= 50 ? 'text-gray-800 dark:text-white' : 'text-rose-500')}`}>{avgDiscipline}%</div><div className="text-[10px] text-gray-400 font-medium">Moyenne globale</div></div>
                                        <div className="bg-white dark:bg-neutral-900 rounded-3xl p-5 border border-gray-100 dark:border-neutral-800 shadow-sm flex flex-col justify-center"><div className="flex items-center gap-2 text-gray-400 mb-2 text-xs font-bold uppercase tracking-wider"><Activity size={16} className={totalPnL >= 0 ? 'text-emerald-500' : 'text-rose-500'} /><span>Gain Total</span></div><div className={`text-2xl md:text-3xl font-black ${totalPnL >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>{totalPnL > 0 ? '+' : ''}{totalPnL.toFixed(2)}<span className="text-sm font-normal text-gray-400 ml-1">{currencySymbol}</span></div><div className="text-[10px] text-gray-400 font-medium">P&L Cumulé</div></div>
                                        <div className="bg-white dark:bg-neutral-900 rounded-3xl p-5 border border-gray-100 dark:border-neutral-800 shadow-sm flex flex-col justify-center"><div className="flex items-center gap-2 text-gray-400 mb-2 text-xs font-bold uppercase tracking-wider"><TrendingUp size={16} className={totalGainPct >= 0 ? 'text-emerald-500' : 'text-rose-500'} /><span>Croissance</span></div><div className={`text-2xl md:text-3xl font-black ${totalGainPct >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>{totalGainPct > 0 ? '+' : ''}{totalGainPct.toFixed(2)}%</div><div className="text-[10px] text-gray-400 font-medium">Sur capital investi</div></div>
                                    </div>

                                    <div className="flex justify-between items-center"><h2 className="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">Historique</h2><button onClick={handleOpenAddModal} className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg shadow-emerald-500/20 flex items-center gap-2 active:scale-95 text-sm md:text-base"><Plus size={18} /> Nouveau Trade</button></div>
                                    <TradeForm isOpen={isModalOpen} onClose={handleCloseModal} onAddTrade={addTrade} onUpdateTrade={updateTrade} tradeToEdit={editingTrade} currencySymbol={currencySymbol} currentAccount={currentAccount} user={user} onShowUpgrade={() => setShowUpgradeModal(true)} currentBalance={currentBalance} />
                                    {loadingData ? <div className="text-center py-10 text-gray-400 animate-pulse">Chargement...</div> :
                                        <TradeHistory
                                            trades={trades}
                                            onDelete={deleteTrade}
                                            onEdit={handleOpenEditModal}
                                            onShare={handleShareTrade} // PROPS POUR SHARE
                                            onView={handleViewTrade} // PROPS POUR DETAILS
                                            currencySymbol={currencySymbol}
                                            colors={colors}
                                        />
                                    }
                                </div>
                            )}

                            {activeTab === 'updates' && <div className="animate-in fade-in slide-in-from-bottom-4 duration-500"><UpdatesView /></div>}
                            {activeTab === 'graphs' && <div className="animate-in fade-in slide-in-from-bottom-4 duration-500"><GraphView trades={trades} currencySymbol={currencySymbol} colors={colors} /></div>}
                            {activeTab === 'calendar' && <div className="animate-in fade-in slide-in-from-bottom-4 duration-500"><CalendarView trades={trades} currencySymbol={currencySymbol} colors={colors} /></div>}
                            {activeTab === 'calculator' && <div className="animate-in fade-in slide-in-from-bottom-4 duration-500"><PositionCalculator currentBalance={currentBalance} defaultRisk={user?.default_risk} currencySymbol={currencySymbol} colors={colors} /></div>}
                            {activeTab === 'routine' && <div className="animate-in fade-in slide-in-from-bottom-4 duration-500"><TodoView user={user} onShowUpgrade={() => setShowUpgradeModal(true)} /></div>}

                            {/* VUE SIMULATEUR AVEC LES BONNES PROPS */}
                            {activeTab === 'simulator' && (
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                                    <SimulatorView currencySymbol={currencySymbol} accounts={accounts} trades={trades} />
                                </div>
                            )}

                            {activeTab === 'admin' && user.is_pro === 7 && <div className="animate-in fade-in slide-in-from-bottom-4 duration-500"><AdminPanel /></div>}
                            {activeTab === 'settings' && <div className="animate-in fade-in slide-in-from-bottom-4 duration-500"><SettingsView user={user} onUpdateUser={handleUpdateUser} onClose={() => setActiveTab('journal')} onLogout={handleLogout} onNavigate={setActiveTab} /></div>}
                        </main>
                    </div>

                    {/* CORRECTION : On retire le background et la border ici car le menu est flottant */}
                    <div className="md:hidden">
                        <MobileMenu activeTab={activeTab} onNavClick={handleNavClick} user={user} hasNewUpdates={hasNewUpdates} colors={colors} />
                    </div>
                </div>
            </div>
        </div>
    );
}

export default App;

=== src/api.js ===
const hostname = window.location.hostname;
export const BASE_URL = (hostname === 'localhost' || hostname.startsWith('192.168') || hostname.startsWith('10.')) ? `http://${hostname}:3000` : '';
const API_URL = `${BASE_URL}/api`;

const request = async (endpoint, options = {}) => {
    const token = localStorage.getItem('token');
    const headers = { ...options.headers };
    if (!(options.body instanceof FormData)) headers['Content-Type'] = 'application/json';
    if (token) headers['Authorization'] = `Bearer ${token}`;

    try {
        const response = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
        if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('token'); localStorage.removeItem('user');
            localStorage.setItem('auth_message', 'Votre session a expiré. Veuillez vous reconnecter.');
            window.location.reload();
            return Promise.reject("Session expirée");
        }
        return response.json();
    } catch (error) { console.error("API Error:", error); throw error; }
};

export const api = {
    getAvatarUrl: (path) => path ? (path.startsWith('blob:') || path.startsWith('http') ? path : `${BASE_URL}${path}`) : null,
    getToken: () => localStorage.getItem('token'),
    setToken: (token) => localStorage.setItem('token', token),
    removeToken: () => localStorage.removeItem('token'),
    getUser: () => { try { return JSON.parse(localStorage.getItem('user')); } catch(e) { return null; } },
    setUser: (user) => localStorage.setItem('user', JSON.stringify(user)),

    login: (email, password) => request('/login', { method: 'POST', body: JSON.stringify({ email, password }) }),
    register: (email, password, first_name, last_name) => request('/register', { method: 'POST', body: JSON.stringify({ email, password, first_name, last_name }) }),
    verifyEmail: (email, code) => request('/verify-email', { method: 'POST', body: JSON.stringify({ email, code }) }),
    updateUser: (data) => request('/user/update', { method: 'PUT', body: JSON.stringify(data) }),
    uploadAvatar: (formData) => request('/user/avatar', { method: 'POST', body: formData }),

    getAccounts: () => request('/accounts'),
    createAccount: (data) => request('/accounts', { method: 'POST', body: JSON.stringify(data) }),
    updateAccount: (id, data) => request('/accounts/' + id, { method: 'PUT', body: JSON.stringify(data) }),
    deleteAccount: (id) => request('/accounts/' + id, { method: 'DELETE' }),

    getTrades: (accountId) => request(accountId ? `/trades?accountId=${accountId}` : '/trades'),
    addTrade: (trade) => request('/trades', { method: 'POST', body: JSON.stringify(trade) }),
    updateTrade: (id, trade) => request(`/trades/${id}`, { method: 'PUT', body: JSON.stringify(trade) }),
    deleteTrade: (id) => request(`/trades/${id}`, { method: 'DELETE' }),

    // --- TODOLIST ---
    getTodoLists: () => request('/todo-lists'),
    createTodoList: (data) => request('/todo-lists', { method: 'POST', body: JSON.stringify(data) }),
    // NOUVELLE FONCTION POUR MODIFIER UNE LISTE
    updateTodoList: (id, data) => request(`/todo-lists/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
    deleteTodoList: (id) => request(`/todo-lists/${id}`, { method: 'DELETE' }),
    reorderTodoLists: (lists) => request('/todo-lists/reorder', { method: 'PUT', body: JSON.stringify({ lists }) }),

    addTodo: (data) => request('/todos', { method: 'POST', body: JSON.stringify(data) }),
    toggleTodo: (id, is_completed) => request(`/todos/${id}`, { method: 'PUT', body: JSON.stringify({ is_completed }) }),
    deleteTodo: (id) => request(`/todos/${id}`, { method: 'DELETE' }),

    getNotifications: () => request('/notifications'),
    markSingleNotificationRead: (id) => request(`/notifications/read/${id}`, { method: 'PUT' }),
    markNotificationsRead: () => request('/notifications/read', { method: 'PUT' }),
    getUpdates: () => request('/updates'),

    adminGetAllUsers: () => request('/admin/users'),
    adminUpdateUser: (id, data) => request(`/admin/users/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
    adminDeleteUser: (id) => request(`/admin/users/${id}`, { method: 'DELETE' }),
    adminCreateUpdate: (data) => request('/admin/updates', { method: 'POST', body: JSON.stringify(data) }),
    adminUpdateUpdate: (id, data) => request(`/admin/updates/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
    adminDeleteUpdate: (id) => request(`/admin/updates/${id}`, { method: 'DELETE' }),

    adminTestEmail: (type) => request('/admin/test-email', { method: 'POST', body: JSON.stringify({ type }) }),
};

